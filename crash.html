<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
  <title>–ö—Ä–∞—à üöÄ</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    h1 {
      text-align: center;
    }
    .balance {
      font-size: 18px;
      margin-bottom: 20px;
    }
    .crash-area {
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      max-width: 400px;
      margin: auto;
      
    }
    .crash-area label {
      font-weight: bold;
    }
    .crash-area input {
      width: 100%;
      padding: 8px;
      font-size: 16px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .buttons {
      margin: 15px 0;
      text-align: center;
    }
    .buttons button {
      padding: 10px 20px;
      font-size: 16px;
      margin: 0 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #startBtn {
      background: #007bff;
      color: #fff;
    }
    #cashoutBtn {
      background: #28a745;
      color: #fff;
    }
    #message {
      font-weight: bold;
      margin-top: 10px;
      color: #333;
      text-align: center;
    }
    .coef-display {
      font-size: 24px;
      text-align: center;
      margin-top: 10px;
    }
    .players-list {
      margin-top: 20px;
    }
    .player-row {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    .player-color {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 8px;
    }
    .history-area {
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      max-width: 600px;
      margin: 30px auto 0;
      
    }
    .history-area h2 {
      margin-bottom: 10px;
    }
    .history-list {
      list-style: none;
      padding: 0;
    }
    .history-item {
      margin-bottom: 15px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 10px;
    }
    .history-players {
      margin-top: 5px;
      padding-left: 20px;
    }
    .back-button {
      margin-top: 20px;
      text-align: center;
    }
    .back-button button {
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      background: #6c757d;
      color: #fff;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>üöÄ –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ö—Ä–∞—à</h1>

  <div class="balance">
    –ë–∞–ª–∞–Ω—Å: <span id="balance">...</span> üç¨
  </div>

  <div class="crash-area">
    <label for="bet">–°—Ç–∞–≤–∫–∞:</label>
    <input type="number" id="bet" min="1" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—Ç–∞–≤–∫—É" />
    <div class="buttons">
<button id="actionBtn" class="start" disabled>–ù–∞—á–∞—Ç—å</button>
    </div>
    <div class="coef-display">
      –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç: <span id="coefficient">1.00</span>x
    </div>
    <p id="message"></p>

    <div class="players-list">
      <h3>–£—á–∞—Å—Ç–Ω–∏–∫–∏ —Ä–∞—É–Ω–¥–∞:</h3>
      <div id="playersContainer">
        <!-- –ó–¥–µ—Å—å –ø–æ–∫–∞–∂–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ -->
      </div>
    </div>
  </div>

  <div class="history-area">
    <h2>–ò—Å—Ç–æ—Ä–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 5 —Ä–∞—É–Ω–¥–æ–≤</h2>
    <ul class="history-list" id="historyList">
      <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ -->
    </ul>
  </div>

  <div class="back-button">
    <button onclick="window.location.href='mainPage.html'">‚¨ÖÔ∏è –ù–∞–∑–∞–¥</button>
  </div>

  <script>
    const BASE_URL = 'https://fen4yaragithubio-production-9286.up.railway.app';

    // –î–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å —Å–µ—Ä–≤–µ—Ä–Ω—ã–º–∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞–º–∏:
    const BASE_SPEED = 0.1;   // —Å–∫–æ—Ä–æ—Å—Ç—å –≤ 1/sec
    const ACCEL      = 0.02;  // —É—Å–∫–æ—Ä–µ–Ω–∏–µ –≤ 1/sec¬≤

    let user = null;
    let clientTimerId = null;
    let stateIntervalId = null;

    const balanceEl = document.getElementById('balance');
    const coefficientEl = document.getElementById('coefficient');
    const messageEl = document.getElementById('message');
    const startBtn = document.getElementById('startBtn');
    const cashoutBtn = document.getElementById('cashoutBtn');
    const betInputEl = document.getElementById('bet');
    const playersContainer = document.getElementById('playersContainer');
    const historyList = document.getElementById('historyList');

    let bettingEndTime = null;
    let crashTime = null;
    let crashEnded = true;
    let hasBet = false;
    let hasCashedOut = false;

    window.addEventListener('DOMContentLoaded', async () => {
      try {
        const resp = await fetch(`${BASE_URL}/check-auth`, { credentials: 'include' });
        if (!resp.ok) throw new Error('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
        user = await resp.json();
        balanceEl.textContent = user.balance;

        // –°—Ä–∞–∑—É –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—é
        await fetchCrashState();
        await loadHistory();

        // –ö–∞–∂–¥—ã–µ 500 –º—Å –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–∞—É–Ω–¥–∞
        stateIntervalId = setInterval(fetchCrashState, 500);
      } catch (err) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ.');
        window.location.href = 'index.html';
      }
    });

    function showMessage(msg, color = '#333') {
      messageEl.textContent = msg;
      messageEl.style.color = color;
    }

    function renderPlayers(players) {
      playersContainer.innerHTML = '';
      players.forEach((p) => {
        const div = document.createElement('div');
        div.className = 'player-row';
        const colorDot = document.createElement('span');
        colorDot.className = 'player-color';
        colorDot.style.background = p.color;
        const text = document.createElement('span');
        text.textContent = `${p.username} ‚Äî ${p.bet} üç¨`;
        if (p.cashedOut) {
          text.textContent += ` ‚Üí –∑–∞–±—Ä–∞–ª(–∞) x${p.cashoutCoef.toFixed(2)} (–≤—ã–∏–≥—Ä—ã—à ${p.winnings} üç¨)`;
        }
        div.append(colorDot, text);
        playersContainer.append(div);
      });
    }

    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–∞—É–Ω–¥–∞
    async function fetchCrashState() {
      try {
        const resp = await fetch(`${BASE_URL}/crash/state`, { credentials: 'include' });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è');

        renderPlayers(data.players);
        bettingEndTime = data.bettingEndTime;
        crashTime = data.crashTime;
        crashEnded = data.ended;

        const now = Date.now();

        // 1) –†–∞—É–Ω–¥ –∑–∞–≤–µ—Ä—à—ë–Ω –∏–ª–∏ –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª—Å—è:
        if (crashEnded || !crashTime) {
          clearInterval(clientTimerId);
          clientTimerId = null;
          coefficientEl.textContent = '1.00';
          startBtn.disabled = false;
          cashoutBtn.disabled = true;
          betInputEl.disabled = false;
          hasBet = false;
          hasCashedOut = false;
          showMessage('–ñ–¥—ë–º –Ω–æ–≤–æ–≥–æ —Ä–∞—É–Ω–¥–∞', '#333');
          return;
        }

        // 2) –§–∞–∑–∞ —Å—Ç–∞–≤–æ–∫ (–µ—â—ë –¥–æ bettingEndTime):
        if (now < bettingEndTime) {
          clearInterval(clientTimerId);
          clientTimerId = null;
          coefficientEl.textContent = '1.00';
          const secsLeft = Math.ceil((bettingEndTime - now) / 1000);
          showMessage(`–§–∞–∑–∞ —Å—Ç–∞–≤–æ–∫, –µ—â—ë ${secsLeft} —Å–µ–∫`, '#333');
          startBtn.disabled = true;
          betInputEl.disabled = true;
          cashoutBtn.disabled = true;
          return;
        }

        // 3) –§–∞–∑–∞ —Ä–æ—Å—Ç–∞ (bettingEndTime ‚â§ now < crashTime):
        if (now >= bettingEndTime && now < crashTime) {
          startBtn.disabled = true;
          betInputEl.disabled = true;
          cashoutBtn.disabled = false; // –í —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç ¬´–ó–∞–±—Ä–∞—Ç—å¬ª –¥–æ—Å—Ç—É–ø–Ω–∞
          showMessage('–†–∞—É–Ω–¥ –∏–¥—ë—Ç... üöÄ', '#333');
          if (!clientTimerId) {
            clientTimerId = setInterval(drawCoefficient, 100);
          }
          return;
        }

        // 4) –ï—Å–ª–∏ now ‚â• crashTime ‚Äî –∫—Ä–∞—à
        if (now >= crashTime) {
          clearInterval(clientTimerId);
          clientTimerId = null;
          if (data.crashPoint !== null) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ—á–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∫—Ä–∞—à–∞
            coefficientEl.textContent = data.crashPoint.toFixed(2);
            showMessage('üí• –ö—Ä–∞—à! –í—ã–∏–≥—Ä–∞—Ç—å —É–∂–µ –Ω–µ–ª—å–∑—è.', 'red');
          } else {
            coefficientEl.textContent = '1.00';
            showMessage('–ñ–¥—ë–º –Ω–æ–≤–æ–≥–æ —Ä–∞—É–Ω–¥–∞', '#333');
          }
          startBtn.disabled = false;
          cashoutBtn.disabled = true;
          betInputEl.disabled = false;
          hasBet = false;
          hasCashedOut = false;
          renderPlayers(data.players);
          await updateBalanceInUI();
          await loadHistory(); // –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∫—Ä–∞—à–∞
        }
      } catch (err) {
        console.error(err);
        showMessage(err.message, 'red');
      }
    }

    // –†–∏—Å—É–µ–º —Ä–∞—Å—Ç—É—â–∏–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Å —É—Å–∫–æ—Ä–µ–Ω–∏–µ–º
    async function drawCoefficient() {
      try {
        const resp = await fetch(`${BASE_URL}/crash/state`, { credentials: 'include' });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è');

        const now = data.serverTime;

        // –ï—Å–ª–∏ —Ä–∞—É–Ω–¥ —É–∂–µ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è:
        if (data.ended) {
          clearInterval(clientTimerId);
          clientTimerId = null;
          if (data.crashPoint !== null) {
            coefficientEl.textContent = data.crashPoint.toFixed(2);
            showMessage('üí• –ö—Ä–∞—à! –í—ã–∏–≥—Ä–∞—Ç—å —É–∂–µ –Ω–µ–ª—å–∑—è.', 'red');
          } else {
            coefficientEl.textContent = '1.00';
            showMessage('–ñ–¥—ë–º –Ω–æ–≤–æ–≥–æ —Ä–∞—É–Ω–¥–∞', '#333');
          }
          startBtn.disabled = false;
          cashoutBtn.disabled = true;
          betInputEl.disabled = false;
          hasBet = false;
          hasCashedOut = false;
          renderPlayers(data.players);
          await updateBalanceInUI();
          await loadHistory();
          return;
        }

        // –ï—Å–ª–∏ –µ—â—ë —Ñ–∞–∑–∞ —Å—Ç–∞–≤–æ–∫ (–º–∞–ª–æ –≤–µ—Ä–æ—è—Ç–Ω–æ –ø–æ–ø–∞—Å—Ç—å —Å—é–¥–∞, –Ω–æ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π):
        if (now < data.bettingEndTime) {
          coefficientEl.textContent = '1.00';
          const secsLeft = Math.ceil((data.bettingEndTime - now) / 1000);
          showMessage(`–§–∞–∑–∞ —Å—Ç–∞–≤–æ–∫, –µ—â—ë ${secsLeft} —Å–µ–∫`, '#333');
          cashoutBtn.disabled = true;
          return;
        }

        // –ï—Å–ª–∏ –≤ —Ñ–∞–∑–µ —Ä–æ—Å—Ç–∞ (data.bettingEndTime ‚â§ now < data.crashTime):
        if (now >= data.bettingEndTime && now < data.crashTime) {
          const elapsedSec = (now - data.bettingEndTime) / 1000; // —Å–µ–∫—É–Ω–¥—ã –ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞ —Ä–æ—Å—Ç–∞
          // –º–æ–¥–µ–ª—å: coef = 1 + BASE_SPEED¬∑t + 0.5¬∑ACCEL¬∑t¬≤
          const coef = 1 + BASE_SPEED * elapsedSec + 0.5 * ACCEL * elapsedSec * elapsedSec;
          coefficientEl.textContent = coef.toFixed(2);
          renderPlayers(data.players);
          return;
        }

        // –ï—Å–ª–∏ —É–∂–µ ‚â• crashTime (–±—Ä–∞—É–∑–µ—Ä –º–æ–≥ –∑–∞—Ü–µ–π—Ç–Ω–æ—Ç—å), –≤—ã–≤–æ–¥–∏–º –∫—Ä–∞—à:
        if (now >= data.crashTime) {
          clearInterval(clientTimerId);
          clientTimerId = null;
          if (data.crashPoint !== null) {
            coefficientEl.textContent = data.crashPoint.toFixed(2);
            showMessage('üí• –ö—Ä–∞—à! –í—ã–∏–≥—Ä–∞—Ç—å —É–∂–µ –Ω–µ–ª—å–∑—è.', 'red');
          } else {
            coefficientEl.textContent = '1.00';
            showMessage('–ñ–¥—ë–º –Ω–æ–≤–æ–≥–æ —Ä–∞—É–Ω–¥–∞', '#333');
          }
          startBtn.disabled = false;
          cashoutBtn.disabled = true;
          betInputEl.disabled = false;
          hasBet = false;
          hasCashedOut = false;
          renderPlayers(data.players);
          await updateBalanceInUI();
          await loadHistory();
        }
      } catch (err) {
        console.error(err);
        showMessage(err.message, 'red');
      }
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å
    async function updateBalanceInUI() {
      try {
        const resp = await fetch(`${BASE_URL}/check-auth`, { credentials: 'include' });
        if (!resp.ok) throw new Error('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
        user = await resp.json();
        balanceEl.textContent = user.balance;
      } catch {
        // –Ω–∏—á–µ–≥–æ
      }
    }

    // ¬´–ù–∞—á–∞—Ç—å¬ª (join)
    startBtn.addEventListener('click', async () => {
      const betValue = parseInt(betInputEl.value);
      if (!betValue || betValue <= 0) {
        showMessage('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Ç–∞–≤–∫–∞!', 'red');
        return;
      }
      if (betValue > user.balance) {
        showMessage('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!', 'red');
        return;
      }

      try {
        const resp = await fetch(`${BASE_URL}/crash/join`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ bet: betValue })
        });
        const data = await resp.json();
        if (!resp.ok) {
          throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å—Ç–∞–≤–∫–µ');
        }

        user.balance -= betValue;
        balanceEl.textContent = user.balance;

        renderPlayers(data.players);
        bettingEndTime = data.bettingEndTime;
        crashTime = data.crashTime;
        crashEnded = data.ended;

        startBtn.disabled = true;
        betInputEl.disabled = true;
        hasBet = true;
        hasCashedOut = false;

        const now = Date.now();
        if (now < bettingEndTime) {
          coefficientEl.textContent = '1.00';
          const secsLeft = Math.ceil((bettingEndTime - now) / 1000);
          showMessage(`–§–∞–∑–∞ —Å—Ç–∞–≤–æ–∫, –µ—â—ë ${secsLeft} —Å–µ–∫`, '#333');
        } else if (now >= bettingEndTime && now < crashTime) {
          showMessage('–†–∞—É–Ω–¥ –∏–¥—ë—Ç... üöÄ', '#333');
          if (!clientTimerId) {
            clientTimerId = setInterval(drawCoefficient, 100);
          }
        }
      } catch (err) {
        showMessage(err.message, 'red');
      }
    });

    // ¬´–ó–∞–±—Ä–∞—Ç—å¬ª (cashout)
    cashoutBtn.addEventListener('click', async () => {
      if (!hasBet || hasCashedOut) return;
      hasCashedOut = true;
      cashoutBtn.disabled = true;

      const coefToTake = parseFloat(coefficientEl.textContent);

      try {
        const resp = await fetch(`${BASE_URL}/crash/cashout`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ coefficient: coefToTake })
        });
        const data = await resp.json();
        if (!resp.ok) {
          throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–ª–∞—Ç–µ');
        }

        showMessage(`‚úÖ –í—ã –∑–∞–±—Ä–∞–ª–∏ ${data.winnings} üç¨ (x${coefToTake.toFixed(2)})`, 'green');
        user.balance = data.newBalance;
        balanceEl.textContent = user.balance;

        const state = await fetch(`${BASE_URL}/crash/state`, { credentials: 'include' });
        const stData = await state.json();
        renderPlayers(stData.players);
      } catch (err) {
        showMessage(err.message, 'red');
      }
    });

    // –ò—Å—Ç–æ—Ä–∏—è –±–µ–∑ –∫–Ω–æ–ø–∫–∏ ‚Äì –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    async function loadHistory() {
      try {
        const resp = await fetch(`${BASE_URL}/crash/history`, { credentials: 'include' });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏—Å—Ç–æ—Ä–∏–∏');

        historyList.innerHTML = '';
        data.forEach((round) => {
          const li = document.createElement('li');
          li.className = 'history-item';
          const date = new Date(round.timestamp);
          const header = document.createElement('div');
          header.innerHTML = `<strong>${date.toLocaleString('ru-RU')}</strong> ‚Üí x${round.crashPoint.toFixed(2)}, –ø—É–ª ${round.totalBet}üç¨`;
          li.append(header);

          const subUl = document.createElement('ul');
          subUl.className = 'history-players';
          round.players.forEach((p) => {
            const subLi = document.createElement('li');
            let txt = `${p.username} ‚Äî —Å—Ç–∞–≤–∫–∞ ${p.bet}üç¨`;
            if (p.cashedOut) {
              txt += `, –∑–∞–±—Ä–∞–ª(–∞) –Ω–∞ x${p.cashoutCoef.toFixed(2)} ‚Üí –≤—ã–∏–≥—Ä—ã—à ${p.winnings}üç¨`;
            } else {
              txt += `, –ø—Ä–æ–∏–≥—Ä–∞–ª(–∞)`;
            }
            subLi.textContent = txt;
            subUl.append(subLi);
          });
          li.append(subUl);
          historyList.append(li);
        });
      } catch (err) {
        console.error(err);
      }
    }
  </script>
</body>
</html>
