<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
  <title>–ö—Ä–∞—à ¬∑ 320xbet</title>
</head>
<body>
  <div class="game-page">
    <header class="glass-card top-bar">
      <div>
        <p class="eyebrow">–†–µ–∂–∏–º</p>
        <h1>üöÄ –ì–ª–æ–±–∞–ª—å–Ω—ã–π –∫—Ä–∞—à</h1>
        <p class="muted">–°—Ç–∞–≤—å –∫–æ–Ω—Ñ–µ—Ç–∫–∏, —Å–ª–µ–¥–∏ –∑–∞ —Ä–æ—Å—Ç–æ–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞ –∏ –∑–∞–±–∏—Ä–∞–π –Ω–∞–≥—Ä–∞–¥—É –¥–æ –≤–∑—Ä—ã–≤–∞.</p>
      </div>
      <button class="btn-outline" onclick="window.location.href='mainPage.html'">‚¨Ö –ù–∞–∑–∞–¥</button>
    </header>

    <section class="crash-layout">
      <article class="glass-card crash-panel">
        <div class="balance-pill">
          –ë–∞–ª–∞–Ω—Å: <span id="balance">...</span> üç¨
        </div>

        <label for="bet" class="muted">–†–∞–∑–º–µ—Ä —Å—Ç–∞–≤–∫–∏</label>
        <input type="number" id="bet" min="1" class="input-field" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—Ç–∞–≤–∫—É" />
        <button id="actionBtn" class="start">–ü–æ—Å—Ç–∞–≤–∏—Ç—å</button>

        <div>
          <p class="muted">–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç</p>
          <h2><span id="coefficient">1.00</span>x</h2>
        </div>

        <p id="message" class="message"></p>

        <div>
          <p class="muted">–£—á–∞—Å—Ç–Ω–∏–∫–∏ —Ä–∞—É–Ω–¥–∞</p>
          <div id="playersContainer" class="players-list"></div>
        </div>
      </article>

      <article class="glass-card history-card">
        <p class="eyebrow">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</p>
        <div id="historyList" class="history-list"></div>
      </article>
    </section>
  </div>

<script>
  const BASE_URL = 'https://fen4yaragithubio-production-9286.up.railway.app';

  const BASE_SPEED = 0.05; // —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω —Å —Å–µ—Ä–≤–µ—Ä–æ–º
  const ACCEL = 0.08;

  let user = null;
  let clientTimerId = null;
  let stateIntervalId = null;

  const balanceEl = document.getElementById('balance');
  const coefficientEl = document.getElementById('coefficient');
  const messageEl = document.getElementById('message');
  const actionBtn = document.getElementById('actionBtn');
  const betInputEl = document.getElementById('bet');
  const playersContainer = document.getElementById('playersContainer');
  const historyList = document.getElementById('historyList');

  let bettingEndTime = null;
  let crashTime = null;
  let crashEnded = true;
  let hasBet = false;
  let hasCashedOut = false;
  let clientStartTime = null; // –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –æ—Ç—Ä–∏—Å–æ–≤–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è —Å–µ—Ä–≤–µ—ÄTime)

  window.addEventListener('DOMContentLoaded', async () => {
    try {
      const resp = await fetch(`${BASE_URL}/check-auth`, { credentials: 'include' });
      if (!resp.ok) throw new Error('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
      user = await resp.json();
      balanceEl.textContent = user.balance;

      // –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI
      actionBtn.disabled = false;
      actionBtn.textContent = '–ü–æ—Å—Ç–∞–≤–∏—Ç—å';
      actionBtn.classList.add('start');

      await fetchCrashState();
      await loadHistory();
      stateIntervalId = setInterval(fetchCrashState, 500);
    } catch (err) {
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ.');
      window.location.href = 'index.html';
    }
  });

  function showMessage(msg, color = '#333') {
    messageEl.textContent = msg;
    messageEl.style.color = color;
  }

  function renderPlayers(players) {
    playersContainer.innerHTML = '';
    (players || []).forEach((p) => {
      const div = document.createElement('div');
      div.className = 'player-row';
      const colorDot = document.createElement('span');
      colorDot.className = 'player-color';
      colorDot.style.background = p.color || '#888';
      const text = document.createElement('span');
      text.textContent = `${p.username} ‚Äî ${p.bet} üç¨`;
      if (p.cashedOut) {
        text.textContent += ` ‚Üí –∑–∞–±—Ä–∞–ª(–∞) x${(p.cashoutCoef||0).toFixed(2)} (–≤—ã–∏–≥—Ä—ã—à ${p.winnings} üç¨)`;
      }
      div.append(colorDot, text);
      playersContainer.append(div);
    });
  }

  // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  async function fetchCrashState() {
    try {
      const resp = await fetch(`${BASE_URL}/crash/state`, { credentials: 'include' });
      const data = await resp.json();
      if (!resp.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è');

      // —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –≤—Ä–µ–º—è –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
      const now = data.serverTime || Date.now();

      renderPlayers(data.players || []);
      bettingEndTime = data.bettingEndTime;
      crashTime = data.crashTime;
      crashEnded = data.ended;

      // –ï—Å–ª–∏ —Ä–∞—É–Ω–¥ –Ω–µ –∏–¥—ë—Ç (ended = true) ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–µ—Å–ª–∏ –µ—Å—Ç—å) –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞–≤–∫–∏
      if (data.ended) {
        stopDrawingCoefficient();
        if (data.crashPoint != null) {
          coefficientEl.textContent = data.crashPoint.toFixed(2);
          showMessage('üí• –ö—Ä–∞—à! –ñ–¥—ë–º –Ω–æ–≤–æ–≥–æ —Ä–∞—É–Ω–¥–∞', 'red');
        } else {
          coefficientEl.textContent = '1.00';
          showMessage('–ñ–¥—ë–º –Ω–æ–≤–æ–≥–æ —Ä–∞—É–Ω–¥–∞', '#333');
        }
        betInputEl.disabled = false;
        hasBet = false;
        hasCashedOut = false;
        actionBtn.disabled = false;
        actionBtn.textContent = '–ü–æ—Å—Ç–∞–≤–∏—Ç—å';
        actionBtn.classList.remove('cashout');
        actionBtn.classList.add('start');
        return;
      }

      // –§–∞–∑–∞ —Å—Ç–∞–≤–æ–∫ (—Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è < bettingEndTime) ‚Äî —Å—Ç–∞–≤–∫–∏ –û–¢–ö–†–´–¢–´
      if (now < bettingEndTime) {
        stopDrawingCoefficient();
        coefficientEl.textContent = '1.00';
        const secsLeft = Math.ceil((bettingEndTime - now) / 1000);
        showMessage(`–§–∞–∑–∞ —Å—Ç–∞–≤–æ–∫, –µ—â—ë ${secsLeft} —Å–µ–∫`, '#333');
        betInputEl.disabled = false;
        actionBtn.disabled = false;
        actionBtn.textContent = '–ü–æ—Å—Ç–∞–≤–∏—Ç—å';
        actionBtn.classList.remove('cashout');
        actionBtn.classList.add('start');
        return;
      }

      // –§–∞–∑–∞ —Ä–æ—Å—Ç–∞ (bettingEndTime ‚â§ now < crashTime)
      if (now >= bettingEndTime && now < crashTime) {
        betInputEl.disabled = true;
        // –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ—Å—Ç–∞–≤–∏–ª ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ó–∞–±—Ä–∞—Ç—å"
        if (hasBet && !hasCashedOut) {
          actionBtn.disabled = false;
          actionBtn.textContent = '–ó–∞–±—Ä–∞—Ç—å';
          actionBtn.classList.remove('start');
          actionBtn.classList.add('cashout');
        } else {
          actionBtn.disabled = true; // –Ω–µ–ª—å–∑—è –∑–∞–±—Ä–∞—Ç—å –µ—Å–ª–∏ –Ω–µ —Å—Ç–∞–≤–∏–ª
          actionBtn.textContent = '–ó–∞–±—Ä–∞—Ç—å';
          actionBtn.classList.remove('start');
          actionBtn.classList.add('cashout');
        }
        showMessage('–†–∞—É–Ω–¥ –∏–¥—ë—Ç... üöÄ', '#333');
        // –∑–∞–ø—É—Å—Ç–∏—Ç—å –æ—Ç—Ä–∏—Å–æ–≤–∫—É –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞
        startDrawingCoefficient();
        return;
      }

      // –ï—Å–ª–∏ now >= crashTime ‚Äî —Å—Ä–∞–∑—É –æ–±—Ä–∞–±–æ—Ç–∞–µ–º –∫—Ä–∞—à (–∏–Ω–æ–≥–¥–∞ —Å–µ—Ä–≤–µ—Ä –µ—â—ë –æ–±–Ω–æ–≤–ª—è–µ—Ç)
      if (now >= crashTime) {
        stopDrawingCoefficient();
        if (data.crashPoint != null) {
          coefficientEl.textContent = data.crashPoint.toFixed(2);
          showMessage('üí• –ö—Ä–∞—à! –í—ã–∏–≥—Ä–∞—Ç—å —É–∂–µ –Ω–µ–ª—å–∑—è.', 'red');
        } else {
          coefficientEl.textContent = '1.00';
          showMessage('–ñ–¥—ë–º –Ω–æ–≤–æ–≥–æ —Ä–∞—É–Ω–¥–∞', '#333');
        }
        betInputEl.disabled = false;
        hasBet = false;
        hasCashedOut = false;
        actionBtn.disabled = false;
        actionBtn.textContent = '–ü–æ—Å—Ç–∞–≤–∏—Ç—å';
        actionBtn.classList.remove('cashout');
        actionBtn.classList.add('start');
        await updateBalanceInUI();
        await loadHistory();
      }
    } catch (err) {
      console.error(err);
      showMessage(err.message || '–û—à–∏–±–∫–∞', 'red');
    }
  }

  function startDrawingCoefficient() {
    if (!clientTimerId) {
      clientTimerId = setInterval(drawCoefficient, 100);
    }
  }
  function stopDrawingCoefficient() {
    if (clientTimerId) {
      clearInterval(clientTimerId);
      clientTimerId = null;
    }
  }

  async function drawCoefficient() {
    try {
      const resp = await fetch(`${BASE_URL}/crash/state`, { credentials: 'include' });
      const data = await resp.json();
      if (!resp.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è');

      const now = data.serverTime || Date.now();

      if (data.ended) {
        stopDrawingCoefficient();
        if (data.crashPoint != null) {
          coefficientEl.textContent = data.crashPoint.toFixed(2);
          showMessage('üí• –ö—Ä–∞—à! –í—ã–∏–≥—Ä–∞—Ç—å —É–∂–µ –Ω–µ–ª—å–∑—è.', 'red');
        } else {
          coefficientEl.textContent = '1.00';
          showMessage('–ñ–¥—ë–º –Ω–æ–≤–æ–≥–æ —Ä–∞—É–Ω–¥–∞', '#333');
        }
        betInputEl.disabled = false;
        hasBet = false;
        hasCashedOut = false;
        actionBtn.disabled = false;
        actionBtn.textContent = '–ü–æ—Å—Ç–∞–≤–∏—Ç—å';
        actionBtn.classList.remove('cashout');
        actionBtn.classList.add('start');
        await updateBalanceInUI();
        await loadHistory();
        return;
      }

      if (now < data.bettingEndTime) {
        coefficientEl.textContent = '1.00';
        const secsLeft = Math.ceil((data.bettingEndTime - now) / 1000);
        showMessage(`–§–∞–∑–∞ —Å—Ç–∞–≤–æ–∫, –µ—â—ë ${secsLeft} —Å–µ–∫`, '#333');
        return;
      }

      if (now >= data.bettingEndTime && now < data.crashTime) {
        const elapsedSec = (now - data.bettingEndTime) / 1000;
        const coef = 1 + BASE_SPEED * elapsedSec + 0.5 * ACCEL * elapsedSec * elapsedSec;
        coefficientEl.textContent = coef.toFixed(2);
        renderPlayers(data.players || []);
        return;
      }

      if (now >= data.crashTime) {
        stopDrawingCoefficient();
        if (data.crashPoint != null) {
          coefficientEl.textContent = data.crashPoint.toFixed(2);
          showMessage('üí• –ö—Ä–∞—à! –í—ã–∏–≥—Ä–∞—Ç—å —É–∂–µ –Ω–µ–ª—å–∑—è.', 'red');
        } else {
          coefficientEl.textContent = '1.00';
          showMessage('–ñ–¥—ë–º –Ω–æ–≤–æ–≥–æ —Ä–∞—É–Ω–¥–∞', '#333');
        }
        betInputEl.disabled = false;
        hasBet = false;
        hasCashedOut = false;
        actionBtn.disabled = false;
        actionBtn.textContent = '–ü–æ—Å—Ç–∞–≤–∏—Ç—å';
        actionBtn.classList.remove('cashout');
        actionBtn.classList.add('start');
        renderPlayers(data.players || []);
        await updateBalanceInUI();
        await loadHistory();
      }
    } catch (err) {
      console.error(err);
      showMessage(err.message || '–û—à–∏–±–∫–∞', 'red');
    }
  }

  async function updateBalanceInUI() {
    try {
      const resp = await fetch(`${BASE_URL}/check-auth`, { credentials: 'include' });
      if (!resp.ok) throw new Error('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
      user = await resp.json();
      balanceEl.textContent = user.balance;
    } catch {
      // –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
    }
  }

  actionBtn.addEventListener('click', async () => {
    // –ü–æ—Å—Ç–∞–≤–∏—Ç—å
    if (!hasBet) {
      const betValue = parseInt(betInputEl.value);
      if (!betValue || betValue <= 0) {
        showMessage('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Ç–∞–≤–∫–∞!', 'red');
        return;
      }
      if (betValue > user.balance) {
        showMessage('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!', 'red');
        return;
      }

      try {
        actionBtn.disabled = true; // –ø–æ–∫–∞ –∂–¥—ë–º –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞
        const resp = await fetch(`${BASE_URL}/crash/join`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ bet: betValue })
        });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å—Ç–∞–≤–∫–µ');

        // –æ–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å (—Å–µ—Ä–≤–µ—Ä —É–∂–µ —Å–ø–∏—Å–∞–ª)
        user.balance -= betValue;
        balanceEl.textContent = user.balance;

        renderPlayers(data.players || []);
        bettingEndTime = data.bettingEndTime;
        crashTime = data.crashTime;
        crashEnded = data.ended;

        hasBet = true;
        hasCashedOut = false;
        betInputEl.disabled = true;

        // –ï—Å–ª–∏ —Ñ–∞–∑–∞ —Å—Ç–∞–≤–æ–∫ –µ—â—ë –∏–¥—ë—Ç ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–ü–æ—Å—Ç–∞–≤–∏—Ç—å" (–≤ –Ω–µ–π disabled=true —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å)
        const now = Date.now();
        if (now < bettingEndTime) {
          actionBtn.textContent = '–ü–æ—Å—Ç–∞–≤–∏—Ç—å';
          actionBtn.classList.remove('cashout');
          actionBtn.classList.add('start');
          actionBtn.disabled = true; // –Ω–µ–ª—å–∑—è —Å—Ç–∞–≤–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ
          const secsLeft = Math.ceil((bettingEndTime - now) / 1000);
          showMessage(`–§–∞–∑–∞ —Å—Ç–∞–≤–æ–∫, –µ—â—ë ${secsLeft} —Å–µ–∫`, '#333');
        } else if (now >= bettingEndTime && now < crashTime) {
          // —Å—Ä–∞–∑—É –≤ —Ñ–∞–∑—É —Ä–æ—Å—Ç–∞
          actionBtn.textContent = '–ó–∞–±—Ä–∞—Ç—å';
          actionBtn.classList.remove('start');
          actionBtn.classList.add('cashout');
          actionBtn.disabled = false;
          showMessage('–†–∞—É–Ω–¥ –∏–¥—ë—Ç... üöÄ', '#333');
          startDrawingCoefficient();
        }
      } catch (err) {
        showMessage(err.message || '–û—à–∏–±–∫–∞', 'red');
        actionBtn.disabled = false;
      }
      return;
    }

    // –ó–∞–±—Ä–∞—Ç—å
    if (hasBet && !hasCashedOut) {
      hasCashedOut = true;
      actionBtn.disabled = true;
      const coefToTake = parseFloat(coefficientEl.textContent) || 1.0;
      try {
        const resp = await fetch(`${BASE_URL}/crash/cashout`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ coefficient: coefToTake })
        });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–ª–∞—Ç–µ');

        showMessage(`‚úÖ –í—ã –∑–∞–±—Ä–∞–ª–∏ ${data.winnings} üç¨ (x${coefToTake.toFixed(2)})`, 'green');
        user.balance = data.newBalance;
        balanceEl.textContent = user.balance;

        // –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –∏–≥—Ä–æ–∫–æ–≤
        const state = await fetch(`${BASE_URL}/crash/state`, { credentials: 'include' });
        const stData = await state.json();
        renderPlayers(stData.players || []);
      } catch (err) {
        showMessage(err.message || '–û—à–∏–±–∫–∞', 'red');
        actionBtn.disabled = false;
      }
    }
  });

  async function loadHistory() {
    try {
      const resp = await fetch(`${BASE_URL}/crash/history`, { credentials: 'include' });
      const data = await resp.json();
      if (!resp.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏—Å—Ç–æ—Ä–∏–∏');

      historyList.innerHTML = '';
      data.forEach((round) => {
        const li = document.createElement('li');
        li.className = 'history-item';
        const date = new Date(round.timestamp);
        const header = document.createElement('div');
        header.innerHTML = `<strong>${date.toLocaleString('ru-RU')}</strong> ‚Üí x${round.crashPoint.toFixed(2)}, –ø—É–ª ${round.totalBet}üç¨`;
        li.append(header);

        const subUl = document.createElement('ul');
        subUl.className = 'history-players';
        round.players.forEach((p) => {
          const subLi = document.createElement('li');
          let txt = `${p.username} ‚Äî —Å—Ç–∞–≤–∫–∞ ${p.bet}üç¨`;
          if (p.cashedOut) {
            txt += `, –∑–∞–±—Ä–∞–ª(–∞) –Ω–∞ x${p.cashoutCoef.toFixed(2)} ‚Üí –≤—ã–∏–≥—Ä—ã—à ${p.winnings}üç¨`;
          } else {
            txt += `, –ø—Ä–æ–∏–≥—Ä–∞–ª(–∞)`;
          }
          subLi.textContent = txt;
          subUl.append(subLi);
        });
        li.append(subUl);
        historyList.append(li);
      });
    } catch (err) {
      console.error(err);
    }
  }
</script>
</body>
</html>
