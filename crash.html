<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ö—Ä–∞—à üöÄ</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    #message {
      font-weight: bold;
      margin-top: 10px;
      color: #333;
    }
  </style>
</head>
<body>
  <main>
    <h1>üöÄ –ö—Ä–∞—à</h1>
    <p>–ë–∞–ª–∞–Ω—Å: <span id="balance">...</span> üç¨</p>

    <div class="crash-area">
      <label for="bet">–°—Ç–∞–≤–∫–∞:</label>
      <input type="number" id="bet" min="1" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—Ç–∞–≤–∫—É" />
      <br><br>
      <p>–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç: <span id="coefficient">1.00</span>x</p>
      <button id="startBtn">–ù–∞—á–∞—Ç—å</button>
      <button id="cashoutBtn" disabled>–ó–∞–±—Ä–∞—Ç—å</button>
      <p id="message"></p>
    </div>

    <button onclick="window.location.href='mainPage.html'">‚¨ÖÔ∏è –ù–∞–∑–∞–¥</button>
  </main>

  <script>
    let user = null;
    let coefficient = 1.0;
    let crashPoint = 0;
    let betAmount = 0;
    let intervalId = null;
    let hasCashedOut = false;

    const balanceEl = document.getElementById('balance');
    const coefficientEl = document.getElementById('coefficient');
    const messageEl = document.getElementById('message');
    const startBtn = document.getElementById('startBtn');
    const cashoutBtn = document.getElementById('cashoutBtn');
    const betInputEl = document.getElementById('bet');

    // 1) –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ: –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Å—Å–∏—é –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –±–∞–ª–∞–Ω—Å
    window.addEventListener('DOMContentLoaded', async () => {
      try {
        const resp = await fetch('/check-auth', { credentials: 'include' });
        if (!resp.ok) throw new Error('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
        user = await resp.json();
        balanceEl.textContent = user.balance;
      } catch (err) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ.');
        window.location.href = 'index.html';
      }
    });

    function showMessage(msg, color = '#333') {
      messageEl.textContent = msg;
      messageEl.style.color = color;
    }

    function resetGameUI() {
      coefficient = 1.0;
      coefficientEl.textContent = coefficient.toFixed(2);
      startBtn.disabled = false;
      cashoutBtn.disabled = true;
      betInputEl.disabled = false;
      hasCashedOut = false;
    }

    // 2) –ù–∞–∂–∞–ª–∏ ¬´–ù–∞—á–∞—Ç—å¬ª
    startBtn.addEventListener('click', async () => {
      const betValue = parseInt(betInputEl.value);
      if (!betValue || betValue <= 0) {
        showMessage('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Ç–∞–≤–∫–∞!', 'red');
        return;
      }
      if (betValue > user.balance) {
        showMessage('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!', 'red');
        return;
      }

      try {
        const resp = await fetch('/crash/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ bet: betValue })
        });
        const data = await resp.json();
        if (!resp.ok) {
          throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∏–≥—Ä—ã');
        }

        // –£—Å–ø–µ—à–Ω–æ: —Å–µ—Ä–≤–µ—Ä —Å–Ω–∏–∑–∏–ª –±–∞–ª–∞–Ω—Å, –≤–µ—Ä–Ω—É–ª crashPoint
        crashPoint = data.crashPoint;
        betAmount = betValue;
        user.balance -= betAmount;
        balanceEl.textContent = user.balance;

        startBtn.disabled = true;
        cashoutBtn.disabled = false;
        betInputEl.disabled = true;
        showMessage('–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å! üöÄ', '#333');

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞
        coefficient = 1.0;
        coefficientEl.textContent = coefficient.toFixed(2);
        let speed = 0.001;

        intervalId = setInterval(() => {
          if (hasCashedOut) return;
          speed += 0.0001;
          coefficient += speed;
          coefficientEl.textContent = coefficient.toFixed(2);

          // –ï—Å–ª–∏ –¥–æ—à–ª–∏ –¥–æ crashPoint –∏–ª–∏ –ø—Ä–µ–≤—ã—Å–∏–ª–∏
          if (coefficient >= crashPoint) {
            clearInterval(intervalId);
            coefficient = crashPoint;
            coefficientEl.textContent = coefficient.toFixed(2);
            showMessage('üí• –ö—Ä–∞—à! –í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏.', 'red');
            resetGameUI();
          }
        }, 50);

      } catch (err) {
        showMessage(err.message, 'red');
      }
    });

    // 3) –ù–∞–∂–∞–ª–∏ ¬´–ó–∞–±—Ä–∞—Ç—å¬ª
    cashoutBtn.addEventListener('click', async () => {
      if (hasCashedOut) return;
      hasCashedOut = true;
      clearInterval(intervalId);

      const currentCoef = parseFloat(coefficientEl.textContent);
      // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ ¬´–ø—Ä–æ–±–∏–ª¬ª –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ä–∞—Å—á—ë—Ç–∞ (–ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –¥–≤—É–º –∑–Ω–∞–∫–∞–º)
      if (currentCoef >= crashPoint) {
        // –£–∂–µ –∫—Ä–∞—à–Ω—É–ª—Å—è, –ø—Ä–æ—Å—Ç–æ —Å–±—Ä–æ—Å–∏–º UI
        showMessage('üí• –ö—Ä–∞—à! –í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏.', 'red');
        resetGameUI();
        return;
      }

      // –ü—ã—Ç–∞–µ–º—Å—è ¬´–∑–∞–±—Ä–∞—Ç—å¬ª 
      try {
        const resp = await fetch('/crash/cashout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ coefficient: currentCoef })
        });
        const data = await resp.json();
        if (!resp.ok) {
          throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–ª–∞—Ç–µ');
        }
        // –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª { winnings, newBalance }
        user.balance = data.newBalance;
        balanceEl.textContent = user.balance;
        showMessage(`‚úÖ –í—ã –∑–∞–±—Ä–∞–ª–∏ ${data.winnings} üç¨ (x${currentCoef.toFixed(2)})`, 'green');
        resetGameUI();
      } catch (err) {
        showMessage(err.message, 'red');
        resetGameUI();
      }
    });
  </script>
</body>
</html>
