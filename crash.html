<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ê–¥–º–∏–Ω ¬∑ 320xbet</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="admin-shell">
    <header class="glass-card top-bar">
      <div>
        <p class="eyebrow">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</p>
        <h1>–ê–¥–º–∏–Ω –º–µ–Ω—é</h1>
        <p class="muted">–í–æ–π–¥–∏—Ç–µ —Å –æ–±—â–∏–º –ø–∞—Ä–æ–ª–µ–º 123456/123456, —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ –º–µ–Ω—è—Ç—å –±–∞–ª–∞–Ω—Å.</p>
      </div>
      <div class="link-row">
        <a href="index.html" class="muted">‚Üê –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ —Å–∞–π—Ç</a>
      </div>
    </header>

    <section class="glass-card auth-card" id="adminLoginSection">
      <div>
        <p class="eyebrow">–í—Ö–æ–¥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</p>
        <p class="muted">–î–∞–Ω–Ω—ã–µ –ª–æ–≥–∏–Ω–∞ –Ω–µ —Å–≤—è–∑–∞–Ω—ã —Å –æ–±—ã—á–Ω—ã–º–∏ –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏.</p>
      </div>
      <form id="adminLoginForm" class="form-grid">
        <input type="text" id="adminLogin" class="input-field" placeholder="–õ–æ–≥–∏–Ω (123456)" required />
        <input type="password" id="adminPassword" class="input-field" placeholder="–ü–∞—Ä–æ–ª—å (123456)" required />
        <button type="submit" class="btn-primary">–í–æ–π—Ç–∏ –≤ –ø–∞–Ω–µ–ª—å</button>
      </form>
      <p id="adminLoginMessage" class="message"></p>
    </section>

    <section class="glass-card" id="adminPanelSection" style="display:none">
      <div class="top-bar" style="gap:12px">
        <div>
          <p class="eyebrow">–°–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤</p>
          <p class="muted">–ò–∑–º–µ–Ω—è–π—Ç–µ –±–∞–ª–∞–Ω—Å –≤ –ø–∞—Ä—É –∫–ª–∏–∫–æ–≤. –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–∏—à—É—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –≤ users.json.</p>
        </div>
        <div class="admin-actions">
          <button id="refreshBtn" class="btn-secondary" style="width:auto">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
          <button id="adminLogoutBtn" class="btn-outline" style="width:auto">–í—ã–π—Ç–∏</button>
        </div>
      </div>

      <div class="notice">
        –í–Ω–∏–º–∞–Ω–∏–µ: –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –≤—Å—Ç—É–ø–∞—é—Ç –≤ —Å–∏–ª—É –º–≥–Ω–æ–≤–µ–Ω–Ω–æ. –í–≤–æ–¥–∏—Ç–µ —Ç–æ–ª—å–∫–æ —Ü–µ–ª—ã–µ –Ω–µ–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è.
      </div>

      <div class="table-wrapper" style="overflow-x:auto">
        <table class="admin-table">
          <thead>
            <tr>
              <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
              <th>–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å</th>
              <th>–ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å</th>
              <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
            </tr>
          </thead>
          <tbody id="usersTable"></tbody>
        </table>
      </div>
      <p id="adminPanelMessage" class="message"></p>
    </section>
  </div>

  <script>
    const BASE_URL = 'https://fen4yaragithubio-production-9286.up.railway.app';
    const adminLoginSection = document.getElementById('adminLoginSection');
    const adminPanelSection = document.getElementById('adminPanelSection');
    const adminLoginForm = document.getElementById('adminLoginForm');
    const adminLoginMessage = document.getElementById('adminLoginMessage');
    const adminPanelMessage = document.getElementById('adminPanelMessage');
    const usersTable = document.getElementById('usersTable');
    const refreshBtn = document.getElementById('refreshBtn');
    const logoutBtn = document.getElementById('adminLogoutBtn');

    async function fetchUsers() {
      const resp = await fetch(`${BASE_URL}/admin/users`, { credentials: 'include' });
      if (!resp.ok) {
        throw new Error('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞');
      }
      return resp.json();
    }

    function renderUsers(users) {
      usersTable.innerHTML = '';
      users.forEach(({ username, balance }) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${username}</td>
          <td>${balance} üç¨</td>
          <td><input type="number" min="0" class="input-field" value="${balance}" data-username="${username}" /></td>
          <td><button class="btn-primary" data-username="${username}">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></td>
        `;
        usersTable.appendChild(tr);
      });
    }

    function togglePanels(isAdmin) {
      adminLoginSection.style.display = isAdmin ? 'none' : '';
      adminPanelSection.style.display = isAdmin ? '' : 'none';
    }

    async function init() {
      try {
        const users = await fetchUsers();
        renderUsers(users);
        togglePanels(true);
      } catch (err) {
        console.warn('Admin auth check failed:', err.message);
        togglePanels(false);
      }
    }

    adminLoginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      adminLoginMessage.textContent = '';
      const login = document.getElementById('adminLogin').value.trim();
      const password = document.getElementById('adminPassword').value.trim();
      try {
        const resp = await fetch(`${BASE_URL}/admin/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ login, password })
        });
        const data = await resp.json();
        if (!resp.ok) {
          throw new Error(data.error || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞');
        }
        adminLoginMessage.textContent = data.message;
        adminLoginMessage.className = 'message success';
        const users = await fetchUsers();
        renderUsers(users);
        togglePanels(true);
      } catch (err) {
        adminLoginMessage.textContent = err.message;
        adminLoginMessage.className = 'message error';
      }
    });

    refreshBtn.addEventListener('click', async () => {
      adminPanelMessage.textContent = '';
      try {
        const users = await fetchUsers();
        renderUsers(users);
        adminPanelMessage.textContent = '–°–ø–∏—Å–æ–∫ –æ–±–Ω–æ–≤–ª—ë–Ω.';
        adminPanelMessage.className = 'message success';
      } catch (err) {
        adminPanelMessage.textContent = err.message;
        adminPanelMessage.className = 'message error';
      }
    });

    usersTable.addEventListener('click', async (e) => {
      if (e.target.tagName !== 'BUTTON') return;
      const username = e.target.getAttribute('data-username');
      const input = usersTable.querySelector(`input[data-username="${username}"]`);
      const balanceValue = Number(input.value);
      if (!Number.isFinite(balanceValue) || balanceValue < 0) {
        adminPanelMessage.textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –±–∞–ª–∞–Ω—Å.';
        adminPanelMessage.className = 'message error';
        return;
      }
      try {
        const resp = await fetch(`${BASE_URL}/admin/users/${encodeURIComponent(username)}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ balance: balanceValue })
        });
        const data = await resp.json();
        if (!resp.ok) {
          throw new Error(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å');
        }
        adminPanelMessage.textContent = `–ë–∞–ª–∞–Ω—Å ${data.username} –æ–±–Ω–æ–≤–ª—ë–Ω: ${data.balance} üç¨`;
        adminPanelMessage.className = 'message success';
        input.value = data.balance;
        input.parentElement.previousElementSibling.textContent = `${data.balance} üç¨`;
      } catch (err) {
        adminPanelMessage.textContent = err.message;
        adminPanelMessage.className = 'message error';
      }
    });

    logoutBtn.addEventListener('click', async () => {
      await fetch(`${BASE_URL}/admin/logout`, {
        method: 'POST',
        credentials: 'include'
      });
      togglePanels(false);
      adminPanelMessage.textContent = '';
      adminLoginMessage.textContent = '–í—ã –≤—ã—à–ª–∏ –∏–∑ –ø–∞–Ω–µ–ª–∏.';
      adminLoginMessage.className = 'message';
    });

    init();
  </script>
</body>
</html>

