<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ö—Ä–∞—à üöÄ</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      text-align: center;
    }
    .balance {
      font-size: 18px;
      margin-bottom: 20px;
    }
    .crash-area {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      max-width: 400px;
      margin: auto;
    }
    .crash-area label {
      font-weight: bold;
    }
    .crash-area input {
      width: 100%;
      padding: 8px;
      font-size: 16px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .buttons {
      margin: 15px 0;
      text-align: center;
    }
    .buttons button {
      padding: 10px 20px;
      font-size: 16px;
      margin: 0 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #startBtn {
      background: #007bff;
      color: #fff;
    }
    #cashoutBtn {
      background: #28a745;
      color: #fff;
    }
    #message {
      font-weight: bold;
      margin-top: 10px;
      color: #333;
      text-align: center;
    }
    .coef-display {
      font-size: 24px;
      text-align: center;
      margin-top: 10px;
    }
    .players-list {
      margin-top: 20px;
    }
    .player-row {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    .player-color {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 8px;
    }
    .history-area {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      max-width: 600px;
      margin: 30px auto 0;
    }
    .history-area h2 {
      margin-bottom: 10px;
    }
    .history-list {
      list-style: none;
      padding: 0;
    }
    .history-item {
      margin-bottom: 15px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 10px;
    }
    .history-players {
      margin-top: 5px;
      padding-left: 20px;
    }
    .back-button {
      margin-top: 20px;
      text-align: center;
    }
    .back-button button {
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      background: #6c757d;
      color: #fff;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>üöÄ –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ö—Ä–∞—à</h1>
  <div class="balance">
    –ë–∞–ª–∞–Ω—Å: <span id="balance">...</span> üç¨
  </div>

  <div class="crash-area">
    <label for="bet">–°—Ç–∞–≤–∫–∞:</label>
    <input type="number" id="bet" min="1" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—Ç–∞–≤–∫—É" />
    <div class="buttons">
      <button id="startBtn">–ù–∞—á–∞—Ç—å</button>
      <button id="cashoutBtn" disabled>–ó–∞–±—Ä–∞—Ç—å</button>
    </div>
    <div class="coef-display">
      –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç: <span id="coefficient">1.00</span>x
    </div>
    <p id="message"></p>

    <div class="players-list">
      <h3>–£—á–∞—Å—Ç–Ω–∏–∫–∏ —Ä–∞—É–Ω–¥–∞:</h3>
      <div id="playersContainer">
        <!-- –ó–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è —É—á–∞—Å—Ç–Ω–∏–∫–∏: —Ü–≤–µ—Ç ‚Ä¢ —é–∑–µ—Ä ‚Ä¢ —Å—Ç–∞–≤–∫–∞ ‚Ä¢ cashedOut? -->
      </div>
    </div>
  </div>

  <div class="history-area">
    <h2>–ò—Å—Ç–æ—Ä–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 5 —Ä–∞—É–Ω–¥–æ–≤</h2>
    <button id="refreshHistory">–û–±–Ω–æ–≤–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
    <ul class="history-list" id="historyList">
      <!-- –ó–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è 5 —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏—Å—Ç–æ—Ä–∏–∏ -->
    </ul>
  </div>

  <div class="back-button">
    <button onclick="window.location.href='mainPage.html'">‚¨ÖÔ∏è –ù–∞–∑–∞–¥</button>
  </div>

  <script>
    const BASE_URL = 'https://fen4yaragithubio-production-9286.up.railway.app';

    let user = null;
    let intervalId = null;

    const balanceEl = document.getElementById('balance');
    const coefficientEl = document.getElementById('coefficient');
    const messageEl = document.getElementById('message');
    const startBtn = document.getElementById('startBtn');
    const cashoutBtn = document.getElementById('cashoutBtn');
    const betInputEl = document.getElementById('bet');
    const playersContainer = document.getElementById('playersContainer');
    const historyList = document.getElementById('historyList');
    const refreshHistoryBtn = document.getElementById('refreshHistory');

    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è ¬´–∫—Ä–∞—à–∞¬ª
    let crashStartTime = null;
    let crashEnded = true;
    let clientTimerId = null;
    let localCoefficient = 1.0;
    let hasBet = false;       // —Å–¥–µ–ª–∞–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—Ç–∞–≤–∫—É –≤ —ç—Ç–æ–º —Ä–∞—É–Ω–¥–µ
    let hasCashedOut = false; // —É—Å–ø–µ–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±—Ä–∞—Ç—å

    // 1) –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ: –ø—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –∏ –±–∞–ª–∞–Ω—Å
    window.addEventListener('DOMContentLoaded', async () => {
      try {
        const resp = await fetch(`${BASE_URL}/check-auth`, { credentials: 'include' });
        if (!resp.ok) throw new Error('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
        user = await resp.json();
        balanceEl.textContent = user.balance;

        // –°—Ä–∞–∑—É –∑–∞–≥—Ä—É–∑–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–∞—É–Ω–¥–∞
        await fetchCrashState();

        // –ò –∑–∞–≥—Ä—É–∑–∏–º –∏—Å—Ç–æ—Ä–∏—é
        loadHistory();
      } catch (err) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ.');
        window.location.href = 'index.html';
      }
    });

    function showMessage(msg, color = '#333') {
      messageEl.textContent = msg;
      messageEl.style.color = color;
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º UI-—Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
    function renderPlayers(players) {
      playersContainer.innerHTML = '';
      players.forEach((p) => {
        const div = document.createElement('div');
        div.className = 'player-row';
        const colorDot = document.createElement('span');
        colorDot.className = 'player-color';
        colorDot.style.background = p.color;
        const text = document.createElement('span');
        text.textContent = ` ${p.username} ‚Äî ${p.bet} üç¨`;
        if (p.cashedOut) {
          text.textContent += ` ‚Üí –∑–∞–±—Ä–∞–ª(–∞) x${p.cashoutCoef.toFixed(2)} (–≤—ã–∏–≥—Ä—ã—à ${p.winnings} üç¨)`;
        }
        div.append(colorDot, text);
        playersContainer.append(div);
      });
    }

    // –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–∞—É–Ω–¥–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞
    async function fetchCrashState() {
      try {
        const resp = await fetch(`${BASE_URL}/crash/state`, { credentials: 'include' });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è');

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        renderPlayers(data.players);

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–ª–∞–≥–∏
        crashStartTime = data.startTime;
        crashEnded = data.ended;

        // –ï—Å–ª–∏ —Ä–∞—É–Ω–¥ –Ω–µ –Ω–∞—á–∞—Ç (ended = true), —Å–±—Ä–∞—Å—ã–≤–∞–µ–º UI
        if (crashEnded || !crashStartTime) {
          clearInterval(clientTimerId);
          coefficientEl.textContent = '1.00';
          localCoefficient = 1.0;
          startBtn.disabled = false;
          cashoutBtn.disabled = true;
          betInputEl.disabled = false;
          hasBet = false;
          hasCashedOut = false;
          showMessage('–ñ–¥—ë–º –Ω–æ–≤–æ–≥–æ —Ä–∞—É–Ω–¥–∞', '#333');
          return;
        }

        // –ï—Å–ª–∏ —Ä–∞—É–Ω–¥ –∑–∞–ø—É—â–µ–Ω, –±–ª–æ–∫–∏—Ä—É–µ–º UI-—ç–ª–µ–º–µ–Ω—Ç—ã ¬´–ù–∞—á–∞—Ç—å¬ª
        startBtn.disabled = true;
        betInputEl.disabled = true;
        showMessage('–†–∞—É–Ω–¥ –∏–¥—ë—Ç... üöÄ', '#333');

        // –ó–∞–ø—É—Å—Ç–∏–º clientTimerId (–µ—Å–ª–∏ –µ—â—ë –Ω–µ –∑–∞–ø—É—â–µ–Ω) –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞
        if (!clientTimerId) {
          clientTimerId = setInterval(() => {
            drawCoefficient();
          }, 100);
        }
      } catch (err) {
        console.error(err);
        showMessage(err.message, 'red');
      }
    }

    // –§—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è —Ä–∏—Å—É–µ—Ç —Ç–µ–∫—É—â–∏–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç, –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ serverTime –∏ crashStartTime
    async function drawCoefficient() {
      try {
        const resp = await fetch(`${BASE_URL}/crash/state`, { credentials: 'include' });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è');

        // –ï—Å–ª–∏ —Ä–∞—É–Ω–¥ —É–∂–µ –∑–∞–∫–æ–Ω—á–∏–ª—Å—è, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
        if (data.ended) {
          clearInterval(clientTimerId);
          clientTimerId = null;
          // –ü–æ–∫–∞–∂–µ–º —Ç–æ—á–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∫—Ä–∞—à–∞:
          coefficientEl.textContent = data.crashPoint.toFixed(2);
          showMessage('üí• –ö—Ä–∞—à! –í—ã–∏–≥—Ä–∞—Ç—å —É–∂–µ –Ω–µ–ª—å–∑—è.', 'red');
          // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—Ç–∞–≤–∏–ª, –Ω—É–∂–Ω–æ –µ–º—É —Å–±—Ä–æ—Å–∏—Ç—å UI-–∫–Ω–æ–ø–∫–∏
          startBtn.disabled = false;
          cashoutBtn.disabled = true;
          betInputEl.disabled = false;
          hasBet = false;
          hasCashedOut = false;
          // –û–±–Ω–æ–≤–∏–º –±–∞–ª–∞–Ω—Å (—á—Ç–æ–±—ã, –µ—Å–ª–∏ –∫—Ç–æ-—Ç–æ –ø–æ–±–µ–¥–∏–ª, —É –≤—Å–µ—Ö –æ—Ç–æ–±—Ä–∞–∂–∞–ª–æ—Å—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ):
          await updateBalanceInUI();
          // –ü–µ—Ä–µ—Ä–∏—Å—É–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (—á—Ç–æ–±—ã —Å—Ä–∞–∑—É —É–≤–∏–¥–µ—Ç—å, –∫—Ç–æ –∫—É–¥–∞ —É—Å–ø–µ–ª –∑–∞–±—Ä–∞—Ç—å –∏ –∫—Ç–æ –ø—Ä–æ–∏–≥—Ä–∞–ª)
          renderPlayers(data.players);
          return;
        }

        // –ï—â—ë –∏–¥—ë—Ç —Ä–∞—É–Ω–¥ ‚Üí —Å—á–∏—Ç–∞–µ–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç
        const now = data.serverTime;
        const elapsed = (now - data.startTime) / 1000; // –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
        // –õ–∏–Ω–µ–π–Ω—ã–π —Ä–æ—Å—Ç: coef = 1 + elapsed * CRASH_GROWTH_SPEED
        const coef = 1 + elapsed * 0.2;
        localCoefficient = coef;
        coefficientEl.textContent = coef.toFixed(2);

        // –ü–æ–∫–∞–∂–µ–º —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (—á—Ç–æ–±—ã –≤–∏–¥–µ–ª–∏, –µ—Å–ª–∏ –∫—Ç–æ-—Ç–æ –∑–∞—à—ë–ª –∏–ª–∏ –∑–∞–±—Ä–∞–ª—Å—è):
        renderPlayers(data.players);

      } catch (err) {
        console.error(err);
        showMessage(err.message, 'red');
      }
    }

    // –û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å –≤ UI
    async function updateBalanceInUI() {
      try {
        const resp = await fetch(`${BASE_URL}/check-auth`, { credentials: 'include' });
        if (!resp.ok) throw new Error('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
        user = await resp.json();
        balanceEl.textContent = user.balance;
      } catch {
        // –Ω–∏–∫—Ç–æ –Ω–µ –º–µ—à–∞–µ—Ç
      }
    }

    // –ù–∞–∂–∞–ª–∏ ¬´–ù–∞—á–∞—Ç—å¬ª (–¥–µ–ª–∞–µ–º join)
    startBtn.addEventListener('click', async () => {
      const betValue = parseInt(betInputEl.value);
      if (!betValue || betValue <= 0) {
        showMessage('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Ç–∞–≤–∫–∞!', 'red');
        return;
      }
      if (betValue > user.balance) {
        showMessage('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!', 'red');
        return;
      }

      try {
        const resp = await fetch(`${BASE_URL}/crash/join`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ bet: betValue })
        });
        const data = await resp.json();
        if (!resp.ok) {
          throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å—Ç–∞–≤–∫–µ');
        }

        // –°—Ç–∞–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞: —Å–µ—Ä–≤–µ—Ä —É–∂–µ —Å–Ω—è–ª —Å—É–º–º—É, –æ–±–Ω–æ–≤–∏–º –±–∞–ª–∞–Ω—Å
        user.balance -= betValue;
        balanceEl.textContent = user.balance;

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
        renderPlayers(data.players);
        crashStartTime = data.startTime;
        crashEnded = data.ended;

        startBtn.disabled = true;
        cashoutBtn.disabled = false;
        betInputEl.disabled = true;
        hasBet = true;
        hasCashedOut = false;
        showMessage('–ü–æ–¥–æ–∂–¥–∏—Ç–µ, —Ä–∞—É–Ω–¥ –Ω–∞—á–∞–ª—Å—è! üöÄ', '#333');

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Ç–∞–π–º–µ—Ä, –µ—Å–ª–∏ –æ–Ω –µ—â—ë –Ω–µ –∑–∞–ø—É—â–µ–Ω
        if (!clientTimerId) {
          clientTimerId = setInterval(() => {
            drawCoefficient();
          }, 100);
        }

      } catch (err) {
        showMessage(err.message, 'red');
      }
    });

    // –ù–∞–∂–∞–ª–∏ ¬´–ó–∞–±—Ä–∞—Ç—å¬ª
    cashoutBtn.addEventListener('click', async () => {
      if (!hasBet || hasCashedOut) return;

      hasCashedOut = true;
      cashoutBtn.disabled = true;

      // –ë–µ—Ä—ë–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞ (–Ω–µ –±–æ–ª—å—à–µ real crashPoint, —Ç.–∫. drawCoefficient –ø—Ä–æ–≤–µ—Ä—è–µ—Ç)
      const coefToTake = parseFloat(coefficientEl.textContent);

      try {
        const resp = await fetch(`${BASE_URL}/crash/cashout`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ coefficient: coefToTake })
        });
        const data = await resp.json();
        if (!resp.ok) {
          throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–ª–∞—Ç–µ');
        }

        // –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª { winnings, newBalance }
        showMessage(`‚úÖ –í—ã –∑–∞–±—Ä–∞–ª–∏ ${data.winnings} üç¨ (x${coefToTake.toFixed(2)})`, 'green');
        user.balance = data.newBalance;
        balanceEl.textContent = user.balance;

        // –û–±–Ω–æ–≤–ª—è–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (—á—Ç–æ–±—ã —Å—Ä–∞–∑—É —É–≤–∏–¥–µ—Ç—å, —á—Ç–æ –º—ã –ø–æ–º–µ—á–µ–Ω—ã –∫–∞–∫ cashedOut):
        const state = await fetch(`${BASE_URL}/crash/state`, { credentials: 'include' });
        const stData = await state.json();
        renderPlayers(stData.players);

      } catch (err) {
        showMessage(err.message, 'red');
      }
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é (GET /crash/history)
    async function loadHistory() {
      try {
        const resp = await fetch(`${BASE_URL}/crash/history`, { credentials: 'include' });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏—Å—Ç–æ—Ä–∏–∏');

        // data = –º–∞—Å—Å–∏–≤ –∏–∑ { timestamp, crashPoint, totalBet, players: [...] }
        historyList.innerHTML = '';
        data.forEach((round) => {
          const li = document.createElement('li');
          li.className = 'history-item';
          const date = new Date(round.timestamp);
          const header = document.createElement('div');
          header.innerHTML = `<strong>${date.toLocaleString('ru-RU')}</strong>: –†–∞—Å—á—ë—Ç —Ö2: <em>${round.crashPoint.toFixed(2)}</em>, –æ–±—â–∏–π –ø—É–ª: ${round.totalBet} üç¨`;
          li.append(header);

          // –°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:
          const subUl = document.createElement('ul');
          subUl.className = 'history-players';
          round.players.forEach((p) => {
            const subLi = document.createElement('li');
            let txt = `${p.username} ‚Äî —Å—Ç–∞–≤–∫–∞ ${p.bet} üç¨`;
            if (p.cashedOut) {
              txt += `, –∑–∞–±—Ä–∞–ª(–∞) –Ω–∞ x${p.cashoutCoef.toFixed(2)} ‚Üí –≤—ã–∏–≥—Ä—ã—à ${p.winnings} üç¨`;
            } else {
              txt += `, –ø—Ä–æ–∏–≥—Ä–∞–ª(–∞)`;
            }
            subLi.textContent = txt;
            subUl.append(subLi);
          });
          li.append(subUl);
          historyList.append(li);
        });
      } catch (err) {
        console.error(err);
      }
    }

    refreshHistoryBtn.addEventListener('click', loadHistory);
  </script>
</body>
</html>
