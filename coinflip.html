<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ö–æ–∏–Ω—Ñ–ª–∏–ø ¬∑ 320xbet</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="game-page">
    <header class="glass-card top-bar">
      <div>
        <p class="eyebrow">–†–µ–∂–∏–º</p>
        <h1>üí∞ –ö–æ–∏–Ω—Ñ–ª–∏–ø</h1>
        <p class="muted">–í—ã–±–µ—Ä–∏ —Å—Ç–æ—Ä–æ–Ω—É, –∑–∞–¥–∞–π —Å—Ç–∞–≤–∫—É –∏ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ —É–∑–Ω–∞–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±—Ä–æ—Å–∫–∞.</p>
      </div>
      <button class="btn-outline" onclick="window.location.href='mainPage.html'">‚¨Ö –ù–∞–∑–∞–¥</button>
    </header>

    <section class="glass-card">
      <div class="balance-pill">
        –ë–∞–ª–∞–Ω—Å: <span id="balance">...</span> üç¨
      </div>

      <div>
        <p class="muted">–°—Ç–æ—Ä–æ–Ω–∞ –º–æ–Ω–µ—Ç—ã</p>
        <div class="option-toggle" id="coinSideToggle">
          <button class="btn-secondary option-btn active" data-side="heads">–û—Ä—ë–ª</button>
          <button class="btn-secondary option-btn" data-side="tails">–†–µ—à–∫–∞</button>
        </div>
      </div>

      <label for="betAmount" class="muted">–°—Ç–∞–≤–∫–∞</label>
      <input type="number" id="betAmount" min="1" class="input-field" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É" />

      <button id="flipBtn" class="btn-primary" style="margin-top: 12px;">–ë—Ä–æ—Å–∏—Ç—å –º–æ–Ω–µ—Ç—É</button>
      <p id="statusMessage" class="message"></p>
    </section>

    <section class="glass-card history-card">
      <p class="eyebrow">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –±—Ä–æ—Å–∫–∏</p>
      <div id="coinflipHistoryList" class="history-list"></div>
    </section>
  </div>

  <script src="script/utils.js"></script>
  <script>
    const BASE_URL = 'https://fen4yaragithubio-production.up.railway.app';
    let user = null;
    let selectedSide = 'heads';
    let lastBet = 0;

    const balanceEl = document.getElementById('balance');
    const betInput = document.getElementById('betAmount');
    const statusEl = document.getElementById('statusMessage');
    const historyList = document.getElementById('coinflipHistoryList');
    const flipBtn = document.getElementById('flipBtn');
    const optionButtons = document.querySelectorAll('.option-btn');

    optionButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        selectedSide = btn.dataset.side;
        optionButtons.forEach((b) => b.classList.remove('active'));
        btn.classList.add('active');
      });
    });

    function formatSide(value) {
      return value === 'tails' ? '—Ä–µ—à–∫–∞' : '–æ—Ä—ë–ª';
    }

    async function init() {
      try {
        const resp = await fetch(`${BASE_URL}/check-auth`, { credentials: 'include' });
        if (!resp.ok) throw new Error('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
        user = await resp.json();
        balanceEl.textContent = formatCoins(user.balance);
        if (lastBet > 0) {
          betInput.value = lastBet;
        }
        await loadHistory();
      } catch (err) {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç');
        window.location.href = 'index.html';
      }
    }

    async function playCoinflip() {
      const bet = Number(betInput.value);
      if (!bet || bet <= 0) {
        statusEl.textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—Ç–∞–≤–∫—É';
        statusEl.className = 'message error';
        return;
      }

      try {
        flipBtn.disabled = true;
        statusEl.textContent = '';
        const resp = await fetch(`${BASE_URL}/coinflip/play`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ bet, choice: selectedSide })
        });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å—Ç–∞–≤–∫–∏');
        balanceEl.textContent = formatCoins(data.newBalance);
        statusEl.textContent = data.win
          ? `üéâ –í—ã–ø–∞–ª ${formatSide(data.result)}. –í—ã–∏–≥—Ä—ã—à: ${formatCandy(data.payout)}`
          : `ü§ï –í—ã–ø–∞–ª ${formatSide(data.result)}. –°—Ç–∞–≤–∫–∞ –ø—Ä–æ–∏–≥—Ä–∞–Ω–∞`;
        statusEl.className = `message ${data.win ? 'success' : 'error'}`;
        lastBet = bet;
        betInput.value = bet;
        await loadHistory(data.history);
      } catch (err) {
        statusEl.textContent = err.message;
        statusEl.className = 'message error';
      } finally {
        flipBtn.disabled = false;
      }
    }

    async function loadHistory(prefetched) {
      try {
        const data =
          prefetched ||
          (await fetch(`${BASE_URL}/coinflip/history`, { credentials: 'include' }).then((r) => r.json()));
        renderHistory(Array.isArray(data) ? data : []);
      } catch (err) {
        console.error('coinflip history error', err);
      }
    }

    function renderHistory(entries) {
      historyList.innerHTML = '';
      if (!entries.length) {
        historyList.innerHTML = '<div class="history-item muted">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';
        return;
      }
      entries.forEach((entry) => {
        const item = document.createElement('div');
        item.className = 'history-item';
        if (user && entry.username === user.username) {
          item.classList.add('highlight');
        }
        const date = new Date(entry.timestamp).toLocaleString('ru-RU');
        const outcome = entry.win ? '‚Üí –ü–æ–±–µ–¥–∞' : '‚Üí –ü–æ—Ä–∞–∂–µ–Ω–∏–µ';
        item.innerHTML = `<strong>${date}</strong> ‚Äî ${entry.username} –≤—ã–±—Ä–∞–ª ${formatSide(entry.choice)}, –≤—ã–ø–∞–ª ${formatSide(entry.result)} ${outcome} (${formatCandy(entry.bet)})`;
        historyList.appendChild(item);
      });
    }

    flipBtn.addEventListener('click', playCoinflip);
    init();
  </script>
</body>
</html>

