<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ü—Ä–æ—Ñ–∏–ª—å ¬∑ 320xbet</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="dashboard-shell">
    <header class="glass-card top-bar">
      <div>
        <p class="eyebrow">–ü—Ä–æ—Ñ–∏–ª—å</p>
        <h1><span id="username"></span></h1>
        <p class="muted">–ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–º</p>
      </div>
      <button class="btn-outline" onclick="window.location.href='mainPage.html'">‚¨Ö –ù–∞–∑–∞–¥</button>
    </header>

    <section class="stat-grid">
      <article class="glass-card stat-card">
        <p class="muted">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å</p>
        <h2><span id="balance"></span> üç¨</h2>
        <p class="stat-subtext">–ö–æ–Ω—Ñ–µ—Ç–∫–∏ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –∏ —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</p>
      </article>
      <article class="glass-card stat-card">
        <p class="muted">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</p>
        <button id="depositBtn" class="btn-primary" style="width:100%; margin-top:12px">+ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</button>
        <p id="depositStatus" class="stat-subtext" style="margin-top:8px"></p>
      </article>
    </section>

    <section class="glass-card">
      <p class="eyebrow">–ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä</p>
      <div class="history-tabs">
        <button class="tab-btn active" data-tab="crash">üöÄ –ö—Ä–∞—à</button>
        <button class="tab-btn" data-tab="roulette">üéØ –†—É–ª–µ—Ç–∫–∞</button>
        <button class="tab-btn" data-tab="coinflip">ü™ô –ú–æ–Ω–µ—Ç–∫–∞</button>
        <button class="tab-btn" data-tab="dice">üé≤ –î–∞–π—Å</button>
      </div>
      <div id="crashHistory" class="history-content active">
        <div class="history-list" id="crashHistoryList"></div>
      </div>
      <div id="rouletteHistory" class="history-content">
        <div class="history-list" id="rouletteHistoryList"></div>
      </div>
      <div id="coinflipHistory" class="history-content">
        <div class="history-list" id="coinflipHistoryList"></div>
      </div>
      <div id="diceHistory" class="history-content">
        <div class="history-list" id="diceHistoryList"></div>
      </div>
    </section>

    <section class="glass-card">
      <p class="eyebrow">–ò—Å—Ç–æ—Ä–∏—è –¥–µ–ø–æ–∑–∏—Ç–æ–≤</p>
      <div class="history-list" id="depositHistoryList"></div>
    </section>
  </div>

  <div id="depositModal" class="modal-overlay hidden">
    <div class="modal-content glass-card">
      <button id="depositModalClose" class="modal-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
      <div id="depositModalBody">
        <h2>–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞</h2>
        <p class="muted">–ú–∞–∫—Å–∏–º—É–º 1000 üç¨ —Ä–∞–∑ –≤ —á–∞—Å</p>
        <input type="number" id="depositAmount" class="input-field" min="1" max="1000" placeholder="–°—É–º–º–∞ (1-1000)" />
        <button id="confirmDepositBtn" class="btn-primary" style="width:100%; margin-top:12px">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
        <p id="depositMessage" class="message" style="margin-top:12px"></p>
      </div>
    </div>
  </div>

  <script>
    const BASE_URL = 'https://fen4yaragithubio-production.up.railway.app';
    let user = null;

    const usernameEl = document.getElementById('username');
    const balanceEl = document.getElementById('balance');
    const depositBtn = document.getElementById('depositBtn');
    const depositStatus = document.getElementById('depositStatus');
    const depositModal = document.getElementById('depositModal');
    const depositModalClose = document.getElementById('depositModalClose');
    const depositAmount = document.getElementById('depositAmount');
    const confirmDepositBtn = document.getElementById('confirmDepositBtn');
    const depositMessage = document.getElementById('depositMessage');
    const crashHistoryList = document.getElementById('crashHistoryList');
    const rouletteHistoryList = document.getElementById('rouletteHistoryList');
    const coinflipHistoryList = document.getElementById('coinflipHistoryList');
    const diceHistoryList = document.getElementById('diceHistoryList');
    const depositHistoryList = document.getElementById('depositHistoryList');

    async function checkAuth() {
      try {
        const response = await fetch(`${BASE_URL}/check-auth`, {
          credentials: 'include'
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è');
        }

        user = await response.json();
        usernameEl.textContent = user.username;
        balanceEl.textContent = user.balance;
        await loadDepositStatus();
        await loadHistory();
      } catch (err) {
        console.error('Auth error:', err);
        alert('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ' + err.message);
        window.location.href = 'index.html';
      }
    }

    async function loadDepositStatus() {
      try {
        const resp = await fetch(`${BASE_URL}/profile/deposit-status`, {
          credentials: 'include'
        });
        if (!resp.ok) return;
        const data = await resp.json();
        if (data.nextDepositAt) {
          const nextTime = new Date(data.nextDepositAt);
          const now = new Date();
          if (nextTime > now) {
            const minsLeft = Math.ceil((nextTime - now) / 60000);
            depositStatus.textContent = `–°–ª–µ–¥—É—é—â–µ–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ ${minsLeft} –º–∏–Ω`;
            depositStatus.style.color = 'var(--text-muted)';
          } else {
            depositStatus.textContent = '–î–æ—Å—Ç—É–ø–Ω–æ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ';
            depositStatus.style.color = 'var(--success)';
          }
        } else {
          depositStatus.textContent = '–î–æ—Å—Ç—É–ø–Ω–æ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ';
          depositStatus.style.color = 'var(--success)';
        }
      } catch (err) {
        console.error('Deposit status error:', err);
      }
    }

    async function loadHistory() {
      try {
        const resp = await fetch(`${BASE_URL}/profile/history`, {
          credentials: 'include'
        });
        if (!resp.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é');
        const data = await resp.json();

        // –ö—Ä–∞—à –∏—Å—Ç–æ—Ä–∏—è
        crashHistoryList.innerHTML = '';
        if (!data.crash || !data.crash.length) {
          crashHistoryList.innerHTML = '<div class="history-item muted">–ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –∏–≥—Ä—ã –≤ –ö—Ä–∞—à</div>';
        } else {
          data.crash.forEach((round) => {
            const li = document.createElement('li');
            li.className = 'history-item clickable';
            const date = new Date(round.timestamp);
            const header = document.createElement('div');
            header.innerHTML = `<strong>${date.toLocaleString('ru-RU')}</strong> ‚Üí x${round.crashPoint.toFixed(2)}, –ø—É–ª ${round.totalBet}üç¨`;
            li.append(header);

            const player = round.players.find((p) => p.username === user.username);
            if (player) {
              const subUl = document.createElement('ul');
              subUl.className = 'history-players';
              const subLi = document.createElement('li');
              let txt = `–°—Ç–∞–≤–∫–∞: ${player.bet}üç¨`;
              if (player.cashedOut) {
                txt += `, –∑–∞–±—Ä–∞–ª(–∞) –Ω–∞ x${player.cashoutCoef.toFixed(2)} ‚Üí –≤—ã–∏–≥—Ä—ã—à ${player.winnings}üç¨`;
              } else {
                txt += `, –ø—Ä–æ–∏–≥—Ä–∞–ª(–∞)`;
              }
              subLi.textContent = txt;
              subUl.append(subLi);
              li.append(subUl);
            }

            li.addEventListener('click', () => openCrashHistoryModal(round));
            crashHistoryList.append(li);
          });
        }

        // –†—É–ª–µ—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏—è
        rouletteHistoryList.innerHTML = '';
        if (!data.roulette || !data.roulette.length) {
          rouletteHistoryList.innerHTML = '<div class="history-item muted">–ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –∏–≥—Ä—ã –≤ –†—É–ª–µ—Ç–∫—É</div>';
        } else {
          data.roulette.forEach((round) => {
            const card = document.createElement('div');
            card.className = 'history-item clickable';
            const date = new Date(round.timestamp);
            const header = document.createElement('div');
            header.innerHTML = `<strong>${date.toLocaleTimeString('ru-RU')}</strong> ‚Äî ${round.winner}`;
            const body = document.createElement('div');
            body.className = 'muted';
            const ticketInfo = typeof round.winningTicket === 'number'
              ? `, –±–∏–ª–µ—Ç ${round.winningTicket.toFixed(2)}`
              : '';
            body.textContent = `–ë–∞–Ω–∫: ${round.totalBet} üç¨${ticketInfo}`;
            
            const player = round.players.find((p) => p.username === user.username);
            if (player) {
              const playerInfo = document.createElement('div');
              playerInfo.className = 'muted';
              playerInfo.style.marginTop = '4px';
              playerInfo.textContent = `–¢–≤–æ—è —Å—Ç–∞–≤–∫–∞: ${player.bet}üç¨ ${round.winner === user.username ? '‚Üí –ü–æ–±–µ–¥–∞!' : '‚Üí –ü—Ä–æ–∏–≥—Ä—ã—à'}`;
              body.appendChild(playerInfo);
            }

            card.appendChild(header);
            card.appendChild(body);
            card.addEventListener('click', () => openRouletteHistoryModal(round));
            rouletteHistoryList.appendChild(card);
          });
        }

        // –ú–æ–Ω–µ—Ç–∫–∞
        coinflipHistoryList.innerHTML = '';
        if (!data.coinflip || !data.coinflip.length) {
          coinflipHistoryList.innerHTML = '<div class="history-item muted">–ù–µ—Ç –∏–≥—Ä –≤ –ú–æ–Ω–µ—Ç–∫—É</div>';
        } else {
          data.coinflip.forEach((entry) => {
            const row = document.createElement('div');
            row.className = 'history-item';
            const date = new Date(entry.timestamp);
            const resultText = entry.win ? '‚Üí –ü–æ–±–µ–¥–∞' : '‚Üí –ü–æ—Ä–∞–∂–µ–Ω–∏–µ';
            const choice = entry.choice === 'tails' ? '—Ä–µ—à–∫–∞' : '–æ—Ä—ë–ª';
            const resultSide = entry.result === 'tails' ? '—Ä–µ—à–∫–∞' : '–æ—Ä—ë–ª';
            const net = entry.win ? entry.payout - entry.bet : -entry.bet;
            row.innerHTML = `<strong>${date.toLocaleString('ru-RU')}</strong> ‚Äî –≤—ã–±—Ä–∞–ª ${choice}, –≤—ã–ø–∞–ª ${resultSide} ${resultText} (${net > 0 ? '+' : ''}${net}üç¨)`;
            coinflipHistoryList.appendChild(row);
          });
        }

        // –î–∞–π—Å
        diceHistoryList.innerHTML = '';
        if (!data.dice || !data.dice.length) {
          diceHistoryList.innerHTML = '<div class="history-item muted">–ù–µ—Ç –∏–≥—Ä –≤ –î–∞–π—Å</div>';
        } else {
          data.dice.forEach((entry) => {
            const row = document.createElement('div');
            row.className = 'history-item';
            const date = new Date(entry.timestamp);
            const resultText = entry.win ? '‚Üí –ü–æ–±–µ–¥–∞' : '‚Üí –ü–æ—Ä–∞–∂–µ–Ω–∏–µ';
            const net = entry.win ? entry.payout - entry.bet : -entry.bet;
            row.innerHTML = `<strong>${date.toLocaleString('ru-RU')}</strong> ‚Äî –≤—ã–±—Ä–∞–ª ${entry.guess}, –≤—ã–ø–∞–ª–æ ${entry.roll} ${resultText} (${net > 0 ? '+' : ''}${net}üç¨)`;
            diceHistoryList.appendChild(row);
          });
        }

        // –ò—Å—Ç–æ—Ä–∏—è –¥–µ–ø–æ–∑–∏—Ç–æ–≤
        depositHistoryList.innerHTML = '';
        if (!data.deposits || !data.deposits.length) {
          depositHistoryList.innerHTML = '<div class="history-item muted">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–π –µ—â—ë –Ω–µ –±—ã–ª–æ</div>';
        } else {
          data.deposits.forEach((entry) => {
            const row = document.createElement('div');
            row.className = 'history-item';
            const date = new Date(entry.timestamp);
            row.innerHTML = `<strong>${date.toLocaleString('ru-RU')}</strong> ‚Äî +${entry.amount}üç¨`;
            depositHistoryList.appendChild(row);
          });
        }
      } catch (err) {
        console.error('History load error:', err);
      }
    }

    function openCrashHistoryModal(round) {
      // –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç—É –∂–µ –º–æ–¥–∞–ª–∫—É —á—Ç–æ –∏ –≤ crash.html, –Ω–æ –ø—Ä–æ—â–µ –ø–æ–∫–∞–∑–∞—Ç—å alert
      const date = new Date(round.timestamp).toLocaleString('ru-RU');
      const player = round.players.find((p) => p.username === user.username);
      let info = `–ö—Ä–∞—à x${round.crashPoint.toFixed(2)}\n–ü—É–ª: ${round.totalBet}üç¨\n\n`;
      if (player) {
        info += `–¢–≤–æ—è —Å—Ç–∞–≤–∫–∞: ${player.bet}üç¨\n`;
        if (player.cashedOut) {
          info += `–ó–∞–±—Ä–∞–ª(–∞) –Ω–∞ x${player.cashoutCoef.toFixed(2)}\n–í—ã–∏–≥—Ä—ã—à: ${player.winnings}üç¨`;
        } else {
          info += '–ü—Ä–æ–∏–≥—Ä–∞–ª(–∞)';
        }
      }
      alert(info);
    }

    function openRouletteHistoryModal(round) {
      const date = new Date(round.timestamp).toLocaleString('ru-RU');
      const ticketInfo = typeof round.winningTicket === 'number'
        ? round.winningTicket.toFixed(2)
        : '‚Äî';
      const player = round.players.find((p) => p.username === user.username);
      let info = `–ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ${round.winner}\n–ë–∞–Ω–∫: ${round.totalBet}üç¨\n–ë–∏–ª–µ—Ç: ${ticketInfo}\n\n`;
      if (player) {
        info += `–¢–≤–æ—è —Å—Ç–∞–≤–∫–∞: ${player.bet}üç¨\n`;
        info += round.winner === user.username ? '–ü–æ–±–µ–¥–∞!' : '–ü—Ä–æ–∏–≥—Ä—ã—à';
      }
      alert(info);
    }

    // –¢–∞–±—ã
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.history-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        const tab = btn.getAttribute('data-tab');
        document.getElementById(`${tab}History`).classList.add('active');
      });
    });

    // –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ
    depositBtn.addEventListener('click', () => {
      depositModal.classList.remove('hidden');
      depositAmount.value = '';
      depositMessage.textContent = '';
    });

    depositModalClose.addEventListener('click', () => {
      depositModal.classList.add('hidden');
    });

    depositModal.addEventListener('click', (e) => {
      if (e.target === depositModal) {
        depositModal.classList.add('hidden');
      }
    });

    confirmDepositBtn.addEventListener('click', async () => {
      const amount = parseInt(depositAmount.value, 10);
      if (!amount || amount < 1 || amount > 1000) {
        depositMessage.textContent = '–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –æ—Ç 1 –¥–æ 1000';
        depositMessage.className = 'message error';
        return;
      }

      try {
        confirmDepositBtn.disabled = true;
        depositMessage.textContent = '';
        const resp = await fetch(`${BASE_URL}/profile/deposit`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ amount })
        });
        const data = await resp.json();
        if (!resp.ok) {
          throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è');
        }
        depositMessage.textContent = `–ë–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω –Ω–∞ ${amount}üç¨!`;
        depositMessage.className = 'message success';
        user.balance = data.newBalance;
        balanceEl.textContent = user.balance;
        await loadDepositStatus();
        await loadHistory();
        setTimeout(() => {
          depositModal.classList.add('hidden');
        }, 1500);
      } catch (err) {
        depositMessage.textContent = err.message;
        depositMessage.className = 'message error';
      } finally {
        confirmDepositBtn.disabled = false;
      }
    });

    checkAuth();
    setInterval(loadDepositStatus, 60000); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
  </script>
</body>
</html>

