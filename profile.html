<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ü—Ä–æ—Ñ–∏–ª—å ¬∑ Infer Casino</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="dashboard-shell">
    <header class="glass-card top-bar">
      <div>
        <p class="eyebrow">–ü—Ä–æ—Ñ–∏–ª—å</p>
        <h1><span id="username"></span></h1>
        <p class="muted">–ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–º</p>
      </div>
      <button class="btn-outline" onclick="window.location.href='mainPage.html'">‚¨Ö –ù–∞–∑–∞–¥</button>
    </header>

    <section class="stat-grid">
      <article class="glass-card stat-card">
        <p class="muted">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å</p>
        <h2><span id="balance"></span> üç¨</h2>
        <p class="stat-subtext">–ö–æ–Ω—Ñ–µ—Ç–∫–∏ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –∏ —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</p>
      </article>
      <article class="glass-card stat-card">
        <p class="muted">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</p>
        <button id="depositBtn" class="btn-primary" style="width:100%; margin-top:12px">+ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</button>
        <p id="depositStatus" class="stat-subtext" style="margin-top:8px"></p>
      </article>
      <article class="glass-card stat-card">
        <p class="muted">–í—ã–≤–æ–¥ (–°–ë–ü)</p>
        <button id="withdrawBtn" class="btn-secondary" style="width:100%; margin-top:12px">‚Üó –í—ã–≤–µ—Å—Ç–∏</button>
        <p id="withdrawStatus" class="stat-subtext" style="margin-top:8px"></p>
      </article>
    </section>

    <section class="glass-card">
      <p class="eyebrow">–ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä</p>
      <div class="history-tabs">
        <button class="tab-btn active" data-tab="crash">üöÄ –ö—Ä–∞—à</button>
        <button class="tab-btn" data-tab="roulette">üéØ –†—É–ª–µ—Ç–∫–∞</button>
        <button class="tab-btn" data-tab="coinflip">üí∞ –ö–æ–∏–Ω—Ñ–ª–∏–ø</button>
        <button class="tab-btn" data-tab="dice">üé≤ –î–∞–π—Å</button>
      </div>
      <div id="crashHistory" class="history-content active">
        <div class="history-list" id="crashHistoryList"></div>
      </div>
      <div id="rouletteHistory" class="history-content">
        <div class="history-list" id="rouletteHistoryList"></div>
      </div>
      <div id="coinflipHistory" class="history-content">
        <div class="history-list" id="coinflipHistoryList"></div>
      </div>
      <div id="diceHistory" class="history-content">
        <div class="history-list" id="diceHistoryList"></div>
      </div>
    </section>

    <section class="glass-card">
      <p class="eyebrow">–ò—Å—Ç–æ—Ä–∏—è –¥–µ–ø–æ–∑–∏—Ç–æ–≤</p>
      <div class="history-list" id="depositHistoryList"></div>
    </section>

    <section class="glass-card">
      <p class="eyebrow">–ò—Å—Ç–æ—Ä–∏—è –≤—ã–≤–æ–¥–æ–≤ (–°–ë–ü)</p>
      <div class="history-list" id="withdrawHistoryList"></div>
    </section>

    <section class="glass-card">
      <p class="eyebrow">–ü—Ä–æ–º–æ–∫–æ–¥</p>
      <div class="inline-form">
        <input type="text" id="promocodeInput" class="input-field" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥" />
        <button id="activatePromocodeBtn" class="btn-primary" style="width: auto;">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>
      <p id="promocodeMessage" class="message" style="margin-top: 12px;"></p>
    </section>
  </div>

  <div id="depositModal" class="modal-overlay hidden">
    <div class="modal-content glass-card">
      <button id="depositModalClose" class="modal-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
      <div id="depositModalBody">
        <h2>–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞</h2>
        <div style="margin-bottom: 12px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">–°–ø–æ—Å–æ–± –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è:</label>
          <div style="display: flex; gap: 8px;">
            <button id="depositMethodFree" class="btn btn-secondary" style="flex: 1;">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ (1-1.000 üç¨)</button>
            <button id="depositMethodYooMoney" class="btn btn-secondary" style="flex: 1;">–ö–∞—Ä—Ç–∞ (2-50000 ‚ÇΩ)</button>
          </div>
        </div>
        <p class="muted" id="depositMethodDescription">–ú–∞–∫—Å–∏–º—É–º 1.000 üç¨ —Ä–∞–∑ –≤ —á–∞—Å</p>
        <input type="number" id="depositAmount" class="input-field" min="1" max="1000" placeholder="–°—É–º–º–∞ (1-1.000)" />
        <button id="confirmDepositBtn" class="btn-primary" style="width:100%; margin-top:12px">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
        <p id="depositMessage" class="message" style="margin-top:12px"></p>
      </div>
    </div>
  </div>

  <div id="withdrawModal" class="modal-overlay hidden">
    <div class="modal-content glass-card">
      <button id="withdrawModalClose" class="modal-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
      <div>
        <h2>–í—ã–≤–æ–¥ —á–µ—Ä–µ–∑ –°–ë–ü</h2>
        <p class="muted">–£–∫–∞–∂–∏—Ç–µ —Å—É–º–º—É –∏ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ –ø–æ –°–ë–ü.</p>
        <input type="number" id="withdrawAmount" class="input-field" min="10" placeholder="–°—É–º–º–∞ (‚ÇΩ)" />
        <input type="text" id="withdrawBankName" class="input-field" placeholder="–ë–∞–Ω–∫ / –ø–æ–ª—É—á–∞—Ç–µ–ª—å" />
        <input type="text" id="withdrawSbpBankId" class="input-field" placeholder="ID –±–∞–Ω–∫–∞ –°–ë–ü (–µ—Å–ª–∏ –µ—Å—Ç—å)" />
        <input type="text" id="withdrawPhone" class="input-field" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–π –∫ –°–ë–ü" />
        <textarea id="withdrawComment" class="input-field" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–ø–æ –∂–µ–ª–∞–Ω–∏—é)"></textarea>
        <button id="confirmWithdrawBtn" class="btn-primary" style="width:100%; margin-top:12px">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
        <p id="withdrawMessage" class="message" style="margin-top:12px"></p>
      </div>
    </div>
  </div>

  <script src="script/utils.js"></script>
  <script>
    const BASE_URL = 'https://infer.cfd';
    let user = null;

    const usernameEl = document.getElementById('username');
    const balanceEl = document.getElementById('balance');
    const depositBtn = document.getElementById('depositBtn');
    const depositStatus = document.getElementById('depositStatus');
    const depositModal = document.getElementById('depositModal');
    const depositModalClose = document.getElementById('depositModalClose');
    const depositAmount = document.getElementById('depositAmount');
    const confirmDepositBtn = document.getElementById('confirmDepositBtn');
    const depositMessage = document.getElementById('depositMessage');
    const depositMethodFree = document.getElementById('depositMethodFree');
    const depositMethodYooMoney = document.getElementById('depositMethodYooMoney');
    const depositMethodDescription = document.getElementById('depositMethodDescription');
    let currentDepositMethod = 'free'; // 'free' –∏–ª–∏ 'yoomoney'
    const crashHistoryList = document.getElementById('crashHistoryList');
    const rouletteHistoryList = document.getElementById('rouletteHistoryList');
    const coinflipHistoryList = document.getElementById('coinflipHistoryList');
    const diceHistoryList = document.getElementById('diceHistoryList');
    const depositHistoryList = document.getElementById('depositHistoryList');
    const withdrawHistoryList = document.getElementById('withdrawHistoryList');
    const promocodeInput = document.getElementById('promocodeInput');
    const activatePromocodeBtn = document.getElementById('activatePromocodeBtn');
    const promocodeMessage = document.getElementById('promocodeMessage');
    const withdrawBtn = document.getElementById('withdrawBtn');
    const withdrawStatus = document.getElementById('withdrawStatus');
    const withdrawModal = document.getElementById('withdrawModal');
    const withdrawModalClose = document.getElementById('withdrawModalClose');
    const withdrawAmount = document.getElementById('withdrawAmount');
    const withdrawBankName = document.getElementById('withdrawBankName');
    const withdrawSbpBankId = document.getElementById('withdrawSbpBankId');
    const withdrawPhone = document.getElementById('withdrawPhone');
    const withdrawComment = document.getElementById('withdrawComment');
    const confirmWithdrawBtn = document.getElementById('confirmWithdrawBtn');
    const withdrawMessage = document.getElementById('withdrawMessage');

    async function checkAuth() {
      try {
        const response = await fetch(`${BASE_URL}/check-auth`, {
          credentials: 'include'
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è');
        }

        user = await response.json();
        usernameEl.textContent = user.username;
        balanceEl.textContent = formatCoins(user.balance, { decimals: 2 });
        await loadDepositStatus();
        await loadHistory();

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–∞—Ç–µ–∂–∞ YooMoney –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ
        const urlParams = new URLSearchParams(window.location.search);
        const paymentId = urlParams.get('payment');
        if (paymentId) {
          checkYooMoneyPayment(paymentId);
          // –£–±–∏—Ä–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä –∏–∑ URL
          window.history.replaceState({}, document.title, window.location.pathname);
        }
      } catch (err) {
        console.error('Auth error:', err);
        alert('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ' + err.message);
        window.location.href = 'index.html';
      }
    }

    async function checkYooMoneyPayment(paymentId) {
      try {
        const resp = await fetch(`${BASE_URL}/profile/yoomoney/check/${paymentId}`, {
          credentials: 'include'
        });
        const data = await resp.json();
        if (data.status === 'success') {
          user.balance = data.balance;
          balanceEl.textContent = formatCoins(user.balance, { decimals: 2 });
          await loadDepositStatus();
          await loadHistory();
          alert(`–ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω! –ë–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω –Ω–∞ ${data.amount}‚ÇΩ.`);
        } else if (data.status === 'pending') {
          // –ü–ª–∞—Ç–µ–∂ –µ—â–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è, –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏
          const checkInterval = setInterval(async () => {
            try {
              const checkResp = await fetch(`${BASE_URL}/profile/yoomoney/check/${paymentId}`, {
                credentials: 'include'
              });
              const checkData = await checkResp.json();
              if (checkData.status === 'success') {
                clearInterval(checkInterval);
                user.balance = checkData.balance;
                balanceEl.textContent = formatCoins(user.balance, { decimals: 2 });
                await loadDepositStatus();
                await loadHistory();
                alert(`–ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω! –ë–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω –Ω–∞ ${checkData.amount}‚ÇΩ.`);
              } else if (checkData.status !== 'pending') {
                clearInterval(checkInterval);
              }
            } catch (err) {
              console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞:', err);
              clearInterval(checkInterval);
            }
          }, 5000);
          setTimeout(() => clearInterval(checkInterval), 5 * 60 * 1000);
        }
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–ª–∞—Ç–µ–∂–∞:', err);
      }
    }

    async function loadDepositStatus() {
      try {
        const resp = await fetch(`${BASE_URL}/profile/deposit-status`, {
          credentials: 'include'
        });
        if (!resp.ok) return;
        const data = await resp.json();
        if (data.nextDepositAt) {
          const nextTime = new Date(data.nextDepositAt);
          const now = new Date();
          if (nextTime > now) {
            const minsLeft = Math.ceil((nextTime - now) / 60000);
            depositStatus.textContent = `–°–ª–µ–¥—É—é—â–µ–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ ${minsLeft} –º–∏–Ω`;
            depositStatus.style.color = 'var(--text-muted)';
          } else {
            depositStatus.textContent = '–î–æ—Å—Ç—É–ø–Ω–æ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ';
            depositStatus.style.color = 'var(--success)';
          }
        } else {
          depositStatus.textContent = '–î–æ—Å—Ç—É–ø–Ω–æ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ';
          depositStatus.style.color = 'var(--success)';
        }
      } catch (err) {
        console.error('Deposit status error:', err);
      }
    }

    async function loadHistory() {
      try {
        const resp = await fetch(`${BASE_URL}/profile/history`, {
          credentials: 'include'
        });
        if (!resp.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é');
        const data = await resp.json();

        // –ö—Ä–∞—à –∏—Å—Ç–æ—Ä–∏—è
        crashHistoryList.innerHTML = '';
        if (!data.crash || !data.crash.length) {
          crashHistoryList.innerHTML = '<div class="history-item muted">–ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –∏–≥—Ä—ã –≤ –ö—Ä–∞—à</div>';
        } else {
          data.crash.forEach((round) => {
            const li = document.createElement('li');
            li.className = 'history-item clickable';
            const date = new Date(round.timestamp);
            const header = document.createElement('div');
        header.innerHTML = `<strong>${date.toLocaleString('ru-RU')}</strong> ‚Üí x${round.crashPoint.toFixed(2)}, –ø—É–ª ${formatCandy(round.totalBet)}`;
            li.append(header);

            const player = round.players.find((p) => p.username === user.username);
            if (player) {
              const subUl = document.createElement('ul');
              subUl.className = 'history-players';
              const subLi = document.createElement('li');
              let txt = `–°—Ç–∞–≤–∫–∞: ${formatCandy(player.bet)}`;
              if (player.cashedOut) {
                txt += `, –∑–∞–±—Ä–∞–ª(–∞) –Ω–∞ x${player.cashoutCoef.toFixed(2)} ‚Üí –≤—ã–∏–≥—Ä—ã—à ${formatCandy(player.winnings)}`;
              } else {
                txt += `, –ø—Ä–æ–∏–≥—Ä–∞–ª(–∞)`;
              }
              subLi.textContent = txt;
              subUl.append(subLi);
              li.append(subUl);
            }

            li.addEventListener('click', () => openCrashHistoryModal(round));
            crashHistoryList.append(li);
          });
        }

        // –†—É–ª–µ—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏—è
        rouletteHistoryList.innerHTML = '';
        if (!data.roulette || !data.roulette.length) {
          rouletteHistoryList.innerHTML = '<div class="history-item muted">–ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –∏–≥—Ä—ã –≤ –†—É–ª–µ—Ç–∫—É</div>';
        } else {
          data.roulette.forEach((round) => {
            const card = document.createElement('div');
            card.className = 'history-item clickable';
            const date = new Date(round.timestamp);
            const header = document.createElement('div');
            header.innerHTML = `<strong>${date.toLocaleTimeString('ru-RU')}</strong> ‚Äî ${round.winner}`;
            const body = document.createElement('div');
            body.className = 'muted';
            const ticketInfo = typeof round.winningTicket === 'number'
              ? `, –±–∏–ª–µ—Ç ${round.winningTicket.toFixed(2)}`
              : '';
            body.textContent = `–ë–∞–Ω–∫: ${formatCandy(round.totalBet)}${ticketInfo}`;
            
            const player = round.players.find((p) => p.username === user.username);
            if (player) {
              const playerInfo = document.createElement('div');
              playerInfo.className = 'muted';
              playerInfo.style.marginTop = '4px';
              playerInfo.textContent = `–¢–≤–æ—è —Å—Ç–∞–≤–∫–∞: ${formatCandy(player.bet)} ${round.winner === user.username ? '‚Üí –ü–æ–±–µ–¥–∞!' : '‚Üí –ü—Ä–æ–∏–≥—Ä—ã—à'}`;
              body.appendChild(playerInfo);
            }

            card.appendChild(header);
            card.appendChild(body);
            card.addEventListener('click', () => openRouletteHistoryModal(round));
            rouletteHistoryList.appendChild(card);
          });
        }

        // –ö–æ–∏–Ω—Ñ–ª–∏–ø
        coinflipHistoryList.innerHTML = '';
        if (!data.coinflip || !data.coinflip.length) {
          coinflipHistoryList.innerHTML = '<div class="history-item muted">–ù–µ—Ç –∏–≥—Ä –≤ –ö–æ–∏–Ω—Ñ–ª–∏–ø</div>';
        } else {
          data.coinflip.forEach((entry) => {
            const row = document.createElement('div');
            row.className = 'history-item';
            const date = new Date(entry.timestamp);
            const resultText = entry.win ? '‚Üí –ü–æ–±–µ–¥–∞' : '‚Üí –ü–æ—Ä–∞–∂–µ–Ω–∏–µ';
            const choice = entry.choice === 'tails' ? '—Ä–µ—à–∫–∞' : '–æ—Ä—ë–ª';
            const resultSide = entry.result === 'tails' ? '—Ä–µ—à–∫–∞' : '–æ—Ä—ë–ª';
            const net = entry.win ? entry.payout - entry.bet : -entry.bet;
            row.innerHTML = `<strong>${date.toLocaleString('ru-RU')}</strong> ‚Äî –≤—ã–±—Ä–∞–ª ${choice}, –≤—ã–ø–∞–ª ${resultSide} ${resultText} (${formatSignedCandy(net)})`;
            coinflipHistoryList.appendChild(row);
          });
        }

        // –î–∞–π—Å
        diceHistoryList.innerHTML = '';
        if (!data.dice || !data.dice.length) {
          diceHistoryList.innerHTML = '<div class="history-item muted">–ù–µ—Ç –∏–≥—Ä –≤ –î–∞–π—Å</div>';
        } else {
          data.dice.forEach((entry) => {
            const row = document.createElement('div');
            row.className = 'history-item';
            const date = new Date(entry.timestamp);
            const resultText = entry.win ? '‚Üí –ü–æ–±–µ–¥–∞' : '‚Üí –ü–æ—Ä–∞–∂–µ–Ω–∏–µ';
            const net = entry.win ? entry.payout - entry.bet : -entry.bet;
            row.innerHTML = `<strong>${date.toLocaleString('ru-RU')}</strong> ‚Äî –≤—ã–±—Ä–∞–ª ${entry.guess}, –≤—ã–ø–∞–ª–æ ${entry.roll} ${resultText} (${formatSignedCandy(net)})`;
            diceHistoryList.appendChild(row);
          });
        }

        // –ò—Å—Ç–æ—Ä–∏—è –¥–µ–ø–æ–∑–∏—Ç–æ–≤
        depositHistoryList.innerHTML = '';
        if (!data.deposits || !data.deposits.length) {
          depositHistoryList.innerHTML = '<div class="history-item muted">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–π –µ—â—ë –Ω–µ –±—ã–ª–æ</div>';
        } else {
          data.deposits.forEach((entry) => {
            const row = document.createElement('div');
            row.className = 'history-item';
            const date = new Date(entry.timestamp);
            row.innerHTML = `<strong>${date.toLocaleString('ru-RU')}</strong> ‚Äî ${formatSignedCandy(entry.amount)}`;
            depositHistoryList.appendChild(row);
          });
        }

        // –ò—Å—Ç–æ—Ä–∏—è –≤—ã–≤–æ–¥–æ–≤
        withdrawHistoryList.innerHTML = '';
        if (!data.withdrawals || !data.withdrawals.length) {
          withdrawHistoryList.innerHTML = '<div class="history-item muted">–ó–∞—è–≤–æ–∫ –Ω–∞ –≤—ã–≤–æ–¥ –Ω–µ—Ç</div>';
          withdrawStatus.textContent = '–ù–æ–≤—ã–µ –∑–∞—è–≤–∫–∏ –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–≤–∞–ª–∏—Å—å';
        } else {
          data.withdrawals.forEach((entry) => {
            const row = document.createElement('div');
            row.className = 'history-item';
            const date = new Date(entry.createdAt);
            row.innerHTML = `<strong>${date.toLocaleString('ru-RU')}</strong> ‚Äî ${entry.amount}‚ÇΩ ‚Üí ${entry.status}`;
            withdrawHistoryList.appendChild(row);
          });
          const last = data.withdrawals[data.withdrawals.length - 1];
          if (last.status === 'pending') {
            withdrawStatus.textContent = `–ï—Å—Ç—å –æ–∂–∏–¥–∞—é—â–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ ${last.amount}‚ÇΩ`;
            withdrawStatus.style.color = 'var(--warning)';
          } else if (last.status === 'completed') {
            withdrawStatus.textContent = `–ü–æ—Å–ª–µ–¥–Ω—è—è –≤—ã–ø–ª–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –Ω–∞ ${last.amount}‚ÇΩ`;
            withdrawStatus.style.color = 'var(--success)';
          } else if (last.status === 'error') {
            withdrawStatus.textContent = `–û—à–∏–±–∫–∞ –≤—ã–ø–ª–∞—Ç—ã: ${last.error || '—Å–º. –∞–¥–º–∏–Ω–∞'}`;
            withdrawStatus.style.color = 'var(--danger)';
          } else if (last.status === 'cancelled') {
            withdrawStatus.textContent = '–ü–æ—Å–ª–µ–¥–Ω—è—è –∑–∞—è–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞';
            withdrawStatus.style.color = 'var(--text-muted)';
          } else {
            withdrawStatus.textContent = '';
          }
        }
      } catch (err) {
        console.error('History load error:', err);
      }
    }

    function openCrashHistoryModal(round) {
      // –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç—É –∂–µ –º–æ–¥–∞–ª–∫—É —á—Ç–æ –∏ –≤ crash.html, –Ω–æ –ø—Ä–æ—â–µ –ø–æ–∫–∞–∑–∞—Ç—å alert
      const date = new Date(round.timestamp).toLocaleString('ru-RU');
      const player = round.players.find((p) => p.username === user.username);
      let info = `–ö—Ä–∞—à x${round.crashPoint.toFixed(2)}\n–ü—É–ª: ${formatCandy(round.totalBet)}\n\n`;
      if (player) {
        info += `–¢–≤–æ—è —Å—Ç–∞–≤–∫–∞: ${formatCandy(player.bet)}\n`;
        if (player.cashedOut) {
          info += `–ó–∞–±—Ä–∞–ª(–∞) –Ω–∞ x${player.cashoutCoef.toFixed(2)}\n–í—ã–∏–≥—Ä—ã—à: ${formatCandy(player.winnings)}`;
        } else {
          info += '–ü—Ä–æ–∏–≥—Ä–∞–ª(–∞)';
        }
      }
      alert(info);
    }

    function openRouletteHistoryModal(round) {
      const date = new Date(round.timestamp).toLocaleString('ru-RU');
      const ticketInfo = typeof round.winningTicket === 'number'
        ? round.winningTicket.toFixed(2)
        : '‚Äî';
      const player = round.players.find((p) => p.username === user.username);
      let info = `–ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ${round.winner}\n–ë–∞–Ω–∫: ${formatCandy(round.totalBet)}\n–ë–∏–ª–µ—Ç: ${ticketInfo}\n\n`;
      if (player) {
        info += `–¢–≤–æ—è —Å—Ç–∞–≤–∫–∞: ${formatCandy(player.bet)}\n`;
        info += round.winner === user.username ? '–ü–æ–±–µ–¥–∞!' : '–ü—Ä–æ–∏–≥—Ä—ã—à';
      }
      alert(info);
    }

    // –¢–∞–±—ã
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.history-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        const tab = btn.getAttribute('data-tab');
        document.getElementById(`${tab}History`).classList.add('active');
      });
    });

    // –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ
    depositBtn.addEventListener('click', () => {
      depositModal.classList.remove('hidden');
      depositAmount.value = '';
      depositMessage.textContent = '';
      currentDepositMethod = 'free';
      updateDepositMethodUI();
    });

    // –í—ã–±–æ—Ä —Å–ø–æ—Å–æ–±–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
    depositMethodFree.addEventListener('click', () => {
      currentDepositMethod = 'free';
      updateDepositMethodUI();
    });

    depositMethodYooMoney.addEventListener('click', () => {
      currentDepositMethod = 'yoomoney';
      updateDepositMethodUI();
    });

    function updateDepositMethodUI() {
      if (currentDepositMethod === 'free') {
        depositMethodFree.classList.add('btn-primary');
        depositMethodFree.classList.remove('btn-secondary');
        depositMethodYooMoney.classList.remove('btn-primary');
        depositMethodYooMoney.classList.add('btn-secondary');
        depositMethodDescription.textContent = '–ú–∞–∫—Å–∏–º—É–º 1.000 üç¨ —Ä–∞–∑ –≤ —á–∞—Å';
        depositAmount.min = '1';
        depositAmount.max = '1000';
        depositAmount.placeholder = '–°—É–º–º–∞ (1-1000)';
      } else {
        depositMethodYooMoney.classList.add('btn-primary');
        depositMethodYooMoney.classList.remove('btn-secondary');
        depositMethodFree.classList.remove('btn-primary');
        depositMethodFree.classList.add('btn-secondary');
        depositMethodDescription.textContent = '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –ö–∞—Ä—Ç—É (2-50000 ‚ÇΩ)';
        depositAmount.min = '1';
        depositAmount.max = '50000';
        depositAmount.placeholder = '–°—É–º–º–∞ –≤ —Ä—É–±–ª—è—Ö (2-50000)';
      }
    }

    depositModalClose.addEventListener('click', () => {
      depositModal.classList.add('hidden');
    });

    depositModal.addEventListener('click', (e) => {
      if (e.target === depositModal) {
        depositModal.classList.add('hidden');
      }
    });

    // –í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤
    withdrawBtn.addEventListener('click', () => {
      withdrawModal.classList.remove('hidden');
      withdrawAmount.value = '';
      withdrawBankName.value = '';
      withdrawSbpBankId.value = '';
      withdrawPhone.value = '';
      withdrawComment.value = '';
      withdrawMessage.textContent = '';
      withdrawMessage.className = 'message';
    });

    withdrawModalClose.addEventListener('click', () => {
      withdrawModal.classList.add('hidden');
    });

    withdrawModal.addEventListener('click', (e) => {
      if (e.target === withdrawModal) withdrawModal.classList.add('hidden');
    });

    confirmDepositBtn.addEventListener('click', async () => {
      const amount = parseInt(depositAmount.value, 10);
      
      if (currentDepositMethod === 'free') {
        if (!amount || amount < 1 || amount > 1000) {
          depositMessage.textContent = '–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –æ—Ç 1 –¥–æ 1000';
          depositMessage.className = 'message error';
          return;
        }

        try {
          confirmDepositBtn.disabled = true;
          depositMessage.textContent = '';
          const resp = await fetch(`${BASE_URL}/profile/deposit`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ amount })
          });
          const data = await resp.json();
          if (!resp.ok) {
            throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è');
          }
          depositMessage.textContent = `–ë–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω –Ω–∞ ${formatCandy(amount)}!`;
          depositMessage.className = 'message success';
          user.balance = data.newBalance;
          balanceEl.textContent = formatCoins(user.balance, { decimals: 2 });
          await loadDepositStatus();
          await loadHistory();
          setTimeout(() => {
            depositModal.classList.add('hidden');
          }, 1500);
        } catch (err) {
          depositMessage.textContent = err.message;
          depositMessage.className = 'message error';
        } finally {
          confirmDepositBtn.disabled = false;
        }
      } else {
        // YooMoney –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ
        if (!amount || amount < 1 || amount > 50000) {
          depositMessage.textContent = '–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –æ—Ç 2 –¥–æ 50000 —Ä—É–±–ª–µ–π';
          depositMessage.className = 'message error';
          return;
        }

        try {
          confirmDepositBtn.disabled = true;
          depositMessage.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞...';
          depositMessage.className = 'message';
          const resp = await fetch(`${BASE_URL}/profile/yoomoney/create`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ amount })
          });
          const data = await resp.json();
          if (!resp.ok) {
            throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞');
          }
          const payableAmount = data.payableAmount || amount;
          // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É
          window.open(data.paymentUrl, '_blank');
          depositMessage.textContent = `–ü–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ –∏ –æ–ø–ª–∞—Ç–∏—Ç–µ ${payableAmount}‚ÇΩ. –ù–∞ –±–∞–ª–∞–Ω—Å –±—É–¥–µ—Ç –∑–∞—á–∏—Å–ª–µ–Ω–æ ${data.amount || amount}‚ÇΩ –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è YooMoney.`;
          depositMessage.className = 'message success';
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
          const checkInterval = setInterval(async () => {
            try {
              const checkResp = await fetch(`${BASE_URL}/profile/yoomoney/check/${data.paymentId}`, {
                credentials: 'include'
              });
              const checkData = await checkResp.json();
              if (checkData.status === 'success') {
                clearInterval(checkInterval);
                const credited = checkData.amount || amount;
                depositMessage.textContent = `–ë–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω –Ω–∞ ${credited}‚ÇΩ!`;
                depositMessage.className = 'message success';
                user.balance = checkData.balance;
                balanceEl.textContent = formatCoins(user.balance, { decimals: 2 });
                await loadDepositStatus();
                await loadHistory();
                setTimeout(() => {
                  depositModal.classList.add('hidden');
                }, 2000);
              }
            } catch (err) {
              console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞:', err);
            }
          }, 5000);
          // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç
          setTimeout(() => clearInterval(checkInterval), 5 * 60 * 1000);
        } catch (err) {
          depositMessage.textContent = err.message;
          depositMessage.className = 'message error';
        } finally {
          confirmDepositBtn.disabled = false;
        }
      }
    });

    confirmWithdrawBtn.addEventListener('click', async () => {
      const amountValue = Number(withdrawAmount.value);
      if (!Number.isFinite(amountValue) || amountValue <= 0) {
        withdrawMessage.textContent = '–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –≤—ã–≤–æ–¥–∞';
        withdrawMessage.className = 'message error';
        return;
      }
      const payload = {
        amount: amountValue,
        bankName: withdrawBankName.value.trim(),
        sbpBankId: withdrawSbpBankId.value.trim(),
        phone: withdrawPhone.value.trim(),
        comment: withdrawComment.value.trim()
      };
      if (!payload.bankName || !payload.phone) {
        withdrawMessage.textContent = '–£–∫–∞–∂–∏—Ç–µ –±–∞–Ω–∫ –∏ —Ç–µ–ª–µ—Ñ–æ–Ω, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–π –∫ –°–ë–ü';
        withdrawMessage.className = 'message error';
        return;
      }
      try {
        confirmWithdrawBtn.disabled = true;
        withdrawMessage.textContent = '–°–æ–∑–¥–∞—ë–º –∑–∞—è–≤–∫—É...';
        withdrawMessage.className = 'message';
        const resp = await fetch(`${BASE_URL}/profile/withdraw/sbp`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(payload)
        });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É');
        withdrawMessage.textContent = data.message;
        withdrawMessage.className = 'message success';
        user.balance = data.balance;
        balanceEl.textContent = formatCoins(user.balance, { decimals: 2 });
        await loadHistory();
        setTimeout(() => withdrawModal.classList.add('hidden'), 2000);
      } catch (err) {
        withdrawMessage.textContent = err.message;
        withdrawMessage.className = 'message error';
      } finally {
        confirmWithdrawBtn.disabled = false;
      }
    });

    activatePromocodeBtn.addEventListener('click', async () => {
      const code = promocodeInput.value.trim();
      if (!code) {
        promocodeMessage.textContent = '–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥';
        promocodeMessage.className = 'message error';
        return;
      }

      try {
        activatePromocodeBtn.disabled = true;
        promocodeMessage.textContent = '';
        const resp = await fetch(`${BASE_URL}/promocode/activate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ code })
        });
        const data = await resp.json();
        if (!resp.ok) {
          throw new Error(data.error || '–û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏');
        }
        promocodeMessage.textContent = data.message;
        promocodeMessage.className = 'message success';
        user.balance = data.newBalance;
        balanceEl.textContent = formatCoins(user.balance, { decimals: 2 });
        promocodeInput.value = '';
        setTimeout(() => {
          promocodeMessage.textContent = '';
        }, 3000);
      } catch (err) {
        promocodeMessage.textContent = err.message;
        promocodeMessage.className = 'message error';
      } finally {
        activatePromocodeBtn.disabled = false;
      }
    });

    checkAuth();
    setInterval(loadDepositStatus, 60000); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
  </script>
</body>
</html>

