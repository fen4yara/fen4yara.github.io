<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ê–¥–º–∏–Ω ¬∑ 320xbet</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="admin-shell">
    <header class="glass-card top-bar">
      <div>
        <p class="eyebrow">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</p>
        <h1>–ê–¥–º–∏–Ω –º–µ–Ω—é</h1>
        <p class="muted">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏, –±–∞–ª–∞–Ω—Å–∞–º–∏ –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞–º–∏.</p>
      </div>
      <div class="link-row">
        <a href="index.html" class="muted">‚Üê –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ —Å–∞–π—Ç</a>
      </div>
    </header>

    <section class="glass-card auth-card" id="adminLoginSection">
      <div>
        <p class="eyebrow">–í—Ö–æ–¥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</p>
        <p class="muted">–î–∞–Ω–Ω—ã–µ –ª–æ–≥–∏–Ω–∞ –Ω–µ —Å–≤—è–∑–∞–Ω—ã —Å –æ–±—ã—á–Ω—ã–º–∏ –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏.</p>
      </div>
      <form id="adminLoginForm" class="form-grid">
        <input type="text" id="adminLogin" class="input-field" placeholder="–õ–æ–≥–∏–Ω" required />
        <input type="password" id="adminPassword" class="input-field" placeholder="–ü–∞—Ä–æ–ª—å" required />
        <button type="submit" class="btn-primary">–í–æ–π—Ç–∏ –≤ –ø–∞–Ω–µ–ª—å</button>
      </form>
      <p id="adminLoginMessage" class="message"></p>
    </section>

    <section class="glass-card" id="adminPanelSection" style="display:none">
      <div class="top-bar" style="gap:12px">
        <div>
          <p class="eyebrow">–°–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤</p>
          <p class="muted">–ò–∑–º–µ–Ω—è–π—Ç–µ –±–∞–ª–∞–Ω—Å –≤ –ø–∞—Ä—É –∫–ª–∏–∫–æ–≤. –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–∏—à—É—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –≤ users.json.</p>
        </div>
        <div class="admin-actions">
          <button id="downloadUsersBtn" class="btn-secondary" style="width:auto">üì• users.json</button>
          <button id="downloadHistoryBtn" class="btn-secondary" style="width:auto">üì• history.json</button>
          <button id="downloadDepositsBtn" class="btn-secondary" style="width:auto">üì• deposits.json</button>
          <button id="downloadPromocodesBtn" class="btn-secondary" style="width:auto">üì• promocodes.json</button>
          <button id="refreshBtn" class="btn-secondary" style="width:auto">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
          <button id="adminLogoutBtn" class="btn-outline" style="width:auto">–í—ã–π—Ç–∏</button>
        </div>
      </div>

      <div class="notice">
        –í–Ω–∏–º–∞–Ω–∏–µ: –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –≤—Å—Ç—É–ø–∞—é—Ç –≤ —Å–∏–ª—É –º–≥–Ω–æ–≤–µ–Ω–Ω–æ. –í–≤–æ–¥–∏—Ç–µ —Ç–æ–ª—å–∫–æ —Ü–µ–ª—ã–µ –Ω–µ–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è.
      </div>

      <div class="table-wrapper" style="overflow-x:auto">
        <table class="admin-table">
          <thead>
            <tr>
              <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
              <th>–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å</th>
              <th>–°—Ç–∞—Ç—É—Å</th>
              <th>–ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å</th>
              <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
            </tr>
          </thead>
          <tbody id="usersTable"></tbody>
        </table>
      </div>
      <p id="adminPanelMessage" class="message"></p>
    </section>

    <section class="glass-card" id="promocodesSection" style="display:none">
      <div class="top-bar" style="gap:12px">
        <div>
          <p class="eyebrow">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏</p>
          <p class="muted">–°–æ–∑–¥–∞–≤–∞–π—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã —Å –Ω–∞–≥—Ä–∞–¥–æ–π –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –∞–∫—Ç–∏–≤–∞—Ü–∏–π.</p>
        </div>
        <button id="refreshPromocodesBtn" class="btn-secondary" style="width:auto">–û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>

      <div class="form-grid" style="margin-bottom: 20px;">
        <h3>–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</h3>
        <input type="text" id="newPromocodeCode" class="input-field" placeholder="–ö–æ–¥ –ø—Ä–æ–º–æ–∫–æ–¥–∞" />
        <input type="number" id="newPromocodeReward" class="input-field" min="1" placeholder="–ù–∞–≥—Ä–∞–¥–∞ (üç¨)" />
        <input type="number" id="newPromocodeActivations" class="input-field" min="1" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–∞—Ü–∏–π" />
        <button id="createPromocodeBtn" class="btn-primary">–°–æ–∑–¥–∞—Ç—å</button>
        <p id="promocodeCreateMessage" class="message"></p>
      </div>

      <div class="table-wrapper" style="overflow-x:auto">
        <table class="admin-table">
          <thead>
            <tr>
              <th>–ö–æ–¥</th>
              <th>–ù–∞–≥—Ä–∞–¥–∞</th>
              <th>–ê–∫—Ç–∏–≤–∞—Ü–∏–π –æ—Å—Ç–∞–ª–æ—Å—å</th>
              <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
            </tr>
          </thead>
          <tbody id="promocodesTable"></tbody>
        </table>
      </div>
      <p id="promocodesMessage" class="message"></p>
    </section>
  </div>

  <script>
    const BASE_URL = 'https://fen4yaragithubio-production.up.railway.app';
    const adminLoginSection = document.getElementById('adminLoginSection');
    const adminPanelSection = document.getElementById('adminPanelSection');
    const adminLoginForm = document.getElementById('adminLoginForm');
    const adminLoginMessage = document.getElementById('adminLoginMessage');
    const adminPanelMessage = document.getElementById('adminPanelMessage');
    const usersTable = document.getElementById('usersTable');
    const refreshBtn = document.getElementById('refreshBtn');
    const logoutBtn = document.getElementById('adminLogoutBtn');
    const promocodesSection = document.getElementById('promocodesSection');
    const promocodesTable = document.getElementById('promocodesTable');
    const newPromocodeCode = document.getElementById('newPromocodeCode');
    const newPromocodeReward = document.getElementById('newPromocodeReward');
    const newPromocodeActivations = document.getElementById('newPromocodeActivations');
    const createPromocodeBtn = document.getElementById('createPromocodeBtn');
    const promocodeCreateMessage = document.getElementById('promocodeCreateMessage');
    const promocodesMessage = document.getElementById('promocodesMessage');
    const refreshPromocodesBtn = document.getElementById('refreshPromocodesBtn');

    async function fetchUsers() {
      const resp = await fetch(`${BASE_URL}/admin/users`, { credentials: 'include' });
      if (!resp.ok) {
        throw new Error('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞');
      }
      return resp.json();
    }

    function renderUsers(users) {
      usersTable.innerHTML = '';
      users.forEach(({ username, balance, banned }) => {
        const tr = document.createElement('tr');
        const isBanned = banned === true;
        tr.innerHTML = `
          <td>${username}</td>
          <td>${balance} üç¨</td>
          <td>
            <button class="btn-${isBanned ? 'primary' : 'outline'}" data-username="${username}" data-action="toggle-ban" style="width:auto; font-size:0.85rem">
              ${isBanned ? 'üîì –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : 'üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å'}
            </button>
          </td>
          <td><input type="number" min="0" class="input-field" value="${balance}" data-username="${username}" /></td>
          <td><button class="btn-primary" data-username="${username}" data-action="save-balance">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></td>
        `;
        usersTable.appendChild(tr);
      });
    }

    function togglePanels(isAdmin) {
      adminLoginSection.style.display = isAdmin ? 'none' : '';
      adminPanelSection.style.display = isAdmin ? '' : 'none';
    }

    async function init() {
      try {
        const users = await fetchUsers();
        renderUsers(users);
        togglePanels(true);
      } catch (err) {
        console.warn('Admin auth check failed:', err.message);
        togglePanels(false);
      }
    }

    adminLoginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      adminLoginMessage.textContent = '';
      const login = document.getElementById('adminLogin').value.trim();
      const password = document.getElementById('adminPassword').value.trim();
      try {
        const resp = await fetch(`${BASE_URL}/admin/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ login, password })
        });
        const data = await resp.json();
        if (!resp.ok) {
          throw new Error(data.error || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞');
        }
        adminLoginMessage.textContent = data.message;
        adminLoginMessage.className = 'message success';
        const users = await fetchUsers();
        renderUsers(users);
        togglePanels(true);
      } catch (err) {
        adminLoginMessage.textContent = err.message;
        adminLoginMessage.className = 'message error';
      }
    });

    refreshBtn.addEventListener('click', async () => {
      adminPanelMessage.textContent = '';
      try {
        const users = await fetchUsers();
        renderUsers(users);
        adminPanelMessage.textContent = '–°–ø–∏—Å–æ–∫ –æ–±–Ω–æ–≤–ª—ë–Ω.';
        adminPanelMessage.className = 'message success';
      } catch (err) {
        adminPanelMessage.textContent = err.message;
        adminPanelMessage.className = 'message error';
      }
    });

    usersTable.addEventListener('click', async (e) => {
      if (e.target.tagName !== 'BUTTON') return;
      const username = e.target.getAttribute('data-username');
      const action = e.target.getAttribute('data-action');
      
      if (action === 'toggle-ban') {
        try {
          const resp = await fetch(`${BASE_URL}/admin/users/${encodeURIComponent(username)}/ban`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include'
          });
          const data = await resp.json();
          if (!resp.ok) {
            throw new Error(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å');
          }
          adminPanelMessage.textContent = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${username} ${data.banned ? '–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' : '—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'}`;
          adminPanelMessage.className = 'message success';
          const users = await fetchUsers();
          renderUsers(users);
        } catch (err) {
          adminPanelMessage.textContent = err.message;
          adminPanelMessage.className = 'message error';
        }
        return;
      }
      
      if (action === 'save-balance') {
        const input = usersTable.querySelector(`input[data-username="${username}"]`);
        const balanceValue = Number(input.value);
        if (!Number.isFinite(balanceValue) || balanceValue < 0) {
          adminPanelMessage.textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –±–∞–ª–∞–Ω—Å.';
          adminPanelMessage.className = 'message error';
          return;
        }
        try {
          const resp = await fetch(`${BASE_URL}/admin/users/${encodeURIComponent(username)}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ balance: balanceValue })
          });
          const data = await resp.json();
          if (!resp.ok) {
            throw new Error(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å');
          }
          adminPanelMessage.textContent = `–ë–∞–ª–∞–Ω—Å ${data.username} –æ–±–Ω–æ–≤–ª—ë–Ω: ${data.balance} üç¨`;
          adminPanelMessage.className = 'message success';
          input.value = data.balance;
          input.parentElement.previousElementSibling.previousElementSibling.textContent = `${data.balance} üç¨`;
          const users = await fetchUsers();
          renderUsers(users);
        } catch (err) {
          adminPanelMessage.textContent = err.message;
          adminPanelMessage.className = 'message error';
        }
      }
    });
    
    document.getElementById('downloadUsersBtn').addEventListener('click', async () => {
      try {
        const resp = await fetch(`${BASE_URL}/admin/download/users.json`, { credentials: 'include' });
        if (!resp.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å');
        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'users.json';
        a.click();
        URL.revokeObjectURL(url);
      } catch (err) {
        adminPanelMessage.textContent = err.message;
        adminPanelMessage.className = 'message error';
      }
    });
    
    document.getElementById('downloadHistoryBtn').addEventListener('click', async () => {
      try {
        const resp = await fetch(`${BASE_URL}/admin/download/history.json`, { credentials: 'include' });
        if (!resp.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å');
        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'history.json';
        a.click();
        URL.revokeObjectURL(url);
      } catch (err) {
        adminPanelMessage.textContent = err.message;
        adminPanelMessage.className = 'message error';
      }
    });
    
    document.getElementById('downloadDepositsBtn').addEventListener('click', async () => {
      try {
        const resp = await fetch(`${BASE_URL}/admin/download/deposits.json`, { credentials: 'include' });
        if (!resp.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å');
        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'deposits.json';
        a.click();
        URL.revokeObjectURL(url);
      } catch (err) {
        adminPanelMessage.textContent = err.message;
        adminPanelMessage.className = 'message error';
      }
    });

    document.getElementById('downloadPromocodesBtn').addEventListener('click', async () => {
      try {
        const resp = await fetch(`${BASE_URL}/admin/download/promocodes.json`, { credentials: 'include' });
        if (!resp.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å');
        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'promocodes.json';
        a.click();
        URL.revokeObjectURL(url);
      } catch (err) {
        adminPanelMessage.textContent = err.message;
        adminPanelMessage.className = 'message error';
      }
    });

    // –ü—Ä–æ–º–æ–∫–æ–¥—ã
    async function fetchPromocodes() {
      const resp = await fetch(`${BASE_URL}/admin/promocodes`, { credentials: 'include' });
      if (!resp.ok) throw new Error('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞');
      return resp.json();
    }

    function renderPromocodes(promocodes) {
      promocodesTable.innerHTML = '';
      if (!promocodes.length) {
        promocodesTable.innerHTML = '<tr><td colspan="4" class="muted">–ù–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤</td></tr>';
        return;
      }
      promocodes.forEach((p) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.code}</td>
          <td>${p.reward} üç¨</td>
          <td>${p.activationsLeft}</td>
          <td><button class="btn-danger" data-code="${p.code}" data-action="delete-promocode" style="width:auto; font-size:0.85rem">–£–¥–∞–ª–∏—Ç—å</button></td>
        `;
        promocodesTable.appendChild(tr);
      });
    }

    createPromocodeBtn.addEventListener('click', async () => {
      const code = newPromocodeCode.value.trim();
      const reward = Number(newPromocodeReward.value);
      const activations = Number(newPromocodeActivations.value);
      
      if (!code) {
        promocodeCreateMessage.textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥';
        promocodeCreateMessage.className = 'message error';
        return;
      }
      if (!reward || reward < 1) {
        promocodeCreateMessage.textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –Ω–∞–≥—Ä–∞–¥—É';
        promocodeCreateMessage.className = 'message error';
        return;
      }
      if (!activations || activations < 1) {
        promocodeCreateMessage.textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–∞—Ü–∏–π';
        promocodeCreateMessage.className = 'message error';
        return;
      }

      try {
        createPromocodeBtn.disabled = true;
        const resp = await fetch(`${BASE_URL}/admin/promocodes`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ code, reward, activations })
        });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è');
        promocodeCreateMessage.textContent = '–ü—Ä–æ–º–æ–∫–æ–¥ —Å–æ–∑–¥–∞–Ω!';
        promocodeCreateMessage.className = 'message success';
        newPromocodeCode.value = '';
        newPromocodeReward.value = '';
        newPromocodeActivations.value = '';
        const promocodes = await fetchPromocodes();
        renderPromocodes(promocodes);
        setTimeout(() => {
          promocodeCreateMessage.textContent = '';
        }, 2000);
      } catch (err) {
        promocodeCreateMessage.textContent = err.message;
        promocodeCreateMessage.className = 'message error';
      } finally {
        createPromocodeBtn.disabled = false;
      }
    });

    refreshPromocodesBtn.addEventListener('click', async () => {
      try {
        const promocodes = await fetchPromocodes();
        renderPromocodes(promocodes);
        promocodesMessage.textContent = '–°–ø–∏—Å–æ–∫ –æ–±–Ω–æ–≤–ª—ë–Ω';
        promocodesMessage.className = 'message success';
        setTimeout(() => {
          promocodesMessage.textContent = '';
        }, 2000);
      } catch (err) {
        promocodesMessage.textContent = err.message;
        promocodesMessage.className = 'message error';
      }
    });

    promocodesTable.addEventListener('click', async (e) => {
      if (e.target.tagName !== 'BUTTON') return;
      const code = e.target.getAttribute('data-code');
      const action = e.target.getAttribute('data-action');
      
      if (action === 'delete-promocode') {
        if (!confirm(`–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥ "${code}"?`)) return;
        try {
          const resp = await fetch(`${BASE_URL}/admin/promocodes/${encodeURIComponent(code)}`, {
            method: 'DELETE',
            credentials: 'include'
          });
          const data = await resp.json();
          if (!resp.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
          promocodesMessage.textContent = '–ü—Ä–æ–º–æ–∫–æ–¥ —É–¥–∞–ª—ë–Ω';
          promocodesMessage.className = 'message success';
          const promocodes = await fetchPromocodes();
          renderPromocodes(promocodes);
          setTimeout(() => {
            promocodesMessage.textContent = '';
          }, 2000);
        } catch (err) {
          promocodesMessage.textContent = err.message;
          promocodesMessage.className = 'message error';
        }
      }
    });

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    promocodesSection.style.display = '';
    fetchPromocodes().then(renderPromocodes).catch(() => {});

    logoutBtn.addEventListener('click', async () => {
      await fetch(`${BASE_URL}/admin/logout`, {
        method: 'POST',
        credentials: 'include'
      });
      togglePanels(false);
      adminPanelMessage.textContent = '';
      adminLoginMessage.textContent = '–í—ã –≤—ã—à–ª–∏ –∏–∑ –ø–∞–Ω–µ–ª–∏.';
      adminLoginMessage.className = 'message';
    });

    init();
  </script>
</body>
</html>

