<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ê–¥–º–∏–Ω ¬∑ Infer Casino</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="admin-shell">
    <header class="glass-card top-bar">
      <div>
        <p class="eyebrow">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</p>
        <h1>–ê–¥–º–∏–Ω –º–µ–Ω—é</h1>
        <p class="muted">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏, –±–∞–ª–∞–Ω—Å–∞–º–∏ –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞–º–∏.</p>
      </div>
      <div class="link-row">
        <a href="index.html" class="muted">‚Üê –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ —Å–∞–π—Ç</a>
      </div>
    </header>

    <section class="glass-card auth-card" id="adminLoginSection">
      <div>
        <p class="eyebrow">–í—Ö–æ–¥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</p>
        <p class="muted">–î–∞–Ω–Ω—ã–µ –ª–æ–≥–∏–Ω–∞ –Ω–µ —Å–≤—è–∑–∞–Ω—ã —Å –æ–±—ã—á–Ω—ã–º–∏ –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏.</p>
      </div>
      <form id="adminLoginForm" class="form-grid">
        <input type="text" id="adminLogin" class="input-field" placeholder="–õ–æ–≥–∏–Ω" required />
        <input type="password" id="adminPassword" class="input-field" placeholder="–ü–∞—Ä–æ–ª—å" required />
        <button type="submit" class="btn-primary">–í–æ–π—Ç–∏ –≤ –ø–∞–Ω–µ–ª—å</button>
      </form>
      <p id="adminLoginMessage" class="message"></p>
    </section>

    <section class="glass-card" id="adminPanelSection" style="display:none">
      <div class="top-bar" style="gap:12px">
        <div>
          <p class="eyebrow">–°–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤</p>
          <p class="muted">–ò–∑–º–µ–Ω—è–π—Ç–µ –±–∞–ª–∞–Ω—Å –≤ –ø–∞—Ä—É –∫–ª–∏–∫–æ–≤. –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–∏—à—É—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –≤ users.json.</p>
        </div>
        <div class="admin-actions">
          <button id="downloadUsersBtn" class="btn-secondary" style="width:auto">üì• users.json</button>
          <button id="downloadHistoryBtn" class="btn-secondary" style="width:auto">üì• history.json</button>
          <button id="downloadDepositsBtn" class="btn-secondary" style="width:auto">üì• deposits.json</button>
          <button id="downloadPromocodesBtn" class="btn-secondary" style="width:auto">üì• promocodes.json</button>
          <button id="downloadPromoUsageBtn" class="btn-secondary" style="width:auto">üì• promo-usage.json</button>
          <button id="downloadYooPaymentsBtn" class="btn-secondary" style="width:auto">üì• yoomoney-payments.json</button>
          <button id="downloadWithdrawalsBtn" class="btn-secondary" style="width:auto">üì• withdrawals.json</button>
          <button id="refreshBtn" class="btn-secondary" style="width:auto">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
          <button id="adminLogoutBtn" class="btn-outline" style="width:auto">–í—ã–π—Ç–∏</button>
        </div>
      </div>

      <div class="notice">
        –í–Ω–∏–º–∞–Ω–∏–µ: –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –≤—Å—Ç—É–ø–∞—é—Ç –≤ —Å–∏–ª—É –º–≥–Ω–æ–≤–µ–Ω–Ω–æ. –í–≤–æ–¥–∏—Ç–µ —Ç–æ–ª—å–∫–æ —Ü–µ–ª—ã–µ –Ω–µ–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è.
      </div>

      <div class="table-wrapper" style="overflow-x:auto">
        <table class="admin-table">
          <thead>
            <tr>
              <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
              <th>–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å</th>
              <th>–°—Ç–∞—Ç—É—Å</th>
              <th>–ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å</th>
          <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
          <th>–ü—Ä–æ—Ñ–∏–ª—å</th>
            </tr>
          </thead>
          <tbody id="usersTable"></tbody>
        </table>
      </div>
      <p id="adminPanelMessage" class="message"></p>
    </section>

    <section class="glass-card" id="promocodesSection" style="display:none">
      <div class="top-bar" style="gap:12px">
        <div>
          <p class="eyebrow">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏</p>
          <p class="muted">–°–æ–∑–¥–∞–≤–∞–π—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã —Å –Ω–∞–≥—Ä–∞–¥–æ–π –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –∞–∫—Ç–∏–≤–∞—Ü–∏–π.</p>
        </div>
        <button id="refreshPromocodesBtn" class="btn-secondary" style="width:auto">–û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>

      <div class="form-grid" style="margin-bottom: 20px;">
        <h3>–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</h3>
        <input type="text" id="newPromocodeCode" class="input-field" placeholder="–ö–æ–¥ –ø—Ä–æ–º–æ–∫–æ–¥–∞" />
        <input type="number" id="newPromocodeReward" class="input-field" min="1" placeholder="–ù–∞–≥—Ä–∞–¥–∞ (üç¨)" />
        <input type="number" id="newPromocodeActivations" class="input-field" min="1" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–∞—Ü–∏–π" />
        <button id="createPromocodeBtn" class="btn-primary">–°–æ–∑–¥–∞—Ç—å</button>
        <p id="promocodeCreateMessage" class="message"></p>
      </div>

      <div class="table-wrapper" style="overflow-x:auto">
        <table class="admin-table">
          <thead>
            <tr>
              <th>–ö–æ–¥</th>
              <th>–ù–∞–≥—Ä–∞–¥–∞</th>
              <th>–ê–∫—Ç–∏–≤–∞—Ü–∏–π –æ—Å—Ç–∞–ª–æ—Å—å</th>
              <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
            </tr>
          </thead>
          <tbody id="promocodesTable"></tbody>
        </table>
      </div>
      <p id="promocodesMessage" class="message"></p>
    </section>

    <section class="glass-card" id="withdrawalsSection" style="display:none">
      <div class="top-bar" style="gap:12px">
        <div>
          <p class="eyebrow">–ó–∞—è–≤–∫–∏ –Ω–∞ –≤—ã–≤–æ–¥ (–°–ë–ü)</p>
          <p class="muted">–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –ø–µ—Ä–µ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º.</p>
        </div>
        <div class="admin-actions">
          <button id="refreshWithdrawalsBtn" class="btn-secondary" style="width:auto">–û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
      </div>
      <div class="table-wrapper" style="overflow-x:auto">
        <table class="admin-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
              <th>–°—É–º–º–∞</th>
              <th>–ë–∞–Ω–∫</th>
              <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
              <th>–°—Ç–∞—Ç—É—Å</th>
              <th>–î–∞—Ç–∞</th>
              <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
          </thead>
          <tbody id="withdrawalsTable"></tbody>
        </table>
      </div>
      <p id="withdrawalsMessage" class="message"></p>
    </section>

    <section class="glass-card" id="gameConfigSection" style="display:none">
      <div class="top-bar" style="gap:12px">
        <div>
          <p class="eyebrow">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π –∏–≥—Ä</p>
          <p class="muted">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∫–æ–º–∏—Å—Å–∏–∏ –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–≥—Ä –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –ø—Ä–∏–±—ã–ª–∏ –∫–∞–∑–∏–Ω–æ.</p>
        </div>
        <button id="refreshGameConfigBtn" class="btn-secondary" style="width:auto">–û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>

      <div class="form-grid" style="margin-top: 20px;">
        <h3>–ö–æ–º–∏—Å—Å–∏–∏ –∏–≥—Ä</h3>
        
        <label class="muted" for="coinflipMultiplier">–ö–æ–∏–Ω—Ñ–ª–∏–ø: –ú–Ω–æ–∂–∏—Ç–µ–ª—å –ø—Ä–∏ –ø–æ–±–µ–¥–µ</label>
        <input type="number" id="coinflipMultiplier" class="input-field" min="0.1" max="10" step="0.01" placeholder="1.95" />
        <p class="muted" style="font-size:0.85rem; margin-top:-8px;">–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: 2.00x (–±–µ–∑ –∫–æ–º–∏—Å—Å–∏–∏). –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: 1.95x</p>
        
        <label class="muted" for="diceCommissionPercent">–î–∞–π—Å: –ö–æ–º–∏—Å—Å–∏—è (%)</label>
        <input type="number" id="diceCommissionPercent" class="input-field" min="0" max="50" step="0.1" placeholder="2" />
        <p class="muted" style="font-size:0.85rem; margin-top:-8px;">–í—ã—á–∏—Ç–∞–µ—Ç—Å—è –∏–∑ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 2% –æ—Ç –∫—ç—Ñ)</p>
        
        <label class="muted" for="rouletteCommissionPercent">–†—É–ª–µ—Ç–∫–∞: –ö–æ–º–∏—Å—Å–∏—è –æ—Ç –±–∞–Ω–∫–∞ (%)</label>
        <input type="number" id="rouletteCommissionPercent" class="input-field" min="0" max="50" step="0.1" placeholder="3" />
        <p class="muted" style="font-size:0.85rem; margin-top:-8px;">–í—ã—á–∏—Ç–∞–µ—Ç—Å—è –∏–∑ –≤—ã–∏–≥—Ä—ã—à–∞ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è</p>
        
        <label class="muted" for="crashCommissionPercent">–ö—Ä–∞—à: –ö–æ–º–∏—Å—Å–∏—è (%)</label>
        <input type="number" id="crashCommissionPercent" class="input-field" min="0" max="50" step="0.1" placeholder="2" />
        <p class="muted" style="font-size:0.85rem; margin-top:-8px;">–í—ã—á–∏—Ç–∞–µ—Ç—Å—è –∏–∑ –≤—ã–∏–≥—Ä—ã—à–∞ –ø—Ä–∏ –≤—ã–≤–æ–¥–µ</p>
        
        <button id="saveGameConfigBtn" class="btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é</button>
        <p id="gameConfigMessage" class="message"></p>
      </div>

      <div class="form-grid" style="margin-top: 30px;">
        <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—Ä–∞—à–µ–º</h3>
        
        <label class="muted" for="nextCrashPoint">–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ä–∞—É–Ω–¥–∞</label>
        <input type="number" id="nextCrashPoint" class="input-field" min="1.01" step="0.01" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ" />
        <p class="muted" style="font-size:0.85rem; margin-top:-8px;">–ï—Å–ª–∏ –∑–∞–¥–∞–Ω–æ, —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥ –∫—Ä–∞—à–∞ –±—É–¥–µ—Ç —Å —ç—Ç–∏–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–º. –û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ.</p>
        
        <div style="display:flex; gap:10px;">
          <button id="setNextCrashPointBtn" class="btn-primary" style="width:auto">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
          <button id="clearNextCrashPointBtn" class="btn-secondary" style="width:auto">–°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>
        <p id="nextCrashPointMessage" class="message"></p>
      </div>
    </section>
  </div>

  <div id="userProfileModal" class="modal-overlay hidden">
    <div class="modal-content glass-card" style="max-width:720px">
      <button id="userProfileModalClose" class="modal-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
      <div id="userProfileBody">
        <h2>–ü—Ä–æ—Ñ–∏–ª—å –∏–≥—Ä–æ–∫–∞</h2>
        <div id="userProfileContent" class="history-list" style="max-height:60vh; overflow:auto"></div>
      </div>
    </div>
  </div>

  <script src="script/utils.js"></script>
  <script>
    const BASE_URL = 'https://infer.cfd';
    const adminLoginSection = document.getElementById('adminLoginSection');
    const adminPanelSection = document.getElementById('adminPanelSection');
    const adminLoginForm = document.getElementById('adminLoginForm');
    const adminLoginMessage = document.getElementById('adminLoginMessage');
    const adminPanelMessage = document.getElementById('adminPanelMessage');
    const usersTable = document.getElementById('usersTable');
    const refreshBtn = document.getElementById('refreshBtn');
    const logoutBtn = document.getElementById('adminLogoutBtn');
    const promocodesSection = document.getElementById('promocodesSection');
    const promocodesTable = document.getElementById('promocodesTable');
    const newPromocodeCode = document.getElementById('newPromocodeCode');
    const newPromocodeReward = document.getElementById('newPromocodeReward');
    const newPromocodeActivations = document.getElementById('newPromocodeActivations');
    const createPromocodeBtn = document.getElementById('createPromocodeBtn');
    const promocodeCreateMessage = document.getElementById('promocodeCreateMessage');
    const promocodesMessage = document.getElementById('promocodesMessage');
    const refreshPromocodesBtn = document.getElementById('refreshPromocodesBtn');
    const withdrawalsSection = document.getElementById('withdrawalsSection');
    const withdrawalsTable = document.getElementById('withdrawalsTable');
    const withdrawalsMessage = document.getElementById('withdrawalsMessage');
    const refreshWithdrawalsBtn = document.getElementById('refreshWithdrawalsBtn');
    const userProfileModal = document.getElementById('userProfileModal');
    const userProfileContent = document.getElementById('userProfileContent');
    const userProfileModalClose = document.getElementById('userProfileModalClose');
    const gameConfigSection = document.getElementById('gameConfigSection');
    const coinflipMultiplier = document.getElementById('coinflipMultiplier');
    const diceCommissionPercent = document.getElementById('diceCommissionPercent');
    const rouletteCommissionPercent = document.getElementById('rouletteCommissionPercent');
    const crashCommissionPercent = document.getElementById('crashCommissionPercent');
    const saveGameConfigBtn = document.getElementById('saveGameConfigBtn');
    const refreshGameConfigBtn = document.getElementById('refreshGameConfigBtn');
    const gameConfigMessage = document.getElementById('gameConfigMessage');
    const nextCrashPoint = document.getElementById('nextCrashPoint');
    const setNextCrashPointBtn = document.getElementById('setNextCrashPointBtn');
    const clearNextCrashPointBtn = document.getElementById('clearNextCrashPointBtn');
    const nextCrashPointMessage = document.getElementById('nextCrashPointMessage');

    async function downloadAdminFile(endpoint, filename) {
      try {
        const resp = await fetch(`${BASE_URL}${endpoint}`, { credentials: 'include' });
        if (!resp.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª');
        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      } catch (err) {
        adminPanelMessage.textContent = err.message;
        adminPanelMessage.className = 'message error';
      }
    }

    async function fetchUsers() {
      const resp = await fetch(`${BASE_URL}/admin/users`, { credentials: 'include' });
      if (!resp.ok) {
        throw new Error('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞');
      }
      return resp.json();
    }

    function renderUsers(users) {
      usersTable.innerHTML = '';
      users.forEach(({ username, balance, banned }) => {
        const tr = document.createElement('tr');
        const isBanned = banned === true;
        tr.innerHTML = `
          <td>${username}</td>
          <td>${formatCandy(balance)}</td>
          <td>
            <button class="btn-${isBanned ? 'primary' : 'outline'}" data-username="${username}" data-action="toggle-ban" style="width:auto; font-size:0.85rem">
              ${isBanned ? 'üîì –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : 'üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å'}
            </button>
          </td>
          <td><input type="number" min="0" class="input-field" value="${balance}" data-username="${username}" /></td>
          <td><button class="btn-primary" data-username="${username}" data-action="save-balance">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></td>
          <td><button class="btn-secondary" data-username="${username}" data-action="view-profile">–ü—Ä–æ—Ñ–∏–ª—å</button></td>
        `;
        usersTable.appendChild(tr);
      });
    }

    function togglePanels(isAdmin) {
      adminLoginSection.style.display = isAdmin ? 'none' : '';
      adminPanelSection.style.display = isAdmin ? '' : 'none';
    }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    async function initPromocodes() {
      try {
        const promocodes = await fetchPromocodes();
        renderPromocodes(promocodes);
        promocodesSection.style.display = '';
      } catch (err) {
        promocodesSection.style.display = 'none';
      }
    }

    async function initWithdrawals() {
      try {
        const list = await fetchWithdrawals();
        renderWithdrawals(list);
        withdrawalsSection.style.display = '';
      } catch (err) {
        console.warn('Withdrawals unavailable:', err.message);
        withdrawalsSection.style.display = 'none';
      }
    }

    async function initGameConfig() {
      try {
        await loadGameConfig();
        gameConfigSection.style.display = '';
        await loadNextCrashPoint();
      } catch (err) {
        console.warn('Game config unavailable:', err.message);
        gameConfigSection.style.display = 'none';
      }
    }

    async function loadGameConfig() {
      try {
        const resp = await fetch(`${BASE_URL}/admin/game-config`, { credentials: 'include' });
        if (!resp.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é');
        const config = await resp.json();
        coinflipMultiplier.value = config.coinflipMultiplier || 1.95;
        diceCommissionPercent.value = config.diceCommissionPercent || 2;
        rouletteCommissionPercent.value = config.rouletteCommissionPercent || 3;
        crashCommissionPercent.value = config.crashCommissionPercent || 2;
      } catch (err) {
        gameConfigMessage.textContent = err.message;
        gameConfigMessage.className = 'message error';
      }
    }

    async function saveGameConfig() {
      try {
        saveGameConfigBtn.disabled = true;
        gameConfigMessage.textContent = '';
        const config = {
          coinflipMultiplier: Number(coinflipMultiplier.value),
          diceCommissionPercent: Number(diceCommissionPercent.value),
          rouletteCommissionPercent: Number(rouletteCommissionPercent.value),
          crashCommissionPercent: Number(crashCommissionPercent.value)
        };
        const resp = await fetch(`${BASE_URL}/admin/game-config`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(config)
        });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
        gameConfigMessage.textContent = '–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!';
        gameConfigMessage.className = 'message success';
        setTimeout(() => {
          gameConfigMessage.textContent = '';
        }, 2000);
      } catch (err) {
        gameConfigMessage.textContent = err.message;
        gameConfigMessage.className = 'message error';
      } finally {
        saveGameConfigBtn.disabled = false;
      }
    }

    async function loadNextCrashPoint() {
      try {
        const resp = await fetch(`${BASE_URL}/admin/crash/next-point`, { credentials: 'include' });
        if (!resp.ok) return;
        const data = await resp.json();
        if (data.nextCrashPoint) {
          nextCrashPoint.value = data.nextCrashPoint;
        } else {
          nextCrashPoint.value = '';
        }
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞ –∫—Ä–∞—à–∞:', err);
      }
    }

    async function setNextCrashPoint() {
      try {
        setNextCrashPointBtn.disabled = true;
        nextCrashPointMessage.textContent = '';
        const value = nextCrashPoint.value.trim();
        const crashPoint = value ? Number(value) : null;
        const resp = await fetch(`${BASE_URL}/admin/crash/next-point`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ crashPoint })
        });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏');
        nextCrashPointMessage.textContent = data.message || '–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
        nextCrashPointMessage.className = 'message success';
        setTimeout(() => {
          nextCrashPointMessage.textContent = '';
        }, 3000);
      } catch (err) {
        nextCrashPointMessage.textContent = err.message;
        nextCrashPointMessage.className = 'message error';
      } finally {
        setNextCrashPointBtn.disabled = false;
      }
    }

    async function clearNextCrashPoint() {
      try {
        clearNextCrashPointBtn.disabled = true;
        nextCrashPointMessage.textContent = '';
        const resp = await fetch(`${BASE_URL}/admin/crash/next-point`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ crashPoint: null })
        });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞');
        nextCrashPoint.value = '';
        nextCrashPointMessage.textContent = data.message || '–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Å–±—Ä–æ—à–µ–Ω';
        nextCrashPointMessage.className = 'message success';
        setTimeout(() => {
          nextCrashPointMessage.textContent = '';
        }, 3000);
      } catch (err) {
        nextCrashPointMessage.textContent = err.message;
        nextCrashPointMessage.className = 'message error';
      } finally {
        clearNextCrashPointBtn.disabled = false;
      }
    }

    async function init() {
      try {
        const users = await fetchUsers();
        renderUsers(users);
        togglePanels(true);
        initPromocodes();
        initWithdrawals();
        initGameConfig();
      } catch (err) {
        console.warn('Admin auth check failed:', err.message);
        togglePanels(false);
        promocodesSection.style.display = 'none';
        withdrawalsSection.style.display = 'none';
      }
    }

    adminLoginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      adminLoginMessage.textContent = '';
      const login = document.getElementById('adminLogin').value.trim();
      const password = document.getElementById('adminPassword').value.trim();
      try {
        const resp = await fetch(`${BASE_URL}/admin/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ login, password })
        });
        const data = await resp.json();
        if (!resp.ok) {
          throw new Error(data.error || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞');
        }
        adminLoginMessage.textContent = data.message;
        adminLoginMessage.className = 'message success';
        const users = await fetchUsers();
        renderUsers(users);
        togglePanels(true);
        initPromocodes();
        initWithdrawals();
        initGameConfig();
      } catch (err) {
        adminLoginMessage.textContent = err.message;
        adminLoginMessage.className = 'message error';
      }
    });

    refreshBtn.addEventListener('click', async () => {
      adminPanelMessage.textContent = '';
      try {
        const users = await fetchUsers();
        renderUsers(users);
        adminPanelMessage.textContent = '–°–ø–∏—Å–æ–∫ –æ–±–Ω–æ–≤–ª—ë–Ω.';
        adminPanelMessage.className = 'message success';
      } catch (err) {
        adminPanelMessage.textContent = err.message;
        adminPanelMessage.className = 'message error';
      }
    });

    usersTable.addEventListener('click', async (e) => {
      if (e.target.tagName !== 'BUTTON') return;
      const username = e.target.getAttribute('data-username');
      const action = e.target.getAttribute('data-action');
      
      if (action === 'toggle-ban') {
        try {
          const resp = await fetch(`${BASE_URL}/admin/users/${encodeURIComponent(username)}/ban`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include'
          });
          const data = await resp.json();
          if (!resp.ok) {
            throw new Error(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å');
          }
          adminPanelMessage.textContent = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${username} ${data.banned ? '–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' : '—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'}`;
          adminPanelMessage.className = 'message success';
          const users = await fetchUsers();
          renderUsers(users);
        } catch (err) {
          adminPanelMessage.textContent = err.message;
          adminPanelMessage.className = 'message error';
        }
        return;
      }
      
      if (action === 'save-balance') {
        const input = usersTable.querySelector(`input[data-username="${username}"]`);
        const balanceValue = Number(input.value);
        if (!Number.isFinite(balanceValue) || balanceValue < 0) {
          adminPanelMessage.textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –±–∞–ª–∞–Ω—Å.';
          adminPanelMessage.className = 'message error';
          return;
        }
        try {
          const resp = await fetch(`${BASE_URL}/admin/users/${encodeURIComponent(username)}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ balance: balanceValue })
          });
          const data = await resp.json();
          if (!resp.ok) {
            throw new Error(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å');
          }
          adminPanelMessage.textContent = `–ë–∞–ª–∞–Ω—Å ${data.username} –æ–±–Ω–æ–≤–ª—ë–Ω: ${formatCandy(data.balance)}`;
          adminPanelMessage.className = 'message success';
          input.value = data.balance;
          input.parentElement.previousElementSibling.previousElementSibling.textContent = `${formatCandy(data.balance)}`;
          const users = await fetchUsers();
          renderUsers(users);
        } catch (err) {
          adminPanelMessage.textContent = err.message;
          adminPanelMessage.className = 'message error';
        }
      }

      if (action === 'view-profile') {
        openUserProfile(username);
        return;
      }
    });
    
    document.getElementById('downloadUsersBtn').addEventListener('click', () =>
      downloadAdminFile('/admin/download/users.json', 'users.json')
    );
    document.getElementById('downloadHistoryBtn').addEventListener('click', () =>
      downloadAdminFile('/admin/download/history.json', 'history.json')
    );
    document.getElementById('downloadDepositsBtn').addEventListener('click', () =>
      downloadAdminFile('/admin/download/deposits.json', 'deposits.json')
    );
    document.getElementById('downloadPromocodesBtn').addEventListener('click', () =>
      downloadAdminFile('/admin/download/promocodes.json', 'promocodes.json')
    );
    document.getElementById('downloadPromoUsageBtn').addEventListener('click', () =>
      downloadAdminFile('/admin/download/promocode-usage.json', 'promocode-usage.json')
    );
    document.getElementById('downloadYooPaymentsBtn').addEventListener('click', () =>
      downloadAdminFile('/admin/download/yoomoney-payments.json', 'yoomoney-payments.json')
    );
    document.getElementById('downloadWithdrawalsBtn').addEventListener('click', () =>
      downloadAdminFile('/admin/download/withdrawals.json', 'withdrawals.json')
    );

    // –ü—Ä–æ–º–æ–∫–æ–¥—ã
    async function fetchPromocodes() {
      const resp = await fetch(`${BASE_URL}/admin/promocodes`, { credentials: 'include' });
      if (!resp.ok) throw new Error('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞');
      return resp.json();
    }

    async function fetchWithdrawals() {
      const resp = await fetch(`${BASE_URL}/admin/withdrawals`, { credentials: 'include' });
      if (!resp.ok) throw new Error('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞');
      return resp.json();
    }

    function renderPromocodes(promocodes) {
      promocodesTable.innerHTML = '';
      if (!promocodes.length) {
        promocodesTable.innerHTML = '<tr><td colspan="4" class="muted">–ù–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤</td></tr>';
        return;
      }
      promocodes.forEach((p) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.code}</td>
          <td>${formatCandy(p.reward)}</td>
          <td>${p.activationsLeft}</td>
          <td><button class="btn-danger" data-code="${p.code}" data-action="delete-promocode" style="width:auto; font-size:0.85rem">–£–¥–∞–ª–∏—Ç—å</button></td>
        `;
        promocodesTable.appendChild(tr);
      });
    }

    function renderWithdrawals(list) {
      withdrawalsTable.innerHTML = '';
      if (!list.length) {
        withdrawalsTable.innerHTML = '<tr><td colspan="8" class="muted">–ó–∞—è–≤–æ–∫ –Ω–µ—Ç</td></tr>';
        return;
      }
      list
        .slice()
        .sort((a, b) => b.createdAt - a.createdAt)
        .forEach((w) => {
          const tr = document.createElement('tr');
          const statusLabel = w.status === 'pending'
            ? 'üü° –û–∂–∏–¥–∞–µ—Ç'
            : w.status === 'completed'
              ? 'üü¢ –í—ã–ø–ª–∞—á–µ–Ω–æ'
              : w.status === 'cancelled'
                ? '‚ö™ –û—Ç–º–µ–Ω–µ–Ω–æ'
                : w.status === 'processing'
                  ? 'üîÑ –í—ã–ø–ª–∞—Ç–∞...'
                  : 'üî¥ –û—à–∏–±–∫–∞';
          const actions =
            w.status === 'pending'
              ? `<button class="btn-primary" data-id="${w.id}" data-action="process-withdraw" style="width:auto">–í—ã–ø–ª–∞—Ç–∏—Ç—å</button>
                 <button class="btn-outline" data-id="${w.id}" data-action="cancel-withdraw" style="width:auto">–û—Ç–º–µ–Ω–∏—Ç—å</button>`
              : '';
          tr.innerHTML = `
            <td>${w.id}</td>
            <td>${w.username}</td>
            <td>${w.amount}‚ÇΩ</td>
            <td>${w.bankName || '‚Äî'}</td>
            <td>${w.phone || '‚Äî'}</td>
            <td>${statusLabel}</td>
            <td>${new Date(w.updatedAt || w.completedAt || w.cancelledAt || w.createdAt).toLocaleString('ru-RU')}</td>
            <td>${actions || '-'}</td>
          `;
          withdrawalsTable.appendChild(tr);
        });
    }

    function renderSimpleList(items, formatter, emptyText) {
      if (!items || !items.length) {
        return `<div class="muted">${emptyText}</div>`;
      }
      return `<ul class="history-sublist">
        ${items.map(formatter).join('')}
      </ul>`;
    }

    function renderUserProfileModal(data) {
      const { user, deposits, yoomoneyPayments, withdrawals, games, promocodes } = data;
      const formatDate = (ts) => new Date(ts).toLocaleString('ru-RU');
      const formatTime = (ts) => new Date(ts).toLocaleTimeString('ru-RU');
      
      const renderGameHistory = (gameName, gameData, formatter) => {
        if (!gameData || !gameData.length) {
          return `<div class="history-item muted">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>`;
        }
        return gameData.slice(-20).reverse().map(formatter).join('');
      };
      
      userProfileContent.innerHTML = `
        <div class="history-item"><strong>${user.username}</strong> ¬∑ –±–∞–ª–∞–Ω—Å ${formatCandy(user.balance)} ${user.banned ? '(–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω)' : ''}<br/>IP: ${user.ip || '‚Äî'}</div>
        
        <h3>–ü–æ–ø–æ–ª–Ω–µ–Ω–∏—è</h3>
        ${renderSimpleList(
          deposits.slice(-10).reverse(),
          (d) => `<li>${formatDate(d.timestamp)} ¬∑ ${formatSignedCandy(d.amount)} (${d.method || 'free'})</li>`,
          '–ù–µ—Ç –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–π'
        )}
        
        <h3>YooMoney –ø–ª–∞—Ç–µ–∂–∏</h3>
        ${renderSimpleList(
          yoomoneyPayments.slice(-10).reverse(),
          (p) => `<li>${formatDate(p.createdAt)} ¬∑ ${p.amount}‚ÇΩ (${p.status})</li>`,
          '–ù–µ—Ç –ø–ª–∞—Ç–µ–∂–µ–π YooMoney'
        )}
        
        <h3>–í—ã–≤–æ–¥—ã (–°–ë–ü)</h3>
        ${renderSimpleList(
          withdrawals.slice(-10).reverse(),
          (w) => `<li>${formatDate(w.createdAt)} ¬∑ ${w.amount}‚ÇΩ ‚Üí ${w.status}</li>`,
          '–ó–∞—è–≤–æ–∫ –Ω–∞ –≤—ã–≤–æ–¥ –Ω–µ—Ç'
        )}
        
        <h3>–ü—Ä–æ–º–æ–∫–æ–¥—ã (${promocodes?.length || 0})</h3>
        ${renderSimpleList(
          promocodes || [],
          (p) => `<li>${p.code}${p.activatedAt ? ` ¬∑ ${formatDate(p.activatedAt)}` : ''}</li>`,
          '–ü—Ä–æ–º–æ–∫–æ–¥—ã –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å'
        )}
        
        <h3>–ö—Ä–∞—à (${games.crash?.length || 0})</h3>
        ${renderGameHistory('–ö—Ä–∞—à', games.crash, (round) => {
          const player = round.players?.find(p => p.username === user.username);
          if (!player) return '';
          const status = player.cashedOut 
            ? `–∑–∞–±—Ä–∞–ª x${player.cashoutCoef?.toFixed(2) || '‚Äî'} ‚Üí ${player.winnings}üç¨`
            : '–ø—Ä–æ–∏–≥—Ä–∞–ª';
          return `<div class="history-item">${formatTime(round.timestamp)} ¬∑ —Å—Ç–∞–≤–∫–∞ ${formatCandy(player.bet)} ¬∑ ${status} ¬∑ –∫—Ä–∞—à x${round.crashPoint?.toFixed(2) || '‚Äî'}</div>`;
        })}
        
        <h3>–†—É–ª–µ—Ç–∫–∞ (${games.roulette?.length || 0})</h3>
        ${renderGameHistory('–†—É–ª–µ—Ç–∫–∞', games.roulette, (round) => {
          const player = round.players?.find(p => p.username === user.username);
          if (!player) return '';
          const won = round.winner === user.username;
          return `<div class="history-item">${formatTime(round.timestamp)} ¬∑ —Å—Ç–∞–≤–∫–∞ ${formatCandy(player.bet)} ¬∑ ${won ? `üèÜ –ü–æ–±–µ–¥–∞ (–±–∞–Ω–∫ ${formatCandy(round.totalBet)})` : '–ø—Ä–æ–∏–≥—Ä—ã—à'}</div>`;
        })}
        
        <h3>–ö–æ–∏–Ω—Ñ–ª–∏–ø (${games.coinflip?.length || 0})</h3>
        ${renderGameHistory('–ö–æ–∏–Ω—Ñ–ª–∏–ø', games.coinflip, (entry) => {
          const side = entry.choice === 'tails' ? '—Ä–µ—à–∫–∞' : '–æ—Ä—ë–ª';
          const result = entry.result === 'tails' ? '—Ä–µ—à–∫–∞' : '–æ—Ä—ë–ª';
          const won = entry.win;
          return `<div class="history-item">${formatTime(entry.timestamp)} ¬∑ —Å—Ç–∞–≤–∫–∞ ${formatCandy(entry.bet)} ¬∑ –≤—ã–±—Ä–∞–ª ${side}, –≤—ã–ø–∞–ª ${result} ¬∑ ${won ? 'üèÜ –ü–æ–±–µ–¥–∞' : '–ø—Ä–æ–∏–≥—Ä—ã—à'}</div>`;
        })}
        
        <h3>–î–∞–π—Å (${games.dice?.length || 0})</h3>
        ${renderGameHistory('–î–∞–π—Å', games.dice, (entry) => {
          const side = entry.side === 'less' ? '–ú–µ–Ω—å—à–µ' : '–ë–æ–ª—å—à–µ';
          const won = entry.win;
          return `<div class="history-item">${formatTime(entry.timestamp)} ¬∑ —Å—Ç–∞–≤–∫–∞ ${formatCandy(entry.bet)} ¬∑ ${side} ${entry.percent}% ¬∑ –≤—ã–ø–∞–ª–æ ${entry.roll} ¬∑ ${won ? 'üèÜ –ü–æ–±–µ–¥–∞' : '–ø—Ä–æ–∏–≥—Ä—ã—à'}</div>`;
        })}
        
        <h3>–ü–ª–∏–Ω–∫–æ (${games.plinko?.length || 0})</h3>
        ${renderGameHistory('–ü–ª–∏–Ω–∫–æ', games.plinko, (entry) => {
          const risk = entry.risk === 'low' ? '–Ω–∏–∑–∫–∏–π' : entry.risk === 'high' ? '–≤—ã—Å–æ–∫–∏–π' : '—Å—Ä–µ–¥–Ω–∏–π';
          const net = (entry.payout || 0) - (entry.bet || 0);
          return `<div class="history-item">${formatTime(entry.timestamp)} ¬∑ —Å—Ç–∞–≤–∫–∞ ${formatCandy(entry.bet)} ¬∑ —Ä–∏—Å–∫ ${risk} ¬∑ ${entry.rows} —Ä—è–¥–æ–≤ ¬∑ x${entry.multiplier?.toFixed(2) || '‚Äî'} ‚Üí ${formatSignedCandy(net)}</div>`;
        })}
      `;
      userProfileModal.classList.remove('hidden');
    }

    function closeUserProfileModal() {
      userProfileModal.classList.add('hidden');
    }

    async function openUserProfile(username) {
      try {
        const resp = await fetch(`${BASE_URL}/admin/users/${encodeURIComponent(username)}/profile`, {
          credentials: 'include'
        });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å');
        renderUserProfileModal(data);
      } catch (err) {
        adminPanelMessage.textContent = err.message;
        adminPanelMessage.className = 'message error';
      }
    }

    async function refreshWithdrawals() {
      try {
        const list = await fetchWithdrawals();
        renderWithdrawals(list);
        withdrawalsMessage.textContent = '–ó–∞—è–≤–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã';
        withdrawalsMessage.className = 'message success';
        setTimeout(() => (withdrawalsMessage.textContent = ''), 2000);
      } catch (err) {
        withdrawalsMessage.textContent = err.message;
        withdrawalsMessage.className = 'message error';
      }
    }

    refreshWithdrawalsBtn.addEventListener('click', refreshWithdrawals);

    withdrawalsTable.addEventListener('click', async (e) => {
      if (e.target.tagName !== 'BUTTON') return;
      const action = e.target.getAttribute('data-action');
      const id = e.target.getAttribute('data-id');
      if (!action || !id) return;
      try {
        if (action === 'process-withdraw') {
          if (!confirm(`–í—ã–ø–ª–∞—Ç–∏—Ç—å –∑–∞—è–≤–∫—É ${id}?`)) return;
          const resp = await fetch(`${BASE_URL}/admin/withdrawals/${encodeURIComponent(id)}/process`, {
            method: 'POST',
            credentials: 'include'
          });
          const data = await resp.json();
          if (!resp.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ –≤—ã–ø–ª–∞—Ç—ã');
        }
        if (action === 'cancel-withdraw') {
          if (!confirm(`–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É ${id} –∏ –≤–µ—Ä–Ω—É—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞?`)) return;
          const resp = await fetch(`${BASE_URL}/admin/withdrawals/${encodeURIComponent(id)}/cancel`, {
            method: 'POST',
            credentials: 'include'
          });
          const data = await resp.json();
          if (!resp.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã');
        }
        refreshWithdrawals();
      } catch (err) {
        withdrawalsMessage.textContent = err.message;
        withdrawalsMessage.className = 'message error';
      }
    });

    userProfileModalClose.addEventListener('click', closeUserProfileModal);
    userProfileModal.addEventListener('click', (e) => {
      if (e.target === userProfileModal) closeUserProfileModal();
    });

    createPromocodeBtn.addEventListener('click', async () => {
      const code = newPromocodeCode.value.trim();
      const reward = Number(newPromocodeReward.value);
      const activations = Number(newPromocodeActivations.value);
      
      if (!code) {
        promocodeCreateMessage.textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥';
        promocodeCreateMessage.className = 'message error';
        return;
      }
      if (!reward || reward < 1) {
        promocodeCreateMessage.textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –Ω–∞–≥—Ä–∞–¥—É';
        promocodeCreateMessage.className = 'message error';
        return;
      }
      if (!activations || activations < 1) {
        promocodeCreateMessage.textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–∞—Ü–∏–π';
        promocodeCreateMessage.className = 'message error';
        return;
      }

      try {
        createPromocodeBtn.disabled = true;
        const resp = await fetch(`${BASE_URL}/admin/promocodes`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ code, reward, activations })
        });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è');
        promocodeCreateMessage.textContent = '–ü—Ä–æ–º–æ–∫–æ–¥ —Å–æ–∑–¥–∞–Ω!';
        promocodeCreateMessage.className = 'message success';
        newPromocodeCode.value = '';
        newPromocodeReward.value = '';
        newPromocodeActivations.value = '';
        const promocodes = await fetchPromocodes();
        renderPromocodes(promocodes);
        setTimeout(() => {
          promocodeCreateMessage.textContent = '';
        }, 2000);
      } catch (err) {
        promocodeCreateMessage.textContent = err.message;
        promocodeCreateMessage.className = 'message error';
      } finally {
        createPromocodeBtn.disabled = false;
      }
    });

    refreshPromocodesBtn.addEventListener('click', async () => {
      try {
        const promocodes = await fetchPromocodes();
        renderPromocodes(promocodes);
        promocodesMessage.textContent = '–°–ø–∏—Å–æ–∫ –æ–±–Ω–æ–≤–ª—ë–Ω';
        promocodesMessage.className = 'message success';
        setTimeout(() => {
          promocodesMessage.textContent = '';
        }, 2000);
      } catch (err) {
        promocodesMessage.textContent = err.message;
        promocodesMessage.className = 'message error';
      }
    });

    promocodesTable.addEventListener('click', async (e) => {
      if (e.target.tagName !== 'BUTTON') return;
      const code = e.target.getAttribute('data-code');
      const action = e.target.getAttribute('data-action');
      
      if (action === 'delete-promocode') {
        if (!confirm(`–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥ "${code}"?`)) return;
        try {
          const resp = await fetch(`${BASE_URL}/admin/promocodes/${encodeURIComponent(code)}`, {
            method: 'DELETE',
            credentials: 'include'
          });
          const data = await resp.json();
          if (!resp.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
          promocodesMessage.textContent = '–ü—Ä–æ–º–æ–∫–æ–¥ —É–¥–∞–ª—ë–Ω';
          promocodesMessage.className = 'message success';
          const promocodes = await fetchPromocodes();
          renderPromocodes(promocodes);
          setTimeout(() => {
            promocodesMessage.textContent = '';
          }, 2000);
        } catch (err) {
          promocodesMessage.textContent = err.message;
          promocodesMessage.className = 'message error';
        }
      }
    });


    logoutBtn.addEventListener('click', async () => {
      await fetch(`${BASE_URL}/admin/logout`, {
        method: 'POST',
        credentials: 'include'
      });
      togglePanels(false);
      adminPanelMessage.textContent = '';
      adminLoginMessage.textContent = '–í—ã –≤—ã—à–ª–∏ –∏–∑ –ø–∞–Ω–µ–ª–∏.';
      adminLoginMessage.className = 'message';
    });

    saveGameConfigBtn.addEventListener('click', saveGameConfig);
    refreshGameConfigBtn.addEventListener('click', loadGameConfig);
    setNextCrashPointBtn.addEventListener('click', setNextCrashPoint);
    clearNextCrashPointBtn.addEventListener('click', clearNextCrashPoint);

    init();
  </script>
</body>
</html>

