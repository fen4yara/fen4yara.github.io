<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–î–∞–π—Å ¬∑ 320xbet</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="game-page">
    <header class="glass-card top-bar">
      <div>
        <p class="eyebrow">–†–µ–∂–∏–º</p>
        <h1>üé≤ Neon Dice</h1>
        <p class="muted">–í—ã–±–µ—Ä–∏ —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 6, –±—Ä–æ—Å—å –∫—É–±–∏–∫ –∏ –ø–æ–ª—É—á–∏ –¥–æ √ó6 –æ—Ç —Å—Ç–∞–≤–∫–∏.</p>
      </div>
      <button class="btn-outline" onclick="window.location.href='mainPage.html'">‚¨Ö –ù–∞–∑–∞–¥</button>
    </header>

    <section class="glass-card">
      <div class="balance-pill">
        –ë–∞–ª–∞–Ω—Å: <span id="diceBalance">...</span> üç¨
      </div>

      <div>
        <p class="muted">–¢–≤–æ—ë —á–∏—Å–ª–æ</p>
        <div class="dice-grid" id="diceGrid">
          <button class="btn-secondary dice-btn active" data-number="1">1</button>
          <button class="btn-secondary dice-btn" data-number="2">2</button>
          <button class="btn-secondary dice-btn" data-number="3">3</button>
          <button class="btn-secondary dice-btn" data-number="4">4</button>
          <button class="btn-secondary dice-btn" data-number="5">5</button>
          <button class="btn-secondary dice-btn" data-number="6">6</button>
        </div>
      </div>

      <label for="diceBet" class="muted">–°—Ç–∞–≤–∫–∞</label>
      <input type="number" id="diceBet" min="1" class="input-field" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É" />

      <button id="diceRollBtn" class="btn-primary">–ë—Ä–æ—Å–∏—Ç—å –∫—É–±–∏–∫</button>
      <p id="diceStatus" class="message"></p>
    </section>

    <section class="glass-card history-card">
      <p class="eyebrow">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –±—Ä–æ—Å–∫–∏</p>
      <div id="diceHistoryList" class="history-list"></div>
    </section>
  </div>

  <script>
    const BASE_URL = 'https://fen4yaragithubio-production.up.railway.app';
    let user = null;
    let selectedNumber = 1;

    const balanceEl = document.getElementById('diceBalance');
    const betInput = document.getElementById('diceBet');
    const statusEl = document.getElementById('diceStatus');
    const historyList = document.getElementById('diceHistoryList');
    const rollBtn = document.getElementById('diceRollBtn');
    const diceButtons = document.querySelectorAll('.dice-btn');

    diceButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        selectedNumber = Number(btn.dataset.number);
        diceButtons.forEach((b) => b.classList.remove('active'));
        btn.classList.add('active');
      });
    });

    async function init() {
      try {
        const resp = await fetch(`${BASE_URL}/check-auth`, { credentials: 'include' });
        if (!resp.ok) throw new Error('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
        user = await resp.json();
        balanceEl.textContent = user.balance;
        await loadHistory();
      } catch (err) {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç');
        window.location.href = 'index.html';
      }
    }

    async function rollDice() {
      const bet = Number(betInput.value);
      if (!bet || bet <= 0) {
        statusEl.textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—Ç–∞–≤–∫—É';
        statusEl.className = 'message error';
        return;
      }

      try {
        rollBtn.disabled = true;
        statusEl.textContent = '';
        const resp = await fetch(`${BASE_URL}/dice/play`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ bet, guess: selectedNumber })
        });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å—Ç–∞–≤–∫–∏');
        balanceEl.textContent = data.newBalance;
        statusEl.textContent = data.win
          ? `üéâ –í—ã–ø–∞–ª–æ ${data.roll}. –ü–æ–±–µ–¥–∞! –í—ã–∏–≥—Ä—ã—à: ${data.payout}üç¨`
          : `üôÖ –í—ã–ø–∞–ª–æ ${data.roll}. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë`;
        statusEl.className = `message ${data.win ? 'success' : 'error'}`;
        betInput.value = '';
        await loadHistory(data.history);
      } catch (err) {
        statusEl.textContent = err.message;
        statusEl.className = 'message error';
      } finally {
        rollBtn.disabled = false;
      }
    }

    async function loadHistory(prefetched) {
      try {
        const data =
          prefetched ||
          (await fetch(`${BASE_URL}/dice/history`, { credentials: 'include' }).then((r) => r.json()));
        renderHistory(Array.isArray(data) ? data : []);
      } catch (err) {
        console.error('dice history error', err);
      }
    }

    function renderHistory(entries) {
      historyList.innerHTML = '';
      if (!entries.length) {
        historyList.innerHTML = '<div class="history-item muted">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';
        return;
      }
      entries.forEach((entry) => {
        const item = document.createElement('div');
        item.className = 'history-item';
        if (user && entry.username === user.username) {
          item.classList.add('highlight');
        }
        const date = new Date(entry.timestamp).toLocaleString('ru-RU');
        const outcome = entry.win ? '‚Üí –ü–æ–±–µ–¥–∞' : '‚Üí –ü–æ—Ä–∞–∂–µ–Ω–∏–µ';
        item.innerHTML = `<strong>${date}</strong> ‚Äî ${entry.username} –≤—ã–±—Ä–∞–ª ${entry.guess}, –≤—ã–ø–∞–ª–æ ${entry.roll} ${outcome} (${entry.bet}üç¨)`;
        historyList.appendChild(item);
      });
    }

    rollBtn.addEventListener('click', rollDice);
    init();
  </script>
</body>
</html>

