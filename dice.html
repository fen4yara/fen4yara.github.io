<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–î–∞–π—Å ¬∑ 320xbet</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="game-page">
    <header class="glass-card top-bar">
      <div>
        <p class="eyebrow">–†–µ–∂–∏–º</p>
        <h1>üé≤ –î–∞–π—Å</h1>
        <p class="muted">–í—ã–±–µ—Ä–∏ –ø—Ä–æ—Ü–µ–Ω—Ç –∏ —Å—Ç–æ—Ä–æ–Ω—É, —Å—Ç–∞–≤—å –Ω–∞ –º–µ–Ω—å—à–µ –∏–ª–∏ –±–æ–ª—å—à–µ.</p>
      </div>
      <button class="btn-outline" onclick="window.location.href='mainPage.html'">‚¨Ö –ù–∞–∑–∞–¥</button>
    </header>

    <section class="glass-card">
      <div class="balance-pill">
        –ë–∞–ª–∞–Ω—Å: <span id="diceBalance">...</span> üç¨
      </div>

      <div>
        <p class="muted">–°—É–º–º–∞</p>
        <input type="number" id="diceBet" min="1" class="input-field" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É" />
        <div class="quick-bet-buttons">
          <button class="btn-secondary quick-btn" data-action="double">–£–¥–≤–æ–∏—Ç—å</button>
          <button class="btn-secondary quick-btn" data-action="half">–ü–æ–ª–æ–≤–∏–Ω–∞</button>
          <button class="btn-secondary quick-btn" data-action="max">–ú–∞–∫—Å</button>
          <button class="btn-secondary quick-btn" data-action="min">–ú–∏–Ω</button>
        </div>
      </div>

      <div>
        <p class="muted">–ü—Ä–æ—Ü–µ–Ω—Ç</p>
        <input type="number" id="dicePercent" min="1" max="99" value="50" class="input-field" />
        <div class="quick-bet-buttons">
          <button class="btn-secondary quick-btn" data-action="percent-double">–£–¥–≤–æ–∏—Ç—å</button>
          <button class="btn-secondary quick-btn" data-action="percent-half">–ü–æ–ª–æ–≤–∏–Ω–∞</button>
          <button class="btn-secondary quick-btn" data-action="percent-max">–ú–∞–∫—Å</button>
          <button class="btn-secondary quick-btn" data-action="percent-min">–ú–∏–Ω</button>
        </div>
      </div>

      <div>
        <p class="muted">–ú–Ω–æ–∂–∏—Ç–µ–ª—å</p>
        <h2 id="diceMultiplier">2.00x</h2>
        <p class="stat-subtext">–í–æ–∑–º–æ–∂–Ω—ã–π –≤—ã–∏–≥—Ä—ã—à: <span id="dicePayout">0</span> üç¨</p>
      </div>

      <div>
        <p class="muted">–î–∏–∞–ø–∞–∑–æ–Ω</p>
        <div class="range-display" id="diceRange">0 - 499999</div>
        <div class="range-display" id="diceRange2" style="display:none;">500000 - 999999</div>
      </div>

      <div class="option-toggle">
        <button class="btn-secondary option-btn active" id="diceLessBtn" data-side="less">–ú–µ–Ω—å—à–µ</button>
        <button class="btn-secondary option-btn" id="diceMoreBtn" data-side="more">–ë–æ–ª—å—à–µ</button>
      </div>

      <button id="diceRollBtn" class="btn-primary" style="margin-top: 12px;">–ò–≥—Ä–∞—Ç—å</button>
      <p id="diceStatus" class="message"></p>
    </section>

    <section class="glass-card history-card">
      <p class="eyebrow">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –±—Ä–æ—Å–∫–∏</p>
      <div id="diceHistoryList" class="history-list"></div>
    </section>
  </div>

  <script>
    const BASE_URL = 'https://fen4yaragithubio-production.up.railway.app';
    let user = null;
    let selectedSide = 'less';
    let lastBet = 0;

    const balanceEl = document.getElementById('diceBalance');
    const betInput = document.getElementById('diceBet');
    const percentInput = document.getElementById('dicePercent');
    const multiplierEl = document.getElementById('diceMultiplier');
    const payoutEl = document.getElementById('dicePayout');
    const rangeEl = document.getElementById('diceRange');
    const rangeEl2 = document.getElementById('diceRange2');
    const statusEl = document.getElementById('diceStatus');
    const historyList = document.getElementById('diceHistoryList');
    const rollBtn = document.getElementById('diceRollBtn');
    const lessBtn = document.getElementById('diceLessBtn');
    const moreBtn = document.getElementById('diceMoreBtn');
    const quickBtns = document.querySelectorAll('.quick-btn');

    function updateMultiplier() {
      const percent = Number(percentInput.value) || 50;
      const multiplier = (100 / percent).toFixed(2);
      multiplierEl.textContent = `${multiplier}x`;
      
      const bet = Number(betInput.value) || 0;
      if (bet > 0) {
        const payout = Math.floor(bet * multiplier);
        payoutEl.textContent = payout;
      } else {
        payoutEl.textContent = '0';
      }

      // –ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω–µ
      let threshold;
      if (selectedSide === 'less') {
        // –î–ª—è "–º–µ–Ω—å—à–µ": –ø—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ "–º–µ–Ω—å—à–µ"
        threshold = Math.floor((percent / 100) * 1000000);
        rangeEl.textContent = `0 - ${threshold - 1}`;
        rangeEl2.style.display = 'none';
      } else {
        // –î–ª—è "–±–æ–ª—å—à–µ": –ø—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ "–±–æ–ª—å—à–µ", –∑–Ω–∞—á–∏—Ç threshold = (100 - percent)
        threshold = Math.floor(((100 - percent) / 100) * 1000000);
        rangeEl.textContent = `${threshold} - 999999`;
        rangeEl2.style.display = 'none';
      }
    }

    lessBtn.addEventListener('click', () => {
      selectedSide = 'less';
      lessBtn.classList.add('active');
      moreBtn.classList.remove('active');
      updateMultiplier();
    });

    moreBtn.addEventListener('click', () => {
      selectedSide = 'more';
      moreBtn.classList.add('active');
      lessBtn.classList.remove('active');
      updateMultiplier();
    });

    percentInput.addEventListener('input', updateMultiplier);
    betInput.addEventListener('input', updateMultiplier);

    quickBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const action = btn.dataset.action;
        if (action === 'double') {
          betInput.value = (Number(betInput.value) || 0) * 2;
        } else if (action === 'half') {
          betInput.value = Math.floor((Number(betInput.value) || 0) / 2);
        } else if (action === 'max') {
          betInput.value = user ? user.balance : 0;
        } else if (action === 'min') {
          betInput.value = 1;
        } else if (action === 'percent-double') {
          percentInput.value = Math.min(99, (Number(percentInput.value) || 50) * 2);
        } else if (action === 'percent-half') {
          percentInput.value = Math.max(1, Math.floor((Number(percentInput.value) || 50) / 2));
        } else if (action === 'percent-max') {
          percentInput.value = 99;
        } else if (action === 'percent-min') {
          percentInput.value = 1;
        }
        updateMultiplier();
      });
    });

    async function init() {
      try {
        const resp = await fetch(`${BASE_URL}/check-auth`, { credentials: 'include' });
        if (!resp.ok) throw new Error('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
        user = await resp.json();
        balanceEl.textContent = user.balance;
        if (lastBet > 0) {
          betInput.value = lastBet;
          updateMultiplier();
        }
        await loadHistory();
      } catch (err) {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç');
        window.location.href = 'index.html';
      }
    }

    async function rollDice() {
      const bet = Number(betInput.value);
      const percent = Number(percentInput.value);
      
      if (!bet || bet <= 0) {
        statusEl.textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—Ç–∞–≤–∫—É';
        statusEl.className = 'message error';
        return;
      }
      if (percent < 1 || percent > 99) {
        statusEl.textContent = '–ü—Ä–æ—Ü–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 1 –¥–æ 99';
        statusEl.className = 'message error';
        return;
      }

      try {
        rollBtn.disabled = true;
        statusEl.textContent = '';
        const resp = await fetch(`${BASE_URL}/dice/play`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ bet, percent, side: selectedSide })
        });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å—Ç–∞–≤–∫–∏');
        
        user.balance = data.newBalance;
        balanceEl.textContent = data.newBalance;
        lastBet = bet;
        
        statusEl.textContent = data.win
          ? `üéâ –í—ã–ø–∞–ª–æ ${data.roll}. –ü–æ–±–µ–¥–∞! –í—ã–∏–≥—Ä—ã—à: ${data.payout}üç¨`
          : `üôÖ –í—ã–ø–∞–ª–æ ${data.roll}. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë`;
        statusEl.className = `message ${data.win ? 'success' : 'error'}`;
        
        await loadHistory(data.history);
      } catch (err) {
        statusEl.textContent = err.message;
        statusEl.className = 'message error';
      } finally {
        rollBtn.disabled = false;
      }
    }

    async function loadHistory(prefetched) {
      try {
        const data =
          prefetched ||
          (await fetch(`${BASE_URL}/dice/history`, { credentials: 'include' }).then((r) => r.json()));
        renderHistory(Array.isArray(data) ? data : []);
      } catch (err) {
        console.error('dice history error', err);
      }
    }

    function renderHistory(entries) {
      historyList.innerHTML = '';
      if (!entries.length) {
        historyList.innerHTML = '<div class="history-item muted">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';
        return;
      }
      entries.forEach((entry) => {
        const item = document.createElement('div');
        item.className = 'history-item';
        if (user && entry.username === user.username) {
          item.classList.add('highlight');
        }
        const date = new Date(entry.timestamp).toLocaleTimeString('ru-RU');
        const outcome = entry.win ? '‚Üí –ü–æ–±–µ–¥–∞' : '‚Üí –ü–æ—Ä–∞–∂–µ–Ω–∏–µ';
        const sideText = entry.side === 'less' ? '–ú–µ–Ω—å—à–µ' : '–ë–æ–ª—å—à–µ';
        item.innerHTML = `<strong>${date}</strong> ‚Äî ${entry.username}: ${sideText} ${entry.percent}%, –≤—ã–ø–∞–ª–æ ${entry.roll} ${outcome} (${entry.bet}üç¨)`;
        historyList.appendChild(item);
      });
    }

    rollBtn.addEventListener('click', rollDice);
    init();
  </script>
</body>
</html>
