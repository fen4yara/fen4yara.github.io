<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üé° –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –†—É–ª–µ—Ç–∫–∞</title>
  <style>
    /* --- –°–∞–º–∞ –æ–±—ë—Ä—Ç–∫–∞ –∫–æ–ª–µ—Å–∞ (–∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π –∫–≤–∞–¥—Ä–∞—Ç) --- */
    .wheel {
      width: 90vw;              /* –∑–∞–Ω–∏–º–∞–µ—Ç –¥–æ 90% —à–∏—Ä–∏–Ω—ã —ç–∫—Ä–∞–Ω–∞ */
      max-width: 400px;         /* –Ω–æ –Ω–µ –±–æ–ª—å—à–µ 400px */
      aspect-ratio: 1 / 1;      /* –≤—Å–µ–≥–¥–∞ –∫–≤–∞–¥—Ä–∞—Ç */
      margin: 20px auto;
      position: relative;
      border: 10px solid #333;  /* —Ä–∞–º–∫–∞ –∫–æ–ª–µ—Å–∞ */
      border-radius: 50%;
      overflow: hidden;
      box-sizing: border-box;   /* —á—Ç–æ–±—ã —Ä–∞–º–∫–∞ –Ω–µ ¬´–≤—ã–ª–∞–∑–∏–ª–∞¬ª –∑–∞ –ø—Ä–µ–¥–µ–ª—ã */
    }

    /* --- Canvas –≤–Ω—É—Ç—Ä–∏ –∫–æ–ª–µ—Å–∞ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ—Ç—Å—è –Ω–∞ 100% –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ --- */
    .wheel canvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    /* --- –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —Å—Ç—Ä–µ–ª–∫–∞ --- */
    .pointer {
      position: absolute;
      top: -5%;                /* —á—É—Ç—å –≤—ã—Å—Ç—É–ø–∞–µ—Ç –Ω–∞–¥ —Ä–∞–º–∫–æ–π */
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 7% solid transparent;   /* 7% –æ—Ç —à–∏—Ä–∏–Ω—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
      border-right: 7% solid transparent;  /* 7% –æ—Ç —à–∏—Ä–∏–Ω—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
      border-bottom: 12% solid red;        /* 12% –æ—Ç —à–∏—Ä–∏–Ω—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
      /* —Ç–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º —Å—Ç—Ä–µ–ª–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å .wheel */
      z-index: 10;            /* –ø–æ–≤–µ—Ä—Ö —Ö–æ–ª—Å—Ç–∞ */
    }

    /* --- –ë–ª–æ–∫ —Å –æ–±—Ä–∞—Ç–Ω—ã–º –æ—Ç—Å—á—ë—Ç–æ–º –∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ --- */
    #message {
      font-weight: bold;
      margin-top: 10px;
      color: #333;
      text-align: center;
    }
    #countdown {
      font-size: 1rem;
      color: #555;
      text-align: center;
      margin-top: 5px;
    }
    #countdown-text {
      display: inline;
    }
    #timer {
      font-weight: bold;
      display: inline;
      margin-left: 5px;
    }

    /* --- –õ–µ–≥–µ–Ω–¥–∞ --- */
    #legend {
      max-width: 400px;
      margin: 10px auto;
      font-size: 0.9rem;
      text-align: left;
    }
    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
    }
    .legend-color {
      width: 16px;
      height: 16px;
      border: 1px solid #000;
      margin-right: 8px;
    }
  </style>
</head>
<body>
  <main>
    <h1>üé° –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –†—É–ª–µ—Ç–∫–∞</h1>
    <p>–ë–∞–ª–∞–Ω—Å: <span id="balance">...</span> üç¨</p>

    <div>
      <label for="bet">–°—Ç–∞–≤–∫–∞:</label>
      <input type="number" id="bet" min="1" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—Ç–∞–≤–∫—É" />
      <button id="joinBtn">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
    </div>
    <div id="countdown">
      <span id="countdown-text">–û–∂–∏–¥–∞–Ω–∏–µ –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞‚Ä¶</span>
      <span id="timer"></span>
    </div>

    <div class="wheel" id="wheel-container">
      <canvas id="canvas"></canvas>
      <div class="pointer"></div>
    </div>

    <div id="legend"></div>
    <p id="message"></p>
    <button onclick="window.location.href='mainPage.html'">‚¨ÖÔ∏è –ù–∞–∑–∞–¥</button>
  </main>

  <script>
    const BASE_URL = 'https://fen4yaragithubio-production-9286.up.railway.app';

    let user = null;
    let players = [];
    let isAnimating = false;
    let nextSpinTimestamp = null;
    let countdownInterval = null;

    const balanceEl = document.getElementById('balance');
    const messageEl = document.getElementById('message');
    const joinBtn = document.getElementById('joinBtn');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const countdownTextEl = document.getElementById('countdown-text');
    const timerEl = document.getElementById('timer');
    const legendEl = document.getElementById('legend');
    const wheelContainer = document.getElementById('wheel-container');

    // –ü–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è ease-out
    function easeOut(t) {
      return 1 - Math.pow(1 - t, 3);
    }

    function showMessage(msg, color = '#333') {
      messageEl.textContent = msg;
      messageEl.style.color = color;
    }

    // –ü–µ—Ä–µ–¥ —Ä–∏—Å–æ–≤–∞–Ω–∏–µ–º –∫–æ–ª–µ—Å–∞ –º—ã –¥–æ–ª–∂–Ω—ã –≤—Å–µ–≥–¥–∞ –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ canvas
    function resizeCanvasToContainer() {
      const rect = wheelContainer.getBoundingClientRect();
      canvas.width = rect.width;
      canvas.height = rect.height;
      // –ï—Å–ª–∏ —Å–µ–π—á–∞—Å –Ω–µ—Ç –∞–Ω–∏–º–∞—Ü–∏–∏, –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ä–∏—Å—É–µ–º ¬´–æ–∂–∏–¥–∞—é—â–µ–µ¬ª —Å–æ—Å—Ç–æ—è–Ω–∏–µ:
      if (!isAnimating) {
        drawWheelByList(players);
      }
    }

    window.addEventListener('resize', () => {
      resizeCanvasToContainer();
    });

    // 1) –†–∏—Å—É–µ–º –∫–æ–ª–µ—Å–æ –ø–æ —Å–ø–∏—Å–∫—É list
    function drawWheelByList(list) {
      const width = canvas.width;
      const height = canvas.height;
      ctx.clearRect(0, 0, width, height);
      if (list.length === 0) return;

      const totalBet = list.reduce((s, p) => s + p.bet, 0);
      let startAngle = 0;
      list.forEach(p => {
        const slice = (p.bet / totalBet) * 2 * Math.PI;
        ctx.beginPath();
        ctx.moveTo(width / 2, height / 2);
        ctx.arc(width / 2, height / 2, width / 2, startAngle, startAngle + slice);
        ctx.fillStyle = p.color;
        ctx.fill();
        startAngle += slice;
      });
      renderLegend(list);
    }

    // 2) –†–∏—Å—É–µ–º –ª–µ–≥–µ–Ω–¥—É
    function renderLegend(list) {
      legendEl.innerHTML = '';
      list.forEach(p => {
        const item = document.createElement('div');
        item.className = 'legend-item';
        const colorBox = document.createElement('div');
        colorBox.className = 'legend-color';
        colorBox.style.backgroundColor = p.color;
        const text = document.createElement('div');
        text.textContent = `${p.username}: ${p.bet} üç¨`;
        item.appendChild(colorBox);
        item.appendChild(text);
        legendEl.appendChild(item);
      });
    }

    // 3) –ü–æ–ª—É—á–∞–µ–º –∏–≥—Ä–æ–∫–æ–≤ + nextSpin + serverTime (–∫–∞–∂–¥—ã–µ 500 –º—Å)
    async function fetchPlayersAndDraw() {
      try {
        const resp = await fetch(`${BASE_URL}/roulette/players`, { credentials: 'include' });
        if (!resp.ok) {
          if (resp.status === 401) throw new Error('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
          else throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–≥—Ä–æ–∫–æ–≤');
        }
        const data = await resp.json();
        players = data.players;
        drawWheelByList(players);

        if (data.nextSpin !== null) {
          const offset = Date.now() - data.serverTime;
          const localNext = data.nextSpin + offset;
          if (localNext !== nextSpinTimestamp) {
            nextSpinTimestamp = localNext;
            startCountdown();
          }
        } else if (nextSpinTimestamp !== null) {
          nextSpinTimestamp = null;
          startCountdown();
        }
      } catch (err) {
        console.error('fetchPlayersAndDraw:', err);
      }
    }

    // 4) –ü–æ-–ø—Ä–µ–∂–Ω–µ–º—É –º–æ–∂–µ–º –æ–ø—Ä–∞—à–∏–≤–∞—Ç—å /next-spin (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
    async function fetchNextSpin() {
      try {
        const resp = await fetch(`${BASE_URL}/roulette/next-spin`, { credentials: 'include' });
        if (!resp.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å next-spin');
        const data = await resp.json();
        if (data.nextSpin !== null) {
          const offset = Date.now() - data.serverTime;
          const localNext = data.nextSpin + offset;
          if (localNext !== nextSpinTimestamp) {
            nextSpinTimestamp = localNext;
            startCountdown();
          }
        } else if (nextSpinTimestamp !== null) {
          nextSpinTimestamp = null;
          startCountdown();
        }
      } catch (err) {
        console.error('fetchNextSpin:', err);
      }
    }

    // 5) –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á—ë—Ç, –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –Ω—É–ª—è ‚Äî –≤—ã–∑—ã–≤–∞–µ–º animateSpin()
    function startCountdown() {
      if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
      }

      if (nextSpinTimestamp === null) {
        countdownTextEl.textContent = '–û–∂–∏–¥–∞–Ω–∏–µ –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞‚Ä¶';
        timerEl.textContent = '';
        return;
      }

      countdownTextEl.textContent = '–î–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–ø–∏–Ω–∞:';
      function updateTimer() {
        const now = Date.now();
        let remainingMs = nextSpinTimestamp - now;
        let secondsLeft = remainingMs > 0 ? Math.ceil(remainingMs / 1000) : 0;
        timerEl.textContent = secondsLeft + ' —Å';

        if (now >= nextSpinTimestamp) {
          clearInterval(countdownInterval);
          countdownInterval = null;
          animateSpin();
        }
      }
      updateTimer();
      countdownInterval = setInterval(updateTimer, 200);
    }

    // 6) –ê–Ω–∏–º–∞—Ü–∏—è —Å–ø–∏–Ω–∞
    async function animateSpin() {
      if (isAnimating) return;
      isAnimating = true;

      let resultData;
      try {
        const r = await fetch(`${BASE_URL}/roulette/result`, { credentials: 'include' });
        if (!r.ok) {
          console.warn('–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø–æ–ø—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ 500 –º—Å');
          isAnimating = false;
          setTimeout(animateSpin, 500);
          return;
        }
        resultData = await r.json();
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ /roulette/result:', err);
        isAnimating = false;
        setTimeout(animateSpin, 1000);
        return;
      }

      const spinPlayers = resultData.players;
      const winnerUsername = resultData.winner;
      const totalPot = resultData.totalBet;
      if (!spinPlayers || spinPlayers.length < 2) {
        showMessage('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–≥—Ä–æ–∫–æ–≤ –¥–ª—è —Å–ø–∏–Ω–∞.', 'orange');
        isAnimating = false;
        return;
      }

      showMessage('–ö—Ä—É—Ç–∏–º‚Ä¶');

      const slices = computeSlices(spinPlayers);
      let targetSlice = slices.find(s => s.username === winnerUsername);
      if (!targetSlice) targetSlice = slices[0];

      const midAngle = targetSlice.startAngle + (targetSlice.endAngle - targetSlice.startAngle) / 2;
      const extraRotations = 4 * 2 * Math.PI;
      const currentRotation = 0;
      const finalRotation = extraRotations + (3 * Math.PI / 2) - midAngle;

      const spinDuration = 3000;
      const startTime = performance.now();

      function frame(now) {
        const elapsed = now - startTime;
        const t = Math.min(elapsed / spinDuration, 1);
        const eased = easeOut(t);
        const currentAngle = currentRotation + (finalRotation - currentRotation) * eased;

        ctx.save();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.translate(canvas.width / 2, canvas.height / 2);
        ctx.rotate(currentAngle);
        ctx.translate(-canvas.width / 2, -canvas.height / 2);
        drawWheelByList(spinPlayers);
        ctx.restore();

        if (t < 1) {
          requestAnimationFrame(frame);
        } else {
          showMessage(`üéâ –ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ${winnerUsername}! –í—ã–∏–≥—Ä—ã—à: ${totalPot} üç¨`, 'green');
          fetch(`${BASE_URL}/check-auth`, { credentials: 'include' })
            .then(r2 => {
              if (!r2.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å');
              return r2.json();
            })
            .then(userData => {
              user.balance = userData.balance;
              balanceEl.textContent = user.balance;
            })
            .catch(err => console.error(err))
            .finally(() => {
              isAnimating = false;
            });
        }
      }

      requestAnimationFrame(frame);
    }

    function computeSlices(list) {
      const totalBet = list.reduce((s, p) => s + p.bet, 0);
      let acc = 0;
      return list.map(p => {
        const slice = {
          username: p.username,
          color: p.color,
          bet: p.bet,
          startAngle: acc,
          endAngle: acc + (p.bet / totalBet) * 2 * Math.PI
        };
        acc = slice.endAngle;
        return slice;
      });
    }

    // 7) –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã:
    window.addEventListener('DOMContentLoaded', async () => {
      try {
        // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
        const resp = await fetch(`${BASE_URL}/check-auth`, { credentials: 'include' });
        if (!resp.ok) throw new Error('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
        user = await resp.json();
        balanceEl.textContent = user.balance;

        // –ü–æ–¥–≥–æ–Ω—è–µ–º canvas –ø–æ–¥ —Ç–µ–∫—É—â–∏–π —Ä–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        resizeCanvasToContainer();

        // –ó–∞–ø—É—Å–∫–∞–µ–º –±—ã—Å—Ç—Ä—ã–π –æ–ø—Ä–æ—Å (500 –º—Å) –∏–≥—Ä–æ–∫–æ–≤ –∏ nextSpin
        await fetchPlayersAndDraw();
        setInterval(fetchPlayersAndDraw, 500);
        setInterval(fetchNextSpin, 500);
      } catch (err) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ.');
        window.location.href = 'index.html';
      }
    });

    // 8) –û–±—Ä–∞–±–æ—Ç—á–∏–∫ ¬´–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è¬ª
    joinBtn.addEventListener('click', async () => {
      const betValue = parseInt(document.getElementById('bet').value);
      if (!betValue || betValue <= 0) {
        showMessage('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Ç–∞–≤–∫–∞!', 'red');
        return;
      }
      if (betValue > user.balance) {
        showMessage('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!', 'red');
        return;
      }
      try {
        const resp = await fetch(`${BASE_URL}/roulette/join`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ bet: betValue })
        });
        const data = await resp.json();
        if (!resp.ok) {
          throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ join');
        }

        players = data.players;
        drawWheelByList(players);

        const check = await fetch(`${BASE_URL}/check-auth`, { credentials: 'include' });
        if (check.ok) {
          const upd = await check.json();
          user.balance = upd.balance;
          balanceEl.textContent = user.balance;
        }
        showMessage('–í—ã –≤ –∏–≥—Ä–µ. –ñ–¥—ë–º —Å–ø–∏–Ω–∞...', '#333');

        if (data.nextSpin !== null) {
          const offset = Date.now() - data.serverTime;
          nextSpinTimestamp = data.nextSpin + offset;
        } else {
          nextSpinTimestamp = null;
        }
        startCountdown();
      } catch (err) {
        showMessage(err.message, 'red');
      }
    });
  </script>
</body>
</html>
