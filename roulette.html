<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üé° –†—É–ª–µ—Ç–∫–∞</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .wheel {
      width: 300px;
      height: 300px;
      border-radius: 50%;
      border: 10px solid #333;
      margin: 20px auto;
      position: relative;
      overflow: hidden;
    }
    .wheel canvas {
      width: 100%;
      height: 100%;
      display: block;
    }
    .pointer {
      position: absolute;
      top: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 20px solid transparent;
      border-right: 20px solid transparent;
      border-bottom: 30px solid red;
    }
    #message {
      font-weight: bold;
      margin-top: 10px;
      color: #333;
      text-align: center;
    }
    #countdown {
      font-size: 1rem;
      color: #555;
      text-align: center;
      margin-top: 5px;
    }
    #legend {
      max-width: 300px;
      margin: 10px auto;
      font-size: 0.9rem;
    }
    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
    }
    .legend-color {
      width: 16px;
      height: 16px;
      border: 1px solid #000;
      margin-right: 8px;
    }
  </style>
</head>
<body>
  <main>
    <h1>üé° –†—É–ª–µ—Ç–∫–∞</h1>
    <p>–ë–∞–ª–∞–Ω—Å: <span id="balance">...</span> üç¨</p>

    <div>
      <label for="bet">–°—Ç–∞–≤–∫–∞:</label>
      <input type="number" id="bet" min="1" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—Ç–∞–≤–∫—É" />
      <button id="joinBtn">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
    </div>
    <div id="countdown">–î–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–ø–∏–Ω–∞: <span id="timer">‚Äî</span> —Å–µ–∫</div>

    <div class="wheel">
      <canvas id="canvas" width="300" height="300"></canvas>
      <div class="pointer"></div>
    </div>

    <!-- –õ–µ–≥–µ–Ω–¥–∞: –∫–∞–∫–æ–π –∏–≥—Ä–æ–∫ –∫–∞–∫–æ–≥–æ —Ü–≤–µ—Ç–∞ -->
    <div id="legend"></div>

    <p id="message"></p>
    <button onclick="window.location.href='mainPage.html'">‚¨ÖÔ∏è –ù–∞–∑–∞–¥</button>
  </main>

 <script>
  const BASE_URL = 'https://fen4yaragithubio-production-9286.up.railway.app';

  let user = null;
  let players = [];           // –¢–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤
  let spinPlayers = [];       // –°–Ω–∏–º–æ–∫ –æ—á–µ—Ä–µ–¥–∏ –ø—Ä–∏ –∞–Ω–∏–º–∞—Ü–∏–∏
  let isAnimating = false;    // –§–ª–∞–≥ ¬´–∏–¥—ë—Ç –∞–Ω–∏–º–∞—Ü–∏—è¬ª
  let nextSpinTimestamp = null;
  let countdownIntervalId = null;

  const balanceEl = document.getElementById('balance');
  const messageEl = document.getElementById('message');
  const joinBtn = document.getElementById('joinBtn');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const timerEl = document.getElementById('timer');
  const countdownContainer = document.getElementById('countdown');
  const legendEl = document.getElementById('legend');

  function easeOut(t) {
    return 1 - Math.pow(1 - t, 3);
  }

  function showMessage(msg, color = '#333') {
    messageEl.textContent = msg;
    messageEl.style.color = color;
  }

  function drawWheelByList(list) {
    ctx.clearRect(0, 0, 300, 300);
    if (list.length === 0) return;
    const totalBet = list.reduce((s, p) => s + p.bet, 0);
    let startAngle = 0;
    list.forEach(p => {
      const angle = (p.bet / totalBet) * 2 * Math.PI;
      ctx.beginPath();
      ctx.moveTo(150, 150);
      ctx.arc(150, 150, 150, startAngle, startAngle + angle);
      ctx.fillStyle = p.color;
      ctx.fill();
      startAngle += angle;
    });
    renderLegend(list);
  }

  function renderLegend(list) {
    legendEl.innerHTML = '';
    list.forEach(p => {
      const item = document.createElement('div');
      item.className = 'legend-item';
      const colorBox = document.createElement('div');
      colorBox.className = 'legend-color';
      colorBox.style.backgroundColor = p.color;
      const text = document.createElement('div');
      text.textContent = `${p.username}: ${p.bet} üç¨`;
      item.appendChild(colorBox);
      item.appendChild(text);
      legendEl.appendChild(item);
    });
  }

  // 3) –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ –∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∫–æ–ª–µ—Å–æ, –µ—Å–ª–∏ –Ω–µ—Ç –∞–Ω–∏–º–∞—Ü–∏–∏
  async function fetchPlayersAndDraw() {
    try {
      const resp = await fetch(`${BASE_URL}/roulette/players`, { credentials: 'include' });
      if (!resp.ok) {
        if (resp.status === 401) throw new Error('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
        else throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–≥—Ä–æ–∫–æ–≤');
      }
      const data = await resp.json();
      players = data.players;
      if (!isAnimating) {
        drawWheelByList(players);
      }
    } catch (err) {
      console.error('fetchPlayersAndDraw:', err);
    }
  }

  // 4) –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —É —Å–µ—Ä–≤–µ—Ä–∞ nextSpin. –ï—Å–ª–∏ –≤–µ—Ä–Ω—É–ª–æ—Å—å null, –∑–Ω–∞—á–∏—Ç –∂–¥—ë–º –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞
  async function fetchNextSpin() {
    try {
      const resp = await fetch(`${BASE_URL}/roulette/next-spin`, { credentials: 'include' });
      if (!resp.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å next-spin');
      const data = await resp.json();
      // data.nextSpin –º–æ–∂–µ—Ç –±—ã—Ç—å null (–µ—Å–ª–∏ <2 –∏–≥—Ä–æ–∫–æ–≤) –∏–ª–∏ —á–∏—Å–ª–æ (–≤—Ä–µ–º—è –≤ ms)
      nextSpinTimestamp = data.nextSpin;

      // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª —Ç–∞–π–º–µ—Ä–∞, –µ—Å–ª–∏ –æ–Ω –±—ã–ª
      if (countdownIntervalId) {
        clearInterval(countdownIntervalId);
        countdownIntervalId = null;
      }

      if (nextSpinTimestamp) {
        // –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏—Å–ª–∞–ª –≤–∞–ª–∏–¥–Ω–æ–µ –≤—Ä–µ–º—è
        startCountdown();
      } else {
        // –ü–æ–∫–∞ –Ω–µ—Ç —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–ø–∏–Ω–∞ (–º–µ–Ω—å—à–µ 2 –∏–≥—Ä–æ–∫–æ–≤) ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫—É
        timerEl.textContent = '‚Äî';
        countdownContainer.textContent = '–û–∂–∏–¥–∞–Ω–∏–µ –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞‚Ä¶';
      }
    } catch (err) {
      console.error('fetchNextSpin:', err);
    }
  }

  // 5) –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–Ω–∏–º–∞—Ü–∏–∏
  function scheduleSpinAnimation() {
    if (isAnimating || !nextSpinTimestamp) return;
    const now = Date.now();
    const delay = nextSpinTimestamp - now;
    if (delay <= 0) {
      // –£–∂–µ –ø–æ—Ä–∞ –∫—Ä—É—Ç–∏—Ç—å
      animateSpin();
    } else {
      setTimeout(animateSpin, delay);
    }
  }

  // 6) –ê–Ω–∏–º–∞—Ü–∏—è —Å–ø–∏–Ω–∞ –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
  function animateSpin() {
    if (isAnimating) return;

    spinPlayers = players.slice();

    // –ï—Å–ª–∏ –º–µ–Ω—å—à–µ 2 –∏–≥—Ä–æ–∫–æ–≤ ‚Äî –Ω–µ –∞–Ω–∏–º–∏—Ä—É–µ–º, –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º nextSpin
    if (spinPlayers.length < 2) {
      showMessage('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–≥—Ä–æ–∫–æ–≤ –¥–ª—è —Å–ø–∏–Ω–∞.', 'orange');
      isAnimating = false;
      nextSpinTimestamp = null;
      fetchNextSpin();
      return;
    }

    isAnimating = true;
    showMessage('–ö—Ä—É—Ç–∏–º...');

    let angleOffset = 0;
    const spinTime = 3000;
    const startTime = performance.now();

    function frame(now) {
      const progress = now - startTime;
      const frac = Math.min(progress / spinTime, 1);
      const rotate = easeOut(frac) * 10 * Math.PI;

      ctx.save();
      ctx.clearRect(0, 0, 300, 300);
      ctx.translate(150, 150);
      ctx.rotate(rotate + angleOffset);
      ctx.translate(-150, -150);
      drawWheelByList(spinPlayers);
      ctx.restore();

      if (progress < spinTime) {
        requestAnimationFrame(frame);
      } else {
        angleOffset += rotate;
        // –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ ‚Äî –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        fetch(`${BASE_URL}/roulette/result`, { credentials: 'include' })
          .then(r => {
            if (!r.ok) throw new Error('–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞');
            return r.json();
          })
          .then(resData => {
            showMessage(`üéâ –ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ${resData.winner}!`, 'green');
            // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å
            return fetch(`${BASE_URL}/check-auth`, { credentials: 'include' });
          })
          .then(r2 => {
            if (r2.ok) return r2.json();
            throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å');
          })
          .then(userData => {
            user.balance = userData.balance;
            balanceEl.textContent = user.balance;
          })
          .catch(err => {
            console.error(err);
          })
          .finally(() => {
            // –ü–æ—Å–ª–µ —Å–ø–∏–Ω–∞: –æ—á–∏—â–∞–µ–º –æ—á–µ—Ä–µ–¥—å players, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –Ω–æ–≤—ã–π nextSpin
            players = [];
            isAnimating = false;
            nextSpinTimestamp = null;
            fetchNextSpin();
          });
      }
    }

    requestAnimationFrame(frame);
  }

  // 7) –û–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á—ë—Ç –¥–æ nextSpinTimestamp
  function startCountdown() {
    function updateTimer() {
      const now = Date.now();
      let diff = Math.floor((nextSpinTimestamp - now) / 1000);
      if (diff < 0) diff = 0;
      timerEl.textContent = diff;
      // –ï—Å–ª–∏ —Ç–∞–π–º–µ—Ä –¥–æ—à—ë–ª –¥–æ –Ω—É–ª—è, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –∑–∞–ø—É—Å–∫ –∞–Ω–∏–º–∞—Ü–∏–∏
      if (now >= nextSpinTimestamp) {
        clearInterval(countdownIntervalId);
        scheduleSpinAnimation();
      }
    }
    // –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ä–∞–∑—É
    updateTimer();
    countdownIntervalId = setInterval(updateTimer, 500);
  }

  // 8) –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã‚Ä¶
  window.addEventListener('DOMContentLoaded', async () => {
    try {
      const resp = await fetch(`${BASE_URL}/check-auth`, { credentials: 'include' });
      if (!resp.ok) throw new Error('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
      user = await resp.json();
      balanceEl.textContent = user.balance;

      await fetchPlayersAndDraw();
      setInterval(fetchPlayersAndDraw, 2000);
      await fetchNextSpin();
    } catch (err) {
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ.');
      window.location.href = 'index.html';
    }
  });

  // 9) –ù–∞–∂–∞—Ç–∏–µ ¬´–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è¬ª
  joinBtn.addEventListener('click', async () => {
    const betValue = parseInt(document.getElementById('bet').value);
    if (!betValue || betValue <= 0) {
      showMessage('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Ç–∞–≤–∫–∞!', 'red');
      return;
    }
    if (betValue > user.balance) {
      showMessage('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!', 'red');
      return;
    }
    try {
      const resp = await fetch(`${BASE_URL}/roulette/join`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ bet: betValue })
      });
      const data = await resp.json();
      if (!resp.ok) {
        throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ join');
      }
      players = data.players;
      drawWheelByList(players);

      // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å
      const check = await fetch(`${BASE_URL}/check-auth`, { credentials: 'include' });
      if (check.ok) {
        const upd = await check.json();
        user.balance = upd.balance;
        balanceEl.textContent = user.balance;
      }
      showMessage('–í—ã –≤ –∏–≥—Ä–µ. –ñ–¥—ë–º —Å–ø–∏–Ω–∞...', '#333');

      // –ö–æ–≥–¥–∞ –∫—Ç–æ-—Ç–æ –∑–∞—Ö–æ–¥–∏—Ç, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∑–∞–Ω–æ–≤–æ nextSpin,
      // —á—Ç–æ–±—ã –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Ç–∞–π–º–µ—Ä, –µ—Å–ª–∏ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –≤–æ –≤—Ç–æ—Ä–æ–π –≤–æ—à–ª–∏
      await fetchNextSpin();
    } catch (err) {
      showMessage(err.message, 'red');
    }
  });
</script>

</body>
</html>
